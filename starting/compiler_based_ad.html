


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Stages of Compiler-based Automatic Differentiation &mdash; Enzyme Sphinx Theme 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Installation Instructions" href="installation.html" />
    <link rel="prev" title="Introduction to Automatic Differentiation" href="ad_intro_using_enzyme.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Languages
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://enzyme.mit.edu/docs/stable/index.html">
                  <span class="dropdown-title">Julia</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="">
                  <span class="dropdown-title">Rust</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://enzyme.mit.edu/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about Enzyme’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community</span>
                  <p>Join the Enzyme developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Developer documentation, templates and tools </p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss Enzyme code, issues, install.</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="enzyme-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="enzyme-left-menu" id="enzyme-left-menu">
      <div class="enzyme-side-scroll">
        <div class="enzyme-menu enzyme-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="enzyme-left-menu-search">
            

            
              
              
                <div class="version">
                  0.0.1
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ad_intro_using_enzyme.html">Introduction to Automatic Differentiation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Stages of Compiler-based Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_source_ad.html">AD of Multi-Source Programs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/cpp/">C/C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/fortran/">Fortran</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/julia/">Julia</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/rust/">Rust</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/swift/">Swift</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../calling_convention.html">Calling Convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting_and_tips.html">Troubleshooting and Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Applications and Code Examples of Enzyme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talks_and_tutorials.html">Talks and Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced_options.html">Advanced options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/cuda_guide.html">CUDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/mpi_guide.html">MPI-Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/openmp_guide.html">OpenMP Directives and Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/rocm_guide.html">ROCm</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/library_root.html">Library API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="enzyme-container">
      <div class="enzyme-page-level-bar" id="enzyme-page-level-bar">
        <div class="enzyme-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="enzyme-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>The Stages of Compiler-based Automatic Differentiation</li>
    
    
      <li class="enzyme-breadcrumbs-aside">
        
            
            <a href="../_sources/starting/compiler_based_ad.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="enzyme-shortcuts-wrapper" id="enzyme-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="enzyme-content-wrap" class="enzyme-content-wrap">
        <div class="enzyme-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="enzyme-article" class="enzyme-article">
              
  <section id="the-stages-of-compiler-based-automatic-differentiation">
<span id="compiler-based-automatic-differentiation"></span><h1>The Stages of Compiler-based Automatic Differentiation<a class="headerlink" href="#the-stages-of-compiler-based-automatic-differentiation" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will present an overview of how reverse-mode compiler-based automatic
differentiation with Enzyme works, how the different stages of compilation are
altered under Enzyme’s usage, and how Enzyme plugs into the compiler’s infrastructure.</p>
<section id="ad-as-a-compilation-step">
<span id="id1"></span><h2>AD as a Compilation Step<a class="headerlink" href="#ad-as-a-compilation-step" title="Permalink to this headline">¶</a></h2>
<p>Using Enzyme, we are able to directly plug into the compiler. Taking <code class="docutils literal notranslate"><span class="pre">C</span></code> as an example,
we directly plug into <code class="docutils literal notranslate"><span class="pre">clang</span></code> to perform AD as part of the compilation steps, but on the
higher level to the user, as a part of the single compilation step. Taking a simple
test-program computing the derivative of <span class="math notranslate nohighlight">\(f(x)=x^{2}\)</span>, we begin by defining our
simple C-test we seek to differentiate.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// test.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">__enzyme_autodiff</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">);</span><span class="w"></span>
<span class="kt">double</span><span class="w"> </span><span class="nf">square</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">double</span><span class="w"> </span><span class="nf">dsquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This returns the derivative of square or 2 * x</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__enzyme_autodiff</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">square</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;square(%f)=%f, dsquare(%f)=%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">square</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dsquare</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To now use Enzyme to differentiate our test function, in the process of which it
replaces any calls to functions whose name contain <code class="docutils literal notranslate"><span class="pre">__enzyme_autodiff</span></code> with calls
to the corresponding derivatives of the language primitives used by the
to-be-differentiated function, we have to call <code class="docutils literal notranslate"><span class="pre">clang</span></code> and plug Enzyme into the
compiler. Note that <code class="docutils literal notranslate"><span class="pre">clang</span></code> should be the path to whatever clang you built Enzyme
against in <a href="#id4"><span class="problematic" id="id5">installation_guide_</span></a>. For now, let’s ignore the details of Enzyme’s calling
convention/ABI which are described in detail in <a href="#id6"><span class="problematic" id="id7">calling_convention_</span></a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>clang test.c -O2 -Xclang -load -Xclang /path/to/Enzyme/enzyme/build/Enzyme/ClangEnzyme-&lt;VERSION&gt;.so -fno-vectorize -fno-slp-vectorize -fno-unroll-loops -o first_grad.exe
</pre></div>
</div>
<p>But what does Enzyme actually do here, and at which stages does it alter the compilation?</p>
<section id="generating-llvm">
<span id="id2"></span><h3>Generating LLVM<a class="headerlink" href="#generating-llvm" title="Permalink to this headline">¶</a></h3>
<p>To break Enzyme’s individual steps down, we first need to begin by generating the
LLVM IR from our test snippet. We can generate LLVM from this code by calling clang as follows.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>clang test.c -S -emit-llvm -o input.ll -O2 -fno-vectorize -fno-slp-vectorize -fno-unroll-loops
</pre></div>
</div>
<p>The arguments <code class="docutils literal notranslate"><span class="pre">-S</span> <span class="pre">-emit-llvm</span></code> specify that we want to emit LLVM bitcode, rather than
an executable. The arguments <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">input.ll</span></code> specify that we want the output to be in a
file <code class="docutils literal notranslate"><span class="pre">input.ll</span></code>. The argument <code class="docutils literal notranslate"><span class="pre">-O2</span> <span class="pre">-ffast-math</span></code> runs optimization (with fast-math)
before we run Enzyme’s AD process, which is often beneficial to performance. The
argument <code class="docutils literal notranslate"><span class="pre">-fno-vectorize</span> <span class="pre">-fno-slp-vectorize</span> <span class="pre">-fno-unroll-loops</span></code> specifies that we don’t
want to run vectorization or loop unrolling. In practice, it is better for performance
to only run these scheduling optimizations after AD.</p>
<p>The generated LLVM IR should look something like the following:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; input.ll</span>
<span class="p">...</span><span class="w"></span>
<span class="k">define</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="vg">@square</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%mul</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="nv">%x</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%mul</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">define</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="vg">@dsquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="vg">@__enzyme_autodiff</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)*</span><span class="w"> </span><span class="vg">@square</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i8</span><span class="p">*),</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="vg">#4</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%call</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="performing-ad-with-enzyme">
<span id="id3"></span><h3>Performing AD with Enzyme<a class="headerlink" href="#performing-ad-with-enzyme" title="Permalink to this headline">¶</a></h3>
<p>We can now run Enzyme to differentiate our LLVM IR. The following command will load Enzyme
and run the differentiation transformation pass. Note that <code class="docutils literal notranslate"><span class="pre">opt</span></code> should be the path to
whatever opt was created by the LLVM you built Enzyme against. If you see a segfault when
trying to run opt, this is likely an issue in LLVM’s plugin infrastructure. Please see
<a href="#id8"><span class="problematic" id="id9">installation_guide_</span></a> for more information on how to resolve this.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>opt input.ll -load<span class="o">=</span>/path/to/Enzyme/enzyme/build/Enzyme/LLVMEnzyme-&lt;VERSION&gt;.so -enzyme -o output.ll -S
</pre></div>
</div>
<p>Taking a look at <code class="docutils literal notranslate"><span class="pre">output.ll</span></code>, we find the following:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; output.ll</span>
<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@diffesquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%differeturn</span><span class="p">)</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%&quot;mul&#39;de&quot;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">double</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="m">0.000000e+00</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;mul&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">double</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="m">0.000000e+00</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%invertentry</span><span class="w"></span>

<span class="nl">invertentry:</span><span class="w">                                      </span><span class="c">; preds = %entry</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%differeturn</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;mul&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;mul&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">%m0diffex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="k">fast</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="nv">%x</span><span class="w"></span>
<span class="w">  </span><span class="nv">%m1diffex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="k">fast</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="nv">%x</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="m">0.000000e+00</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;mul&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fadd</span><span class="w"> </span><span class="k">fast</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="nv">%m0diffex</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fadd</span><span class="w"> </span><span class="k">fast</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="nv">%m1diffex</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">*</span><span class="w"> </span><span class="nv">%&quot;x&#39;de&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">insertvalue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">undef</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">define</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="vg">@dsquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@diffesquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="m">1.000000e+00</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">extractvalue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Enzyme has created a new gradient function, and replaced the corresponding call to
<code class="docutils literal notranslate"><span class="pre">__enzyme_autodiff</span></code>. Note that the newly-created gradient function isn’t yet optimized.
Enzyme assumes that various post-processing will occur after creating the gradient.</p>
<p>For example, suppose we run <code class="docutils literal notranslate"><span class="pre">-O2</span></code> after Enzyme as shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>opt output.ll -O2 -o output_opt.ll -S
</pre></div>
</div>
<p>Taking a look at <code class="docutils literal notranslate"><span class="pre">output_opt.ll</span></code>, we see the following:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; output_opt.ll</span>
<span class="k">define</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="vg">@dsquare</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%factor.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">fmul</span><span class="w"> </span><span class="k">fast</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%x</span><span class="p">,</span><span class="w"> </span><span class="m">2.000000e+00</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nv">%factor.i</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The generated gradient has been inlined and entirely simplified to return the input
times two.</p>
<p>We can then compile this into a final binary as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>clang output_opt.ll -o first_grad.exe
</pre></div>
</div>
<p>For ease, we could combine the final optimization, and binary execution into one
command as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>clang output.ll -O3 -o first_grad.exe
</pre></div>
</div>
</section>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="installation.html" class="btn btn-neutral float-right" title="Installation Instructions" accesskey="n" rel="next">Next <img src="../_static/images/chevron-right-blue.svg" class="next-page"></a>
      
      
        <a href="ad_intro_using_enzyme.html" class="btn btn-neutral" title="Introduction to Automatic Differentiation" accesskey="p" rel="prev"><img src="../_static/images/chevron-right-blue.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright Enzyme.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/EnzymeAD/enzyme_sphinx_theme">theme</a> provided by <a href="https://enzyme.mit.edu">Enzyme</a>.
      </div>
      <br>
     

</footer>

          </div>
        </div>

        <div class="enzyme-content-right" id="enzyme-content-right">
          <div class="enzyme-right-menu" id="enzyme-right-menu">
            <div class="enzyme-side-scroll" id="enzyme-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">The Stages of Compiler-based Automatic Differentiation</a><ul>
<li><a class="reference internal" href="#ad-as-a-compilation-step">AD as a Compilation Step</a><ul>
<li><a class="reference internal" href="#generating-llvm">Generating LLVM</a></li>
<li><a class="reference internal" href="#performing-ad-with-enzyme">Performing AD with Enzyme</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
         <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
         <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <footer class="site-footer" id="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://enzyme.mit.edu" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://enzyme.mit.edu">Enzyme</a></li>
            <li><a href="https://enzyme.mit.edu/get-started">Get Started</a></li>
            <li><a href="https://enzyme.mit.edu/features">Features</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Resources</a></li>
            <li><a href="https://enzyme.mit.edu/tutorials">Tutorials</a></li>
            <li><a href="https://enzyme.mit.edu/docs/stable/index.html">Docs</a></li>
            <li><a href="" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/issues" target="_blank">Github Issues</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://groups.google.com/d/forum/enzyme-dev"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <a href="">Ecosystem</a>
          </li>

          <li>
            <a href="">Mobile</a>
          </li>

          <li>
            <a href="">PyTorch Hub</a>
          </li>

          <li>
            <a href="">Blog</a>
          </li>

          <li>
            <a href="https://enzyme.mit.edu/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://enzyme.mit.edu/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="">torchaudio</a>
            </li>

            <li>
              <a href="">torchtext</a>
            </li>

            <li>
              <a href="">torchvision</a>
            </li>

            <li>
              <a href="">TorchElastic</a>
            </li>

            <li>
              <a href="">TorchServe</a>
            </li>

            <li>
              <a href="">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="">Developer Resources</a>
            </li>

            <li>
              <a href="https://enzyme.mit.edu/features">About</a>
            </li>

            <li>
              <a href="">Models (Beta)</a>
            </li>

            <li>
              <a href="">Community</a>
            </li>

            <li>
              <a href="">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      enzymeAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.enzyme-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>