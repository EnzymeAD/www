


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File GradientUtils.cpp &mdash; Enzyme Sphinx Theme 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Languages
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://enzyme.mit.edu/docs/stable/index.html">
                  <span class="dropdown-title">Julia</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="">
                  <span class="dropdown-title">Rust</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://enzyme.mit.edu/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about Enzymeâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community</span>
                  <p>Join the Enzyme developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Developer documentation, templates and tools </p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss Enzyme code, issues, install.</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="enzyme-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="enzyme-left-menu" id="enzyme-left-menu">
      <div class="enzyme-side-scroll">
        <div class="enzyme-menu enzyme-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="enzyme-left-menu-search">
            

            
              
              
                <div class="version">
                  0.0.1
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../starting/ad_intro_using_enzyme.html">Introduction to Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/compiler_based_ad.html">The Stages of Compiler-based Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/installation.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/multi_source_ad.html">AD of Multi-Source Programs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/cpp/">C/C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/fortran/">Fortran</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/julia/">Julia</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/rust/">Rust</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/swift/">Swift</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../calling_convention.html">Calling Convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting_and_tips.html">Troubleshooting and Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Applications and Code Examples of Enzyme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talks_and_tutorials.html">Talks and Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced_options.html">Advanced options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/cuda_guide.html">CUDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/mpi_guide.html">MPI-Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/openmp_guide.html">OpenMP Directives and Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/rocm_guide.html">ROCm</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="enzyme-container">
      <div class="enzyme-page-level-bar" id="enzyme-page-level-bar">
        <div class="enzyme-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="enzyme-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Program Listing for File GradientUtils.cpp</li>
    
    
      <li class="enzyme-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_GradientUtils.cpp.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="enzyme-shortcuts-wrapper" id="enzyme-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="enzyme-content-wrap" class="enzyme-content-wrap">
        <div class="enzyme-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="enzyme-article" class="enzyme-article">
              
  <section id="program-listing-for-file-gradientutils-cpp">
<span id="program-listing-file-gradientutils-cpp"></span><h1>Program Listing for File GradientUtils.cpp<a class="headerlink" href="#program-listing-for-file-gradientutils-cpp" title="Permalink to this headline">Â¶</a></h1>
<p>â†° <a class="reference internal" href="file_GradientUtils.cpp.html#file-gradientutils-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">GradientUtils.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//===- GradientUtils.cpp - Helper class and utilities for AD     ---------===//</span>
<span class="c1">//</span>
<span class="c1">//                             Enzyme Project</span>
<span class="c1">//</span>
<span class="c1">// Part of the Enzyme Project, under the Apache License v2.0 with LLVM</span>
<span class="c1">// Exceptions. See https://llvm.org/LICENSE.txt for license information.</span>
<span class="c1">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span>
<span class="c1">//</span>
<span class="c1">// If using this code in an academic setting, please cite the following:</span>
<span class="c1">// @incollection{enzymeNeurips,</span>
<span class="c1">// title = {Instead of Rewriting Foreign Code for Machine Learning,</span>
<span class="c1">//          Automatically Synthesize Fast Gradients},</span>
<span class="c1">// author = {Moses, William S. and Churavy, Valentin},</span>
<span class="c1">// booktitle = {Advances in Neural Information Processing Systems 33},</span>
<span class="c1">// year = {2020},</span>
<span class="c1">// note = {To appear in},</span>
<span class="c1">// }</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file define two helper classes GradientUtils and subclass</span>
<span class="c1">// DiffeGradientUtils. These classes contain utilities for managing the cache,</span>
<span class="c1">// recomputing statements, and in the case of DiffeGradientUtils, managing</span>
<span class="c1">// adjoint values and shadow pointers.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;llvm/Config/llvm-config.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DifferentialUseAnalysis.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EnzymeLogic.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;FunctionUtils.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GradientUtils.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LibraryFuncs.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TypeAnalysis/TBAA.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/GlobalValue.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/Constants.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Analysis/ValueTracking.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/InstrTypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Support/AMDGPUMetadata.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Transforms/Utils/SimplifyIndVar.h&quot;</span><span class="cp"></span>

<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                  </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">shadowHandlers</span><span class="p">;</span><span class="w"></span>
<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">shadowErasers</span><span class="p">;</span><span class="w"></span>

<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">customCallHandlers</span><span class="p">;</span><span class="w"></span>

<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">customFwdCallHandlers</span><span class="p">;</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeNewCache</span><span class="p">(</span><span class="s">&quot;enzyme-new-cache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Use new cache decision algorithm&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnzymeMinCutCache</span><span class="p">(</span><span class="s">&quot;enzyme-mincut-cache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Use Enzyme Mincut algorithm&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnzymeLoopInvariantCache</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;enzyme-loop-invariant-cache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Attempt to hoist cache outside of loop&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnzymeInactiveDynamic</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;enzyme-inactive-dynamic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Force wholy inactive dynamic loops to have 0 iter reverse pass&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeSharedForward</span><span class="p">(</span><span class="s">&quot;enzyme-shared-forward&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Forward Shared Memory from definitions&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeRegisterReduce</span><span class="p">(</span><span class="s">&quot;enzyme-register-reduce&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Reduce the amount of register reduce&quot;</span><span class="p">));</span><span class="w"></span>
<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeSpeculatePHIs</span><span class="p">(</span><span class="s">&quot;enzyme-speculate-phis&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Speculatively execute phi computations&quot;</span><span class="p">));</span><span class="w"></span>
<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnzymeFreeInternalAllocations</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;enzyme-free-internal-allocations&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Always free internal allocations (disable if allocation needs &quot;</span><span class="w"></span>
<span class="w">             </span><span class="s">&quot;access outside)&quot;</span><span class="p">));</span><span class="w"></span>

<span class="n">llvm</span><span class="o">::</span><span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeRematerialize</span><span class="p">(</span><span class="s">&quot;enzyme-rematerialize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Rematerialize allocations/shadows in the &quot;</span><span class="w"></span>
<span class="w">                                 </span><span class="s">&quot;reverse rather than caching&quot;</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_dbg</span><span class="p">,</span><span class="w"> </span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa_struct</span><span class="p">,</span><span class="w"> </span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_range</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_nonnull</span><span class="p">};</span><span class="w"></span>

<span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::unwrapM</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="o">&amp;</span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UnwrapMode</span><span class="w"> </span><span class="n">unwrapMode</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">scope</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="kt">bool</span><span class="w"> </span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_mustcache&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">avail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">avail</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avail</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;val: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;available[val]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">available</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">available</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inversionAllocs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if (inst-&gt;getParent() == &amp;newFunc-&gt;getEntryBlock()) {</span>
<span class="w">    </span><span class="c1">//  return inst;</span>
<span class="w">    </span><span class="c1">//}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// llvm::errs() &lt;&lt; &quot;allowed &quot; &lt;&lt; *inst &lt;&lt; &quot;from domination\n&quot;;</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// llvm::errs() &lt;&lt; &quot;allowed &quot; &lt;&lt; *inst &lt;&lt; &quot;from block domination\n&quot;;</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">TapesToPreventRecomputation</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">inst</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// assert(!val-&gt;getName().startswith(&quot;$tapeload&quot;));</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">found0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found0</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">found0</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found1</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">found1</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cachedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found2</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cachedValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">found1</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found1</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">found0</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cachedValue</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;val: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;unwrap_cache[cidx]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">cachedValue</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">cachedValue</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">cachedValue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO this isOriginal is a bottleneck, the new mapping of</span>
<span class="w">          </span><span class="c1">// knownRecompute should be precomputed and maintained to lookup</span>
<span class="w">          </span><span class="c1">// instead</span>
<span class="w">          </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="c1">// If a given value has been chosen to be cached, do not compute the</span>
<span class="w">          </span><span class="c1">// operands to unwrap it, instead simply emit a placeholder to be</span>
<span class="w">          </span><span class="c1">// replaced by the cache load later. This placeholder should only be</span>
<span class="w">          </span><span class="c1">// returned when the original value would be recomputed (e.g. this</span>
<span class="w">          </span><span class="c1">// function would not return null). Since this case assumes everything</span>
<span class="w">          </span><span class="c1">// can be recomputed, simply return the placeholder.</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                          </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_krcLFUreplacement&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Metadata</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">avail</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">avail</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">MDNode</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="p">{</span><span class="n">ValueAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">)),</span><span class="w"></span>
<span class="w">                       </span><span class="n">ValueAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)}));</span><span class="w"></span>
<span class="w">              </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;enzyme_available&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">MDNode</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">avail</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"></span>
<span class="w">                                 </span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO this isOriginal is a bottleneck, the new mapping of</span>
<span class="w">          </span><span class="c1">// knownRecompute should be precomputed and maintained to lookup</span>
<span class="w">          </span><span class="c1">// instead</span>
<span class="w">          </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="c1">// If a given value has been chosen to be cached, do not compute the</span>
<span class="w">          </span><span class="c1">// operands to unwrap it, instead simply emit a placeholder to be</span>
<span class="w">          </span><span class="c1">// replaced by the cache load later. This placeholder should only be</span>
<span class="w">          </span><span class="c1">// returned when the original value would be recomputed (e.g. this</span>
<span class="w">          </span><span class="c1">// function would not return null). See note below about the condition</span>
<span class="w">          </span><span class="c1">// as applied to this case.</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                          </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Don&#39;t unnecessarily cache a value if the caching</span>
<span class="w">                </span><span class="c1">// heuristic says we should preserve this precise (and not</span>
<span class="w">                </span><span class="c1">// an lcssa wrapped) value</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixLCSSA</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Note that this logic (original load must dominate or</span>
<span class="w">                </span><span class="c1">// alternatively be in the reverse block) is only valid iff when</span>
<span class="w">                </span><span class="c1">// applicable (here if in split mode), an uncacheable load</span>
<span class="w">                </span><span class="c1">// cannot be hoisted outside of a loop to be used as a loop</span>
<span class="w">                </span><span class="c1">// limit. This optimization is currently done in the combined</span>
<span class="w">                </span><span class="c1">// mode (e.g. if a load isn&#39;t modified between a prior insertion</span>
<span class="w">                </span><span class="c1">// point and the actual load, it is legal to recompute).</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                    </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_krcAFUWLreplacement&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Metadata</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">avail</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="n">avail</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">MDNode</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="p">{</span><span class="n">ValueAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                                           </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ValueAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)}));</span><span class="w"></span>
<span class="w">                  </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="s">&quot;enzyme_available&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">MDNode</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">avail</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"></span>
<span class="w">                                     </span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO this isOriginal is a bottleneck, the new mapping of</span>
<span class="w">          </span><span class="c1">// knownRecompute should be precomputed and maintained to lookup</span>
<span class="w">          </span><span class="c1">// instead</span>

<span class="w">          </span><span class="c1">// If a given value has been chosen to be cached, do not compute the</span>
<span class="w">          </span><span class="c1">// operands to unwrap it if it is not legal to do so. This prevents</span>
<span class="w">          </span><span class="c1">// the creation of unused versions of the instruction&#39;s operand, which</span>
<span class="w">          </span><span class="c1">// may be assumed to never be used and thus cause an error when they</span>
<span class="w">          </span><span class="c1">// are inadvertantly cached.</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                          </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#define getOpFullest(Builder, vtmp, frominst, check)                           \</span>
<span class="cp">  ({                                                                           \</span>
<span class="cp">    Value *v = vtmp;                                                           \</span>
<span class="cp">    BasicBlock *origParent = frominst;                                         \</span>
<span class="cp">    Value *___res;                                                             \</span>
<span class="cp">    if (unwrapMode == UnwrapMode::LegalFullUnwrap ||                           \</span>
<span class="cp">        unwrapMode == UnwrapMode::LegalFullUnwrapNoTapeReplace ||              \</span>
<span class="cp">        unwrapMode == UnwrapMode::AttemptFullUnwrap ||                         \</span>
<span class="cp">        unwrapMode == UnwrapMode::AttemptFullUnwrapWithLookup) {               \</span>
<span class="cp">      if (v == val)                                                            \</span>
<span class="cp">        ___res = nullptr;                                                      \</span>
<span class="cp">      else                                                                     \</span>
<span class="cp">        ___res = unwrapM(v, Builder, available, unwrapMode, origParent,        \</span>
<span class="cp">                         permitCache);                                         \</span>
<span class="cp">      if (!___res &amp;&amp; unwrapMode == UnwrapMode::AttemptFullUnwrapWithLookup) {  \</span>
<span class="cp">        bool noLookup = false;                                                 \</span>
<span class="cp">        auto found = available.find(v);                                        \</span>
<span class="cp">        if (found != available.end() &amp;&amp; !found-&gt;second)                        \</span>
<span class="cp">          noLookup = true;                                                     \</span>
<span class="cp">        if (auto opinst = dyn_cast&lt;Instruction&gt;(v))                            \</span>
<span class="cp">          if (isOriginalBlock(*Builder.GetInsertBlock())) {                    \</span>
<span class="cp">            if (!DT.dominates(opinst, &amp;*Builder.GetInsertPoint()))             \</span>
<span class="cp">              noLookup = true;                                                 \</span>
<span class="cp">          }                                                                    \</span>
<span class="cp">        if (origParent)                                                        \</span>
<span class="cp">          if (auto opinst = dyn_cast&lt;Instruction&gt;(v)) {                        \</span>
<span class="cp">            v = fixLCSSA(opinst, origParent);                                  \</span>
<span class="cp">          }                                                                    \</span>
<span class="cp">        if (!noLookup)                                                         \</span>
<span class="cp">          ___res = lookupM(v, Builder, available, v != val);                   \</span>
<span class="cp">      }                                                                        \</span>
<span class="cp">      if (___res)                                                              \</span>
<span class="cp">        assert(___res-&gt;getType() == v-&gt;getType() &amp;&amp; &quot;uw&quot;);                     \</span>
<span class="cp">    } else {                                                                   \</span>
<span class="cp">      if (origParent)                                                          \</span>
<span class="cp">        if (auto opinst = dyn_cast&lt;Instruction&gt;(v)) {                          \</span>
<span class="cp">          v = fixLCSSA(opinst, origParent);                                    \</span>
<span class="cp">        }                                                                      \</span>
<span class="cp">      assert(unwrapMode == UnwrapMode::AttemptSingleUnwrap);                   \</span>
<span class="cp">      auto found = available.find(v);                                          \</span>
<span class="cp">      assert(found == available.end() || found-&gt;second);                       \</span>
<span class="cp">      ___res = lookupM(v, Builder, available, v != val);                       \</span>
<span class="cp">      if (___res &amp;&amp; ___res-&gt;getType() != v-&gt;getType()) {                       \</span>
<span class="cp">        llvm::errs() &lt;&lt; *newFunc &lt;&lt; &quot;\n&quot;;                                      \</span>
<span class="cp">        llvm::errs() &lt;&lt; &quot; v = &quot; &lt;&lt; *v &lt;&lt; &quot; res = &quot; &lt;&lt; *___res &lt;&lt; &quot;\n&quot;;         \</span>
<span class="cp">      }                                                                        \</span>
<span class="cp">      if (___res)                                                              \</span>
<span class="cp">        assert(___res-&gt;getType() == v-&gt;getType() &amp;&amp; &quot;lu&quot;);                     \</span>
<span class="cp">    }                                                                          \</span>
<span class="cp">    ___res;                                                                    \</span>
<span class="cp">  })</span>
<span class="cp">#define getOpFull(Builder, vtmp, frominst)                                     \</span>
<span class="cp">  getOpFullest(Builder, vtmp, frominst, true)</span>
<span class="cp">#define getOpUnchecked(vtmp)                                                   \</span>
<span class="cp">  ({                                                                           \</span>
<span class="cp">    BasicBlock *parent = scope;                                                \</span>
<span class="cp">    getOpFullest(BuilderM, vtmp, parent, false);                               \</span>
<span class="cp">  })</span>
<span class="cp">#define getOp(vtmp)                                                            \</span>
<span class="cp">  ({                                                                           \</span>
<span class="cp">    BasicBlock *parent = scope;                                                \</span>
<span class="cp">    if (parent == nullptr)                                                     \</span>
<span class="cp">      if (auto originst = dyn_cast&lt;Instruction&gt;(val))                          \</span>
<span class="cp">        parent = originst-&gt;getParent();                                        \</span>
<span class="cp">    getOpFullest(BuilderM, vtmp, parent, true);                                \</span>
<span class="cp">  })</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FreezeInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateFreeze</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCast</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getDestTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ExtractValueInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getAggregateOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">InsertValueInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getAggregateOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                               </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ExtractElementInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">InsertElementInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ShuffleVectorInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getShuffleMaskForBitcode</span><span class="p">(),</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; op: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; op0: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; op1: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; p0: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  p1: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBinOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ICmpInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getPredicate</span><span class="p">(),</span><span class="w"> </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FCmpInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateFCmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getPredicate</span><span class="p">(),</span><span class="w"> </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FPMathOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">             </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FPMathOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FNeg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FPMathOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SelectInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ind</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot;inst: &quot; &lt;&lt; *inst &lt;&lt; &quot;\n&quot;;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getNumIndices</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">ind</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getPointerOperandType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">ind</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setIsInBounds</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isInBounds</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">newi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_noneedunwrap&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">load</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                     </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="cm">/*reverse*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="cm">/*legalRecomputeCache*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">warnMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnwrappedWarnings</span><span class="p">[</span><span class="n">load</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">warnMap</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;UncacheableUnwrap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Load cannot be unwrapped &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; in &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; - &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; mode &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">unwrapMode</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">warnMap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">pidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pidx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">load</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;load-&gt;getOperand(0): &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;idx: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pidx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; unwrapping: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; mode=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">pidx</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">pidx</span><span class="p">,</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">load</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toreturn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setVolatile</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setOrdering</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getOrdering</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setSyncScopeID</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getSyncScopeID</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">load</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO adding to cache only legal if no alias of any future writes</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                     </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">args</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toreturn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// This is a placeholder shadow for a load, rather than falling</span>
<span class="w">      </span><span class="c1">// back to the uncached variant, use the proper procedure for</span>
<span class="w">      </span><span class="c1">// an inverted load</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">dli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hasUninverted</span><span class="p">(</span><span class="n">phi</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Almost identical code to unwrap load (replacing use of shadow</span>
<span class="w">        </span><span class="c1">// where appropriate)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_noneedunwrap&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">dli</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                         </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO actually consider whether this is legal to move to the new</span>
<span class="w">          </span><span class="c1">// location, rather than recomputable anywhere</span>
<span class="w">          </span><span class="n">legalMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">dli</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalMove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">warnMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnwrappedWarnings</span><span class="p">[</span><span class="n">phi</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">warnMap</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;UncacheableUnwrap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;Differential Load cannot be unwrapped &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dli</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; in &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; mode &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">unwrapMode</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">warnMap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">pidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">pidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">pidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pidx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;dli: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">dli</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;dli-&gt;getOperand(0): &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;pidx: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pidx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">pidx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">pidx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">pidx</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toreturn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">newi</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">dli</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toreturn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dli</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setVolatile</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setOrdering</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getOrdering</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setSyncScopeID</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getSyncScopeID</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">dli</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO adding to cache only legal if no alias of any future writes</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If requesting loop bound and are requesting the total size.</span>
<span class="w">    </span><span class="c1">// Rather than generating a new lcssa variable, use the existing loop exact</span>
<span class="w">    </span><span class="c1">// bound var</span>
<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">ivctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scope</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ivctx</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">ivctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newFunc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ivctx</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">ivctx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ivctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalForReverseBlock</span><span class="p">(</span><span class="o">*</span><span class="n">ivctx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ivctx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">ivctx</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getContext</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">incoming_values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getContext</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopVar</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lc</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Must be in a reverse pass fashion for a lookup to index bound to be</span>
<span class="w">          </span><span class="c1">// legal</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">lc</span><span class="p">.</span><span class="n">preheader</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*forwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">getDynamicLoopLimit</span><span class="p">(</span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*isi1*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Don&#39;t attempt to unroll a loop induction variable in other</span>
<span class="w">    </span><span class="c1">// circumstances</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LLI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">PPC</span><span class="p">.</span><span class="n">FAM</span><span class="p">.</span><span class="n">getResult</span><span class="o">&lt;</span><span class="n">LoopAnalysis</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">prevIteration</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LLI</span><span class="p">.</span><span class="n">isLoopHeader</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PH</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">PH</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">prevIteration</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PH</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">incoming_values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPotentialLastLoopValue</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">LLI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOpUnchecked</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">toreturn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Map of function edges to list of values possible</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">done</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">Q</span><span class="p">;</span><span class="w"> </span><span class="c1">// newblock, target</span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">parent</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"></span>
<span class="w">               </span><span class="n">trace</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="n">Q</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Q</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">count</span><span class="p">(</span><span class="n">target</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">blockLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">block</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">Pred</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Don&#39;t go up the backedge as we can use the last value if desired</span>
<span class="w">          </span><span class="c1">// via lcssa</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockLoop</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blockLoop</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">blockLoop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">Pred</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="n">Q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Pred</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">),</span><span class="w"> </span><span class="n">target</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">blocks</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">oldB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldB</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">inReverseBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">fwd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">oldB</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">inReverseBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">oldB</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">eraseBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">bret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">revtopo</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seen</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">seen</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">B</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">seen</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">S</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">dfs</span><span class="p">(</span><span class="n">S</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">revtopo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">dfs</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">seen</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">bret</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">revtopo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">revtopo</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">toErase</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">revtopo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">B</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bret</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">reverse</span><span class="p">(</span><span class="o">*</span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">toErase</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">unwrap_cache</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">lookup_cache</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">tfwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">B</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">tfwd</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rfound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">tfwd</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">rfound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tlst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rfound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">tlst</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">tlst</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">tlst</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">tlst</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">toErase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">erase</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">revtopo</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">subblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// The second split block must not have a parent with an edge</span>
<span class="w">              </span><span class="c1">// to a block other than to itself, which can reach any of its</span>
<span class="w">              </span><span class="c1">// two targets.</span>
<span class="w">              </span><span class="c1">// TODO verify this</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">block2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">P</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block2</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                          </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">seen2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from noonesize\n&quot;;</span>
<span class="w">                  </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen2</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">seen2</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from not uniqueTargets\n&quot;;</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="n">seen2</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from not unknown target\n&quot;;</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from not same target\n&quot;;</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen2</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from not 2 seen\n&quot;;</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">subblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="nl">nextblock</span><span class="p">:;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subblock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">bi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">cond1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cond1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">bi2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">subblock</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">cond2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cond2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">predBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                                                       </span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vals</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldB</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">bret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phimerge&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">valparent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">subblock</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">block</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">valparent</span><span class="p">,</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                     </span><span class="n">done</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">valparent</span><span class="p">,</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">])].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                     </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">blocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phirc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">                </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">PB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">valparent</span><span class="p">,</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">])].</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Recompute the phi computation with the conditional if:</span>
<span class="w">                </span><span class="c1">// 1) the instruction may read from memory AND does not</span>
<span class="w">                </span><span class="c1">//    dominate the current insertion point (thereby</span>
<span class="w">                </span><span class="c1">//    potentially making such recomputation without the</span>
<span class="w">                </span><span class="c1">//    condition illegal)</span>
<span class="w">                </span><span class="c1">// 2) the value is a call or load and option is set to not</span>
<span class="w">                </span><span class="c1">//    speculatively recompute values within a phi</span>
<span class="w">                </span><span class="c1">//            OR</span>
<span class="w">                </span><span class="c1">// 3) the value comes from a previous iteration.</span>
<span class="w">                </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nextScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PB</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="c1">// if (inst-&gt;getParent() == nextScope) nextScope =</span>
<span class="w">                </span><span class="c1">// phi-&gt;getParent();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">PB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;tri block prev iteration unhandled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">mayReadFromMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                            </span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                           </span><span class="p">(</span><span class="o">!</span><span class="n">EnzymeSpeculatePHIs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))))</span><span class="w"></span>
<span class="w">                  </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="w">                  </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">                </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">getOpFull</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">),</span><span class="w"> </span><span class="n">PB</span><span class="p">));</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">endingBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">bsplit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phisplt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">bsplit</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">oldB</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">cond1</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">))].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">bsplit</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">))].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">bsplit</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">bsplit</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">cond2</span><span class="p">,</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">bret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">toret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">              </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="nl">rnextpair</span><span class="p">:;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">equivalentTerminator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">prevAvailable</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">prevAvailable</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">getContext</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">prevIdx</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevAvailable</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">var</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">prevIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prevAvailable</span><span class="p">[</span><span class="n">ctx</span><span class="p">.</span><span class="n">var</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">prevIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">prevIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">prevIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Prevent recursive unroll.</span>
<span class="w">        </span><span class="n">prevAvailable</span><span class="p">[</span><span class="n">phi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vals</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldB</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">bret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phimerge&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preds</span><span class="p">(</span><span class="n">predecessors</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">tup</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">enumerate</span><span class="p">(</span><span class="n">preds</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">index</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">PB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">blocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phirc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">            </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Recompute the phi computation with the conditional if:</span>
<span class="w">            </span><span class="c1">// 1) the instruction may reat from memory AND does not dominate</span>
<span class="w">            </span><span class="c1">//    the current insertion point (thereby potentially making such</span>
<span class="w">            </span><span class="c1">//    recomputation without the condition illegal)</span>
<span class="w">            </span><span class="c1">// 2) the value is a call or load and option is set to not</span>
<span class="w">            </span><span class="c1">//    speculatively recompute values within a phi</span>
<span class="w">            </span><span class="c1">//                OR</span>
<span class="w">            </span><span class="c1">// 3) the value comes from a previous iteration.</span>
<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nextScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PB</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="c1">// if (inst-&gt;getParent() == nextScope) nextScope = phi-&gt;getParent();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">PB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">prevAvailable</span><span class="p">[</span><span class="n">ctx</span><span class="p">.</span><span class="n">incvar</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prevIdx</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">prevAvailable</span><span class="p">[</span><span class="n">ctx</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">B</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">prevIdx</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">prevIdx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">___res</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">___res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">prevAvailable</span><span class="p">,</span><span class="w"> </span><span class="n">unwrapMode</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="cm">/*permitCache*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">___res</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                    </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="kt">bool</span><span class="w"> </span><span class="n">noLookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"></span>
<span class="w">                      </span><span class="n">noLookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixLCSSA</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">noLookup</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">___res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">prevAvailable</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">___res</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">___res</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;uw&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixLCSSA</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptSingleUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">___res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">prevAvailable</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">___res</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">___res</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; v = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; res = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">___res</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">___res</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">___res</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;lu&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">___res</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">mayReadFromMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                       </span><span class="p">(</span><span class="o">!</span><span class="n">EnzymeSpeculatePHIs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))))</span><span class="w"></span>
<span class="w">              </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="w">              </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">endingBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Coming from a previous iteration is equivalent to the current</span>
<span class="w">        </span><span class="c1">// iteration at zero.</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"></span>
<span class="w">          </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmpNE</span><span class="p">(</span><span class="n">prevIdx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">prevIdx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">prevIdx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">prevIdx</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">toret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">                                               </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">instRet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toret</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">instRet</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">bret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">toret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;prev iteration: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">phi</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">equivalentTerminator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fast</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nl">nextpair</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="nl">fast</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">SwitchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">oldB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">SwitchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getDefaultDest</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">scase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">scase</span><span class="p">.</span><span class="n">getCaseSuccessor</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">cond</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vals</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldB</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">prevIteration</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">bret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phimerge&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">predBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="w"></span>
<span class="w">                   </span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">PB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                              </span><span class="n">predBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">blocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_phirc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Recompute the phi computation with the conditional if:</span>
<span class="w">          </span><span class="c1">// 1) the instruction may reat from memory AND does not dominate</span>
<span class="w">          </span><span class="c1">//    the current insertion point (thereby potentially making such</span>
<span class="w">          </span><span class="c1">//    recomputation without the condition illegal)</span>
<span class="w">          </span><span class="c1">// 2) the value is a call or load and option is set to not</span>
<span class="w">          </span><span class="c1">//    speculatively recompute values within a phi</span>
<span class="w">          </span><span class="c1">//                OR</span>
<span class="w">          </span><span class="c1">// 3) the value comes from a previous iteration.</span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nextScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PB</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="c1">// if (inst-&gt;getParent() == nextScope) nextScope = phi-&gt;getParent();</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">mayReadFromMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">               </span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="o">!</span><span class="n">EnzymeSpeculatePHIs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))))</span><span class="w"></span>
<span class="w">            </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">getOpFull</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">nextScope</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PB</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">endingBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Fast path to not make a split block if no additional instructions</span>
<span class="w">      </span><span class="c1">// were made in the two blocks</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">toret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">                                             </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_unwrap&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">instRet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">toret</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">instRet</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">oldB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseBlocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">SwitchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">NSI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSwitch</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getNumCases</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">scase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">NSI</span><span class="o">-&gt;</span><span class="n">addCase</span><span class="p">(</span><span class="n">scase</span><span class="p">.</span><span class="n">getCaseValue</span><span class="p">(),</span><span class="w"> </span><span class="n">blocks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">idx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inReverseBlocks</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">fwd</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">bret</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">bret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">toret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">endingBlocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">permitCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">idx</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">        </span><span class="n">unwrap_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">oldB</span><span class="p">])</span><span class="w"></span>
<span class="w">        </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">bret</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">toret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">toret</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="nl">endCheck</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrapNoTapeReplace</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">opinst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nval</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">opinst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; oldF: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; opParen: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">opinst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newF: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - blk: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; opInst: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">opinst</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; mode=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">unwrapMode</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">unwrapMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scope</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">opinst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixLCSSA</span><span class="p">(</span><span class="n">opinst</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">toreturn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">nval</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="cm">/*tryLegalRecomputeCheck*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toreturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">toreturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">warnMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnwrappedWarnings</span><span class="p">[</span><span class="n">inst</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">warnMap</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;NoUnwrap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;Cannot unwrap &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; in &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">warnMap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::cacheForReverse</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderQ</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ignoreType</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">replace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;omp_get_thread_num&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isTokenTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isTokenTy</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isStructTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cacheForReverse incorrect tape type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; idx: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isStructTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;tape: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;idx: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;inst==malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ret: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">erase</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">erase</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">retType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LimitContext</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">.</span><span class="n">Block</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">ForceSingleIteration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">ForceSingleIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">Block</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_fromtape&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">omp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ompThreadId</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tPtr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">tPtr</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">entryBuilder</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="w"></span>
<span class="w">                      </span><span class="o">:</span><span class="w"> </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="p">});</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSubLimits</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="cm">/*inForwardPass*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">LimitContext</span><span class="p">(</span><span class="w"></span>
<span class="w">                                  </span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">innerType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;mod: &quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fn: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;bq insertblock: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ret: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;innerType: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; i=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; / lim = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">innerType</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innerType</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EfficientBoolCache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">innerType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">innerType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">innerType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;innerType: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc-&gt;getType(): &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ret: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal loop cache type&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;illegal loop cache type&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">innerType</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mdyncache_fromtape&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FreeMemory</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">isi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">ignoreType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="cm">/*forwardPass*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderQ</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">isi1</span><span class="p">,</span><span class="w"> </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">malloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">insert_or_assign</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">AssertingVH</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cache</span><span class="p">),</span><span class="w"> </span><span class="n">ctx</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// There already exists an alloaction for this, we should fully remove</span>
<span class="w">        </span><span class="c1">// it</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Remove stores into</span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stores</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">scopeInstructions</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stores</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">stores</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">User</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">users</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">users</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">lb</span><span class="p">(</span><span class="n">li</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">replacewith</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="n">lb</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">replacewith</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; li: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; u: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; replacewith: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">replacewith</span><span class="w"></span>
<span class="w">                               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; idx=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - tape=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">replacewith</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">replacewith</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">lb</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_cfrphi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">unwrappedLoads</span><span class="p">[</span><span class="n">phi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">erase</span><span class="p">(</span><span class="n">li</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;scopeMap[malloc]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;u: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal use for out of loop scopeMap1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">preerase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">preerase</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Remove stores into</span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stores</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">scopeInstructions</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stores</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">stores</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Remove allocations for scopealloc since it is already allocated</span>
<span class="w">          </span><span class="c1">// by the augmented forward pass</span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocs</span><span class="p">(</span><span class="n">scopeAllocs</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">scopeAllocs</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">scopeAllocs</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">allocinst</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">allocs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CastInst</span><span class="w"> </span><span class="o">*</span><span class="n">cast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">StoreInst</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">allocinst</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">use</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">cast</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">cast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">si</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">use</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allocinst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">si</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cast</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">si</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">use</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">si</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">storedinto</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">cast</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">cast</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">allocinst</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">storedinto</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">si</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">use</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">erase</span><span class="p">(</span><span class="n">si</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">allocinst</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Remove frees</span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tofree</span><span class="p">(</span><span class="n">scopeFrees</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">scopeFrees</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">scopeFrees</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">freeinst</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tofree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// This deque contains a list of operations</span>
<span class="w">            </span><span class="c1">// we can erasing upon erasing the free (and so on).</span>
<span class="w">            </span><span class="c1">// Since multiple operations can have the same operand,</span>
<span class="w">            </span><span class="c1">// this deque can contain the same value multiple times.</span>
<span class="w">            </span><span class="c1">// To remedy this we use a tracking value handle which will</span>
<span class="w">            </span><span class="c1">// be set to null when erased.</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">WeakTrackingVH</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">freeinst</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)};</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">freeinst</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">ops</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">getNumUses</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">isUsedByMetadata</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">ops</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">erase</span><span class="p">(</span><span class="n">z</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="c1">// uses of the alloc</span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">User</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">users</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">users</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">users</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// even with replace off, this can be replaced</span>
<span class="w">              </span><span class="c1">// as since we&#39;re in a loop this load is a load of cache</span>
<span class="w">              </span><span class="c1">// not of the final value (thereby overwriting the new</span>
<span class="w">              </span><span class="c1">// inst</span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">lb</span><span class="p">(</span><span class="n">li</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">replacewith</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">lb</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">replacewith</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">erase</span><span class="p">(</span><span class="n">li</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;scopeMap[malloc]: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;u: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal use for out of loop scopeMap2&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">preerase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">erase</span><span class="p">(</span><span class="n">preerase</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">takeName</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addedTapeVals</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">addedTapeVals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LimitContext</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">ForceSingleIteration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">ForceSingleIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">Block</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">toStoreInTape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">omp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">numThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ompNumThreads</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ompThreadId</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">entryBuilder</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">byteSizeOfType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">numThreads</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">firstallocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">inversionAllocs</span><span class="p">,</span><span class="w"> </span><span class="n">numThreads</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">byteSizeOfType</span><span class="p">,</span><span class="w"> </span><span class="n">numThreads</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_malloccache&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstallocation</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">inversionAllocs</span><span class="o">-&gt;</span><span class="n">getInstList</span><span class="p">().</span><span class="n">push_back</span><span class="p">(</span><span class="n">firstallocation</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">firstallocation</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">firstallocation</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">firstallocation</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                     </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">entryBuilder</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">malloc</span><span class="p">,</span><span class="w"> </span><span class="n">tPtr</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">toStoreInTape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstallocation</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">addedTapeVals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">toStoreInTape</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">ensureLookupCached</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*shouldFree=*/</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*scope*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">found2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">malloc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">found2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">found2</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">toadd</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">toadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scopeAllocs</span><span class="p">[</span><span class="n">found2</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">toadd</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">toadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; malloc: &quot; &lt;&lt; *malloc &lt;&lt; &quot;\n&quot;;</span>
<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; toadd: &quot; &lt;&lt; *toadd &lt;&lt; &quot;\n&quot;;</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toadd</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"></span>
<span class="w">             </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSubLimits</span><span class="p">(</span><span class="w"></span>
<span class="w">                         </span><span class="cm">/*inForwardPass*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">LimitContext</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">BuilderQ</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"></span>
<span class="w">                         </span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">         </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innerType</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">ignoreType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EfficientBoolCache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">toadd</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">innerType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">innerType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">toadd</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">innerType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;oldFunc:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; toadd: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">toadd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;innerType: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;malloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">malloc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">innerType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">malloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">addedTapeVals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">toadd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Fell through on cacheForReverse. This should never happen.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">/// Given an edge from BB to branchingBlock get the corresponding block to</span>
<span class="c1">/// branch to in the reverse pass</span>
<span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::getReverseOrLatchMerge</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                  </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">branchingBlock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// BB should be a forward pass block, assert that</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;BB: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;branchingBlock: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">branchingBlock</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">branchingBlock</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">branchingContext</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoopContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">branchingBlock</span><span class="p">,</span><span class="w"> </span><span class="n">branchingContext</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">BB</span><span class="p">].</span><span class="n">front</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">tup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span><span class="w"> </span><span class="n">branchingBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newBlocksForLoop_cache</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newBlocksForLoop_cache</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">newBlocksForLoop_cache</span><span class="p">[</span><span class="n">tup</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If we&#39;re reversing a latch edge.</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">incEntering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLoopContext</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">branchingBlock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                       </span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">branchingContext</span><span class="p">.</span><span class="n">header</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">latches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLatches</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If we&#39;re reverseing a loop exit.</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exitEntering</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">latches</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">latches</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latches</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">branchingBlock</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If we&#39;re re-entering a loop, prepare a loop-level forward pass to</span>
<span class="w">    </span><span class="c1">// rematerialize any loop-scope rematerialization.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">incEntering</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">exitEntering</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">loopRematerializations</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">loopReallocations</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">loopShadowReallocations</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">loopShadowRematerializations</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">origLI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rematerializableAllocations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">rematerialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="o">*</span><span class="n">my_TR</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">notForAnalysis</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rematerialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rematerialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">loopReallocations</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">loopRematerializations</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">origLI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">loopShadowReallocations</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">loopShadowRematerializations</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">origLI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">resumeblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">BB</span><span class="p">].</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopRematerializations</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">loopReallocations</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">loopShadowRematerializations</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">loopShadowReallocations</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rematerializedLoops_cache</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">L</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">rematerializedLoops_cache</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">resumeblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">enterB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;remat_enter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">rematerializedLoops_cache</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enterB</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">origLI</span><span class="o">-&gt;</span><span class="n">getBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">newB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;remat_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">B</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newB</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">reverseBlockToPrimal</span><span class="p">[</span><span class="n">newB</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">available</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">NB</span><span class="p">(</span><span class="n">enterB</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">origLI</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">()]);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handleLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">OL</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">subLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">Header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OL</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">NB</span><span class="p">(</span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">Header</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">flc</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">getContext</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">Header</span><span class="p">),</span><span class="w"> </span><span class="n">flc</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">flc</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fiv&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PH</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">Header</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">notForAnalysis</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">PH</span><span class="p">))</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OL</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">PH</span><span class="p">))</span><span class="w"></span>
<span class="w">                  </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">PH</span><span class="p">]);</span><span class="w"></span>
<span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="w">                  </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                                  </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">PH</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">available</span><span class="p">[</span><span class="n">flc</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">available</span><span class="p">[</span><span class="n">flc</span><span class="p">.</span><span class="n">incvar</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inc</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">OL</span><span class="o">-&gt;</span><span class="n">getSubLoops</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">handleLoop</span><span class="p">(</span><span class="n">SL</span><span class="p">,</span><span class="w"> </span><span class="cm">/*subLoop*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">handleLoop</span><span class="p">(</span><span class="n">origLI</span><span class="p">,</span><span class="w"> </span><span class="cm">/*subLoop*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">origLI</span><span class="o">-&gt;</span><span class="n">getBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">newB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">B</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">NB</span><span class="p">(</span><span class="n">newB</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="c1">// TODO fill available with relevant IV&#39;s surrounding and</span>
<span class="w">            </span><span class="c1">// IV&#39;s of inner loop phi&#39;s</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Only handle store, memset, and julia.write_barrier</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopRematerializations</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">()),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                      </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">available</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setVolatile</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setOrdering</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getOrdering</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setSyncScopeID</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getSyncScopeID</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">CI</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.write_barrier&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                      </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MemSetInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MemTransferInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// TODO</span>
<span class="w">                    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                      </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">));</span><span class="w"></span>

<span class="w">                    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                          </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">);</span><span class="w"></span>

<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                   </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">isDeallocationFunction</span><span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;unhandlable loop rematerialization instruction&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopReallocations</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="o">&amp;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getEntryBlock</span><span class="p">());</span><span class="w"></span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">((</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert_or_assign</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">AssertingVH</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">LimitContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                       </span><span class="n">lctx</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                      </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">available</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                                                         </span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                                                         </span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                                       </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                  </span><span class="n">storeInstructionInCache</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">));</span><span class="w"></span>

<span class="w">                  </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">CI</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;remat_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                  </span><span class="n">storeInstructionInCache</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; realloc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unknown loop reallocation&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopShadowRematerializations</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">valType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">));</span><span class="w"></span>

<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>

<span class="w">                  </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                                     </span><span class="n">parseTBAA</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">DL</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isIntegral</span><span class="p">();</span><span class="w"></span>

<span class="w">                  </span><span class="c1">// TODO allow recognition of other types that could contain</span>
<span class="w">                  </span><span class="c1">// pointers [e.g. {void*, void*} or &lt;2 x i64&gt; ]</span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">storeSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DL</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">valType</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">                  </span><span class="c1">//! Storing a floating point value</span>
<span class="w">                  </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">auto</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_TR</span><span class="o">-&gt;</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                    </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                    </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp</span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                                 </span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;assuming type as integral for store: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">                            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">my_TR</span><span class="o">-&gt;</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot deduce type of store &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot deduce&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_TR</span><span class="w"></span>
<span class="w">                               </span><span class="o">-&gt;</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">                               </span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                          </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_val</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                            </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getWidth</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">i</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                          </span><span class="n">lookupM</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_val</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="n">setPtrDiffe</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">valueop</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getOrdering</span><span class="p">(),</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getSyncScopeID</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                </span><span class="cm">/*mask*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="c1">// TODO shadow memtransfer</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MemSetInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                        </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">available</span><span class="p">)};</span><span class="w"></span>

<span class="w">                    </span><span class="n">ValueType</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">};</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">MS</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                   </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">MS</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">MS</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">CI</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.write_barrier&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// TODO</span>
<span class="w">                    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span><span class="w"></span>
<span class="w">                        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">lookupM</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">));</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                            </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">);</span><span class="w"></span>

<span class="w">                      </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                          </span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">                      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">                      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">                      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">isDeallocationFunction</span><span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="s">&quot;unhandlable loop shadow rematerialization instruction&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopShadowReallocations</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="o">&amp;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getEntryBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">ipfound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ipfound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert_or_assign</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">)</span><span class="n">placeholder</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">AssertingVH</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">LimitContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                       </span><span class="n">lctx</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">dbgLoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span><span class="w"></span>

<span class="w">                  </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">NB</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>

<span class="w">                  </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadowHandlers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">str</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                      </span><span class="n">shadowHandlers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">shadowHandlers</span><span class="p">[</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">str</span><span class="p">()](</span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">                    </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                         </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;mi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;mi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">                      </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">takeName</span><span class="p">(</span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                                  </span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                              </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                      </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                      </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                      </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">                      </span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">),</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">));</span><span class="w"></span>
<span class="w">                      </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacement</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="n">zeroKnownAllocation</span><span class="p">(</span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unknown shadow rematerialization value&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">storeInstructionInCache</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">llvm</span><span class="o">::</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">origExitBlocks</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">getExitBlocks</span><span class="p">(</span><span class="n">origLI</span><span class="p">,</span><span class="w"> </span><span class="n">origExitBlocks</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Remap a branch to the header to enter the incremented</span>
<span class="w">            </span><span class="c1">// reverse of that block.</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">remap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Remap of an exit branch is to go to the reverse</span>
<span class="w">              </span><span class="c1">// exiting block.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">origExitBlocks</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">rB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">B</span><span class="p">)].</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Reverse of an incrementing branch is go to the</span>
<span class="w">              </span><span class="c1">// reverse of the branching block.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rB</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">origLI</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">B</span><span class="p">)].</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">rB</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="c1">// TODO clone terminator</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">TI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">TI</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">notForAnalysis</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateUnreachable</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">BI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">isUnconditional</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">remap</span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">              </span><span class="k">else</span><span class="w"></span>
<span class="w">                </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">NB</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                                </span><span class="n">remap</span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                </span><span class="n">remap</span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SwitchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">NSI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateSwitch</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">()),</span><span class="w"> </span><span class="n">NB</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">remap</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getDefaultDest</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">cas</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">NSI</span><span class="o">-&gt;</span><span class="n">addCase</span><span class="p">(</span><span class="n">cas</span><span class="p">.</span><span class="n">getCaseValue</span><span class="p">(),</span><span class="w"> </span><span class="n">remap</span><span class="p">(</span><span class="n">cas</span><span class="p">.</span><span class="n">getCaseSuccessor</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UnreachableInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TI</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">NB</span><span class="p">.</span><span class="n">CreateUnreachable</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Fixup phi nodes that may have their predecessors now changed by</span>
<span class="w">            </span><span class="c1">// the phi unwrapping</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">notForAnalysis</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">NB</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">B</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">S</span><span class="p">];</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">E</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">Op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NumOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"></span>
<span class="w">                       </span><span class="n">Op</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NumOps</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">Op</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">Op</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">origToNewForward</span><span class="p">[</span><span class="n">B</span><span class="p">])</span><span class="w"></span>
<span class="w">                      </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">setIncomingBlock</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span><span class="w"> </span><span class="n">NB</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">resumeblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enterB</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">incEntering</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">incB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;inc&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">].</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">incB</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">].</span><span class="n">back</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tbuild</span><span class="p">(</span><span class="n">incB</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">resumeblock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newBlocksForLoop_cache</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incB</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">exitEntering</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">incB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;merge&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">].</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="n">branchingBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">incB</span><span class="o">-&gt;</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">branchingBlock</span><span class="p">].</span><span class="n">back</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tbuild</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">branchingBlock</span><span class="p">].</span><span class="n">back</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">dynamic</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">assumeDynamicLoopOfSizeOne</span><span class="p">(</span><span class="n">L</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Must be in a reverse pass fashion for a lookup to index bound to be</span>
<span class="w">          </span><span class="c1">// legal</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">lc</span><span class="p">.</span><span class="n">preheader</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*forwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">tbuild</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">getDynamicLoopLimit</span><span class="p">(</span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*isi1*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">,</span><span class="w"> </span><span class="n">tbuild</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">tbuild</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">incB</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">tbuild</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">resumeblock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newBlocksForLoop_cache</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incB</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">newBlocksForLoop_cache</span><span class="p">[</span><span class="n">tup</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">BB</span><span class="p">].</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">GradientUtils::forceContexts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">originalBlocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">getContext</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">GradientUtils::legalRecompute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="o">&amp;</span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">reverse</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="kt">bool</span><span class="w"> </span><span class="n">legalRecomputeCache</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">uiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasUninverted</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">dli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">uiv</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">dli</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">reverse</span><span class="p">);</span><span class="w"> </span><span class="c1">// TODO ADD &amp;&amp; !TR.intType(getOriginal(dli),</span>
<span class="w">                      </span><span class="c1">// /*mustfind*/false).isPossibleFloat();</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">phi</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">func</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">LoopInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">FLI</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="n">newFunc</span><span class="p">,</span><span class="w"> </span><span class="n">LI</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">oldFunc</span><span class="p">,</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">}};</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tup</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">incoming_values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPotentialLastLoopValue</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">FLI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tup</span><span class="p">.</span><span class="n">FLI</span><span class="p">.</span><span class="n">isLoopHeader</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Currently can only recompute header</span>
<span class="w">          </span><span class="c1">// with two incoming values</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">FLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Only recomputable if non recursive.</span>
<span class="w">          </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">seen</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">todo</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PH</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Prior iterations must be recomputable without</span>
<span class="w">            </span><span class="c1">// this value.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">PH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">PH</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">                  </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">todo</span><span class="p">.</span><span class="n">back</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">todo</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">seen</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">phi</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">                  </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_mustcache&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// If this is a load from cache already, dont force a cache of this</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legalRecomputeCache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">CacheLookups</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// TODO consider callinst here</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">IntrinsicInst</span><span class="w"> </span><span class="o">*</span><span class="n">II</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">II</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">li</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">         </span><span class="p">(</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_i</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_p</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_f</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_i</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_p</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_f</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">masked_load</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If this is an already unwrapped value, legal to recompute again.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwrappedLoads</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">unwrappedLoads</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">unwrappedLoads</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">li</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">li</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// todo consider when we pass non original queries</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">legalRecomputeCache</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; parent: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; li: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal load legalRecopmute query&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">can_modref_map</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;can_modref_map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">can_modref_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; + &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; of func &quot;</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;couldn&#39;t find in can_modref_map: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - &quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; in fn: &quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// if insertion block of this function:</span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">fwdBlockIfReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">fwdBlockIfReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="o">-&gt;</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">BuilderM</span><span class="o">-&gt;</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">fwdBlockIfReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fwdBlockIfReverse</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">fwdBlockIfReverse</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">cast_or_null</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">fwdBlockIfReverse</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fwdBlockIfReverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">allFollowersOf</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">OrigAA</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span><span class="w"></span>
<span class="w">                          </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;UncacheableLoad&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Load must be recomputed &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; in reverse_&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">BuilderM</span><span class="o">-&gt;</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                </span><span class="s">&quot; due to &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">origStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="o">-&gt;</span><span class="n">GetInsertPoint</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">og</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">origStart</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">origStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">og</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">origStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origStart</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigDT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">origStart</span><span class="p">,</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">LI</span><span class="p">,</span><span class="w"> </span><span class="n">origStart</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">OrigAA</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;UncacheableLoad&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="n">oldFunc</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="s">&quot;Load must be recomputed &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; in &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">BuilderM</span><span class="o">-&gt;</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="s">&quot; due to &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">dli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hasUninverted</span><span class="p">(</span><span class="n">li</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">dli</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// TODO mark all the explicitly legal nodes (caches, etc)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; orig: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">orig</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; parent: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown load to redo!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">).</span><span class="n">getValueAsString</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">not_intrinsic</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_shouldrecompute&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">isMemFreeLibMFunction</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgamma_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammaf_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammal_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgamma_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammaf_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammal_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanh&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanhf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__pow_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__fd_sincos_1&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.pointer_from_objref&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;enzyme_wrapmpi$$&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;omp_get_thread_num&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;omp_get_max_threads&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">mayReadOrWriteMemory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//! Given the option to recompute a value or re-use an old one, return true if</span>
<span class="c1">//! it is faster to recompute this value from scratch</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">GradientUtils::shouldRecompute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="k">const</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="o">&amp;</span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO: remake such that this returns whether a load to a cache is more</span>
<span class="w">  </span><span class="c1">// expensive than redoing the computation.</span>

<span class="w">  </span><span class="c1">// If this is a load from cache already, just reload this</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_fromcache&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TapesToPreventRecomputation</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">inst</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">OrigInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">OrigInst</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">        </span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">OrigInst</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EnzymeNewCache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">EnzymeMinCutCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if this has operands that need to be loaded and haven&#39;t already been</span>
<span class="w">    </span><span class="c1">// loaded</span>
<span class="w">    </span><span class="c1">// TODO, just cache this</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If this is a load from cache already, dont force a cache of this</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CacheLookups</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If a previously cached this operand, don&#39;t let it trigger the</span>
<span class="w">        </span><span class="c1">// heuristic for caching this value instead.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If the actually uncacheable operand is in a different loop scope</span>
<span class="w">        </span><span class="c1">// don&#39;t cache this value instead as it may require more memory</span>
<span class="w">        </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">getContext</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inLoop1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inLoop2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">inLoop1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">lc1</span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lc2</span><span class="p">.</span><span class="n">header</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If a placeholder phi for inversion (and we know from above not</span>
<span class="w">        </span><span class="c1">// recomputable)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hasUninverted</span><span class="p">(</span><span class="n">op</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">forceCache</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Even if cannot recompute (say a phi node), don&#39;t force a reload if it</span>
<span class="w">        </span><span class="c1">// is possible to just use this instruction from forward pass without</span>
<span class="w">        </span><span class="c1">// issue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">i2</span><span class="o">-&gt;</span><span class="n">mayReadOrWriteMemory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">i2</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// TODO upgrade this to be all returns that this could enter from</span>
<span class="w">              </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">i2</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BlocksDominatingAllReturns</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="nl">forceCache</span><span class="p">:;</span><span class="w"></span>
<span class="w">        </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;ChosenCache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Choosing to cache use &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot; due to &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">mayReadOrWriteMemory</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_f</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">).</span><span class="n">getValueAsString</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">not_intrinsic</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_shouldrecompute&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">isMemFreeLibMFunction</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgamma_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammaf_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammal_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgamma_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammaf_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammal_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanh&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanhf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__pow_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__fd_sincos_1&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.pointer_from_objref&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;enzyme_wrapmpi$$&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;omp_get_thread_num&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;omp_get_max_threads&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// cache a call, assuming its longer to run that</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; caching call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// cast&lt;CallInst&gt;(val)-&gt;getCalledFunction()-&gt;dump();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::CreateFromClone</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeLogic</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">todiff</span><span class="p">,</span><span class="w"> </span><span class="n">TargetLibraryInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TLI</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TypeAnalysis</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_args</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">returnUsed</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">shadowReturnUsed</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">AugmentedStruct</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">returnMapping</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">omp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Since this is forward pass this should always return the tape (at index 0)</span>
<span class="w">  </span><span class="n">returnMapping</span><span class="p">[</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">returnCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">returnUsed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">returnMapping</span><span class="p">[</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Return</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">++</span><span class="n">returnCount</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// We don&#39;t need to differentially return something that we know is not a</span>
<span class="w">  </span><span class="c1">// pointer (or somehow needed for shadow analysis)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadowReturnUsed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">returnMapping</span><span class="p">[</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">DifferentialReturn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">++</span><span class="n">returnCount</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">ReturnType</span><span class="w"> </span><span class="n">returnValue</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">returnCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">Tape</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">returnCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">TapeAndReturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">returnCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">TapeAndTwoReturns</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;illegal number of elements in augmented return struct&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constants</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nonconstant</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">returnvals</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">originalToNew</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constant_values</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nonconstant_values</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">newFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">PPC</span><span class="p">.</span><span class="n">CloneFunctionWithReturns</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">,</span><span class="w"> </span><span class="cm">/* width */</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">todiff</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">invertedPointers</span><span class="p">,</span><span class="w"> </span><span class="n">constant_args</span><span class="p">,</span><span class="w"> </span><span class="n">constant_values</span><span class="p">,</span><span class="w"> </span><span class="n">nonconstant_values</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">returnvals</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="cm">/*returnValue*/</span><span class="w"> </span><span class="n">returnValue</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;fakeaugmented_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">originalToNew</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="cm">/*diffeReturnArg*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*additionalArg*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GradientUtils</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">,</span><span class="w"> </span><span class="n">todiff</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">,</span><span class="w"> </span><span class="n">constant_values</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">nonconstant_values</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="n">originalToNew</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">,</span><span class="w"> </span><span class="cm">/* width */</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">omp</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="nf">DiffeGradientUtils::CreateFromClone</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeLogic</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">todiff</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TargetLibraryInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TypeAnalysis</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">diffeReturnArg</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_args</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ReturnType</span><span class="w"> </span><span class="n">returnValue</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">additionalArg</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">omp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constants</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nonconstant</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">returnvals</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">originalToNew</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constant_values</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nonconstant_values</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fwddiffe&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">prefix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">width</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;diffe&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;invalid DerivativeMode: ReverseModePrimal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">newFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">PPC</span><span class="p">.</span><span class="n">CloneFunctionWithReturns</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">todiff</span><span class="p">,</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">,</span><span class="w"> </span><span class="n">constant_args</span><span class="p">,</span><span class="w"> </span><span class="n">constant_values</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">nonconstant_values</span><span class="p">,</span><span class="w"> </span><span class="n">returnvals</span><span class="p">,</span><span class="w"> </span><span class="n">returnValue</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">todiff</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">originalToNew</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="cm">/*diffeReturnArg*/</span><span class="w"> </span><span class="n">diffeReturnArg</span><span class="p">,</span><span class="w"> </span><span class="n">additionalArg</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DiffeGradientUtils</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">,</span><span class="w"> </span><span class="n">todiff</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">,</span><span class="w"> </span><span class="n">constant_values</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">nonconstant_values</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="n">originalToNew</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">omp</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::GetOrCreateShadowConstant</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeLogic</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TargetLibraryInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TypeAnalysis</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TA</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantPointerNull</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataArray</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getElementAsConstant</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantArray</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantArray</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantArray</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantStruct</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantStruct</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantVector</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">GetOrCreateShadowFunction</span><span class="p">(</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isCast</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">GetElementPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NewOps</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">NewOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getWithOperands</span><span class="p">(</span><span class="n">NewOps</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_ZTVN10__cxxabiv120__si_class_type_infoE&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_ZTVN10__cxxabiv117__class_type_infoE&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">md</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot compute with global variable that doesn&#39;t have &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;marked shadow global&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;cannot compute with global variable that doesn&#39;t &quot;</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;have marked shadow global (metadata incorrect type)&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">md2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">gvemd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">gvemd</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getTargetTriple</span><span class="p">()).</span><span class="n">getArch</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="w"></span>
<span class="w">                              </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">AMDGPU</span><span class="o">::</span><span class="n">HSAMD</span><span class="o">::</span><span class="n">AddressSpaceQualifier</span><span class="o">::</span><span class="n">Local</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">AddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">nvptx</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">nvptx64</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">AddrSpace</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;shared memory not handled in meta global&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create global variable locally if not externally visible</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isConstant</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasInternalLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasPrivateLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasExternalLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasInitializer</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isConstant</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getLinkage</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getInitializer</span><span class="p">()</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="n">GetOrCreateShadowConstant</span><span class="p">(</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">type</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_shadow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getThreadLocalMode</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isExternallyInitialized</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">MDTuple</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="p">{</span><span class="n">ConstantAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="p">)}));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">      </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setUnnamedAddr</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getUnnamedAddr</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; unknown constant to create shadow of: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown constant to create shadow of&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::GetOrCreateShadowFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">EnzymeLogic</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TargetLibraryInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TypeAnalysis</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">//! Todo allow tape propagation</span>
<span class="w">  </span><span class="c1">//  Note that specifically this should _not_ be called with topLevel=true</span>
<span class="w">  </span><span class="c1">//  (since it may not be valid to always assume we can recompute the</span>
<span class="w">  </span><span class="c1">//  augmented primal) However, in the absence of a way to pass tape data</span>
<span class="w">  </span><span class="c1">//  from an indirect augmented (and also since we dont presently allow</span>
<span class="w">  </span><span class="c1">//  indirect augmented calls), topLevel MUST be true otherwise subcalls will</span>
<span class="w">  </span><span class="c1">//  not be able to lookup the augmenteddata/subdata (triggering an assertion</span>
<span class="w">  </span><span class="c1">//  failure, among much worse)</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">isRealloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_callwrapper&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_callwrapper&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">md</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;callwrapper of incorrect type&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;callwrapper of incorrect type&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">md2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">gvemd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gvemd</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">oldfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">Function</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;callwrap_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;entry&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">oldfn</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">CreateRetVoid</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">CreateRet</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;enzyme_callwrapper&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">MDTuple</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="n">ConstantAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">)}));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldfn</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;realloc&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">isRealloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">FnTypeInfo</span><span class="w"> </span><span class="n">type_args</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isRealloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;warning: assuming realloc only creates pointers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">type_args</span><span class="p">.</span><span class="n">Return</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// conservatively assume that we can only cache existing floating types</span>
<span class="w">  </span><span class="c1">// (i.e. that all args are uncacheable)</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">types</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uncacheable_args</span><span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">type_args</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">TypeTree</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">{}));</span><span class="w"></span>
<span class="w">    </span><span class="n">type_args</span><span class="p">.</span><span class="n">KnownValues</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">{}));</span><span class="w"></span>
<span class="w">    </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">typ</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"></span>
<span class="w">                                                </span><span class="o">:</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">               </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">types</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">typ</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                               </span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"></span>
<span class="w">                           </span><span class="o">?</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"></span>
<span class="w">                           </span><span class="o">:</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">       </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">newf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateForwardDiff</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="cm">/*freeMemory*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">type_args</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"> </span><span class="cm">/*augmented*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">newf</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_enzyme_forward&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">prefix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">width</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">globalname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNamedValue</span><span class="p">(</span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">newf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">LinkageTypes</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"> </span><span class="n">newf</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantExpr</span><span class="o">::</span><span class="n">getPointerCast</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">augdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateAugmentedPrimal</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="cm">/*constant_args*/</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*returnUsed*/</span><span class="w"> </span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*shadowReturnUsed*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">type_args</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*forceAnonymousTape*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">newf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateForwardDiff</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="cm">/*freeMemory*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">type_args</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"> </span><span class="cm">/*augmented*/</span><span class="w"> </span><span class="o">&amp;</span><span class="n">augdata</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">newf</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_enzyme_forwardsplit&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">prefix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">width</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">cdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantStruct</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">newf</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="p">{</span><span class="n">augdata</span><span class="p">.</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">newf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()}),</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="n">augdata</span><span class="p">.</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">newf</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">globalname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNamedValue</span><span class="p">(</span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">LinkageTypes</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"> </span><span class="n">cdata</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantExpr</span><span class="o">::</span><span class="n">getPointerCast</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO re atomic add consider forcing it to be atomic always as fallback if</span>
<span class="w">    </span><span class="c1">// used in a parallel context</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">returnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnUsed</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                                           </span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">augdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateAugmentedPrimal</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"> </span><span class="cm">/*constant_args*/</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">returnUsed</span><span class="p">,</span><span class="w"> </span><span class="n">shadowReturnUsed</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">type_args</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"> </span><span class="cm">/*forceAnonymousTape*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">newf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logic</span><span class="p">.</span><span class="n">CreatePrimalAndGradient</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">ReverseCacheKey</span><span class="p">){.</span><span class="n">todiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">constant_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">uncacheable_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">returnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">freeMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">AtomicAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">additionalType</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">typeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_args</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="n">TA</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*map*/</span><span class="w"> </span><span class="o">&amp;</span><span class="n">augdata</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">newf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">cdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantStruct</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">newf</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="p">{</span><span class="n">augdata</span><span class="p">.</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">newf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()}),</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="n">augdata</span><span class="p">.</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">newf</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">globalname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;_enzyme_reverse_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNamedValue</span><span class="p">(</span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">cdata</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">LinkageTypes</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"> </span><span class="n">cdata</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">globalname</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantExpr</span><span class="o">::</span><span class="n">getPointerCast</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::invertPointerM</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">nullShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">oval</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oldFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantPointerNull</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">oval</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataArray</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getElementAsConstant</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantArray</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantArray</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">CD</span><span class="p">](</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantArray</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantStruct</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">CD</span><span class="p">](</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantStruct</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Vals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">Vals</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantVector</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Vals</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">CD</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Vals</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantData</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nullShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">oval</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// NOTE, this is legal and the correct resolution, however, our activity</span>
<span class="w">    </span><span class="c1">// analysis honeypot no longer exists</span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">oval</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">newval</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">oval</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">oval</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">oval</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hasByValAttr</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getPointerAddressSpace</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipa&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">antialloca</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                         </span><span class="n">M</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                             </span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                             </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerAddressSpace</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">my_TR</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">CT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_TR</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="n">arg</span><span class="p">)[{</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">}];</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Can only localy replace a global variable if it is</span>
<span class="w">        </span><span class="c1">// known not to contain a pointer, which may be initialized</span>
<span class="w">        </span><span class="c1">// outside of this function to contain other memory which</span>
<span class="w">        </span><span class="c1">// will not have a shadow within the current function.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CT</span><span class="p">.</span><span class="n">isKnown</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CT</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">MemoryLocation</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">              </span><span class="n">Loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryLocation</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">LocationSize</span><span class="o">::</span><span class="n">beforeOrAfterPointer</span><span class="p">());</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">              </span><span class="n">Loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryLocation</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">LocationSize</span><span class="o">::</span><span class="n">unknown</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">Loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemoryLocation</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">MemoryLocation</span><span class="o">::</span><span class="n">UnknownSize</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">originalCalls</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CI</span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">CI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">CI</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">isMemFreeLibMFunction</span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                        </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__fd_sincos_1&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">isModOrRefSet</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">.</span><span class="n">getModRefInfo</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span><span class="w"> </span><span class="n">Loc</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; cannot shadow-inline global &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="w"></span>
<span class="w">                             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; due to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">endCheck</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="nl">endCheck</span><span class="p">:;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">seen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">allocaTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">allocaTy</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerAddressSpace</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipa&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule1</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">)));</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">antialloca</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">M</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                                       </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                                       </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">Align</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">((</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">width</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                     </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule2</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="p">(</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getTargetTriple</span><span class="p">()).</span><span class="n">getArch</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">AMDGPU</span><span class="o">::</span><span class="n">HSAMD</span><span class="o">::</span><span class="n">AddressSpaceQualifier</span><span class="o">::</span><span class="n">Local</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">AddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">nvptx</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">nvptx64</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">AddrSpace</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;warning found shared memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">//#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO this needs initialization by entry</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isConstant</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getLinkage</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_shadow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getThreadLocalMode</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isExternallyInitialized</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">MDTuple</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="p">{</span><span class="n">ConstantAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="p">)}));</span><span class="w"></span>
<span class="w">        </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_internalshadowglobal&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">MDTuple</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="p">{}));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setUnnamedAddr</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getUnnamedAddr</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Create global variable locally if not externally visible</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasInternalLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasPrivateLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasExternalLinkage</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">hasInitializer</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">elemTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getShadowType</span><span class="p">(</span><span class="n">elemTy</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getInitializer</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getInitializer</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                         </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="cm">/*nullShadow*/</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">                                        </span><span class="o">:</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">type</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">*</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">elemTy</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isConstant</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getLinkage</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_shadow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getThreadLocalMode</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isExternallyInitialized</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">MDTuple</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="p">{</span><span class="n">ConstantAsMetadata</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="p">)}));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">setUnnamedAddr</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getUnnamedAddr</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot compute with global variable that doesn&#39;t have &quot;</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;marked shadow global&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;cannot compute with global variable that doesn&#39;t &quot;</span><span class="w"></span>
<span class="w">                         </span><span class="s">&quot;have marked shadow global&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">md</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot compute with global variable that doesn&#39;t have &quot;</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;marked shadow global&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;cannot compute with global variable that doesn&#39;t &quot;</span><span class="w"></span>
<span class="w">                         </span><span class="s">&quot;have marked shadow global (metadata incorrect type)&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">md2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">MDTuple</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">gvemd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">md2</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gvemd</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">agg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 8</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">elem</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">cs</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="p">{</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getInt32</span><span class="p">(</span><span class="n">i</span><span class="p">)});</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getInt32</span><span class="p">(</span><span class="n">i</span><span class="p">)});</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">agg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span><span class="w"> </span><span class="n">elem</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">i</span><span class="p">});</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">agg</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">agg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">cs</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">GetOrCreateShadowFunction</span><span class="p">(</span><span class="n">Logic</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">,</span><span class="w"> </span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">arr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">shadow</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">ArrayType</span><span class="w"> </span><span class="o">*</span><span class="n">arrTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">width</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantArray</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">arrTy</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">invertOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">shadowTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getDestTy</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">invertOp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCast</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">invertOp</span><span class="p">,</span><span class="w"> </span><span class="n">shadowTy</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipc&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">shadowTy</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">invertOp</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isCast</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFunctionTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantExpr</span><span class="o">::</span><span class="n">getCast</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCast</span><span class="p">((</span><span class="n">Instruction</span><span class="o">::</span><span class="n">CastOps</span><span class="p">)</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipc&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">GetElementPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">C</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NewOps</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">NewOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getWithOperands</span><span class="p">(</span><span class="n">NewOps</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">invertargs</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">invertargs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">invertargs</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="c1">// TODO mark this the same inbounds as the original</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">invertargs</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">invertargs</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;unhandled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ExtractValueInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipev&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">InsertValueInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getIndices</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipiv&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ExtractElementInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getVectorOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getIndexOperand</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                     </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipee&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">InsertElementInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">op2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipie&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ShuffleVectorInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getShuffleMaskForBitcode</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipsv&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipsv&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip0</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SelectInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getTrueValue</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getFalseValue</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipse&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getPointerOperandType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipl&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipl&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setVolatile</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setOrdering</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOrdering</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">setSyncScopeID</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getSyncScopeID</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">li</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">li</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FAdd</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">val0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">val0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateBinOp</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">val0</span><span class="p">,</span><span class="w"> </span><span class="n">val1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">BI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">li</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">BI</span><span class="o">-&gt;</span><span class="n">copyIRFlags</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">li</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">val0</span><span class="p">,</span><span class="w"> </span><span class="n">val1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">li</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">invertargs</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getNumIndices</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">invertargs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">invertargs</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">invertargs</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">gep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">shadow</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">setIsInBounds</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">isInBounds</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shadow</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">asize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getArraySize</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAllocatedType</span><span class="p">(),</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerAddressSpace</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">asize</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ipa&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">        </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">)));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">asize</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">isOne</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">StoreInst</span><span class="w"> </span><span class="o">*</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAllocatedType</span><span class="p">()),</span><span class="w"> </span><span class="n">antialloca</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO handle alloca of size &gt; 1</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rule2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">antialloca</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">antialloca</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">asize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">          </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                           </span><span class="n">M</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAllocatedType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                               </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">oval</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">antialloca</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                           </span><span class="n">Align</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">rule2</span><span class="p">,</span><span class="w"> </span><span class="n">antialloca</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">antialloca</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">dumpMap</span><span class="p">(</span><span class="n">invertedPointers</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal iv of phi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"> </span><span class="n">mapped</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">mapped</span><span class="p">[</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="n">i</span><span class="p">)].</span><span class="n">insert</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mapped</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">     else if (false &amp;&amp; mapped.size() == 2) {</span>
<span class="c">         IRBuilder &lt;&gt; bb(phi);</span>
<span class="c">         auto which = bb.CreatePHI(Type::getInt1Ty(phi-&gt;getContext()), phi-&gt;getNumIncomingValues());</span>
<span class="c">         //TODO this is not recursive</span>

<span class="c">         int cnt = 0;</span>
<span class="c">         Value* vals[2];</span>
<span class="c">         for(auto v : mapped) {</span>
<span class="c">            assert( cnt &lt;= 1 );</span>
<span class="c">            vals[cnt] = v.first;</span>
<span class="c">            for (auto b : v.second) {</span>
<span class="c">                which-&gt;addIncoming(ConstantInt::get(which-&gt;getType(), cnt), b);</span>
<span class="c">            }</span>
<span class="c">            ++cnt;</span>
<span class="c">         }</span>
<span class="c">         auto result = BuilderM.CreateSelect(which, invertPointerM(vals[1], BuilderM), invertPointerM(vals[0], BuilderM));</span>
<span class="c">         return result;</span>
<span class="c">     }</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">NewV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">NewV</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Note if the original phi node get&#39;s scev&#39;d in NewF, it may</span>
<span class="w">      </span><span class="c1">// no longer be a phi and we need a new place to insert this phi</span>
<span class="w">      </span><span class="c1">// Note that if scev&#39;d this can still be a phi with 0 incoming indicating</span>
<span class="w">      </span><span class="c1">// an unnecessary value to be replaced</span>
<span class="w">      </span><span class="c1">// TODO consider allowing the inverted pointer to become a scev</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">NewV</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">NewV</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">bb</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">bb</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">shadowTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getShadowType</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">which</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">shadowTy</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">oval</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="p">)));</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getNumIncomingValues</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pre</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">pre</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">which</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">))));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">which</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="nl">end</span><span class="p">:;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">oval</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CustomErrorHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">str</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">raw_string_ostream</span><span class="w"> </span><span class="n">ss</span><span class="p">(</span><span class="n">str</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot find shadow for &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">CustomErrorHandler</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">wrap</span><span class="p">(</span><span class="n">oval</span><span class="p">),</span><span class="w"> </span><span class="n">ErrorType</span><span class="o">::</span><span class="n">NoShadow</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fn:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">oval=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oval</span><span class="w"></span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; icv=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">oval</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;available inversion for &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; of &quot;</span><span class="w"></span>
<span class="w">                 </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot find deal with ptr that isnt arg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;cannot find deal with ptr that isnt arg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">GradientUtils::lookupM</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="o">&amp;</span><span class="n">incoming_available</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="kt">bool</span><span class="w"> </span><span class="n">tryLegalRecomputeCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">MetadataAsValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">InlineAsm</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inversionAllocs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">reduceRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EnzymeRegisterReduce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">II</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_f</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">reduceRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="p">(</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getTargetTriple</span><span class="p">()).</span><span class="n">getArch</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">AMDGPU</span><span class="o">::</span><span class="n">HSAMD</span><span class="o">::</span><span class="n">AddressSpaceQualifier</span><span class="o">::</span><span class="n">Local</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">reduceRegister</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">tryLegalRecomputeCheck</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                          </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">LI</span><span class="p">,</span><span class="w"> </span><span class="n">incoming_available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                          </span><span class="n">shouldRecompute</span><span class="p">(</span><span class="n">LI</span><span class="p">,</span><span class="w"> </span><span class="n">incoming_available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">mayReadOrWriteMemory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">reduceRegister</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">tryLegalRecomputeCheck</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">incoming_available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">shouldRecompute</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">incoming_available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="n">reduceRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reduceRegister</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">use</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">use</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;didn&#39;t dominate inst: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  point: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">bb: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// allowed from block domination</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;didn&#39;t dominate inst: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">bb: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// This is a reverse block</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Something in the entry (or anything that dominates all returns, doesn&#39;t</span>
<span class="w">      </span><span class="c1">// need caching)</span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;insertBlock: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;instP: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;inst: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// TODO upgrade this to be all returns that this could enter from</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BlocksDominatingAllReturns</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">forwardBlock</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">originalForReverseBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">forwardBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Don&#39;t allow this if we&#39;re not definitely using the last iteration of</span>
<span class="w">        </span><span class="c1">// this value</span>
<span class="w">        </span><span class="c1">//   + either because the value isn&#39;t in a loop</span>
<span class="w">        </span><span class="c1">//   + or because the forward of the block usage location isn&#39;t in a</span>
<span class="w">        </span><span class="c1">//   loop (thus last iteration)</span>
<span class="w">        </span><span class="c1">//   + or because the loop nests share no ancestry</span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">loopLegal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">             </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">getParentLoop</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">fdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">forwardBlock</span><span class="p">);</span><span class="w"> </span><span class="n">fdx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="n">fdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdx</span><span class="o">-&gt;</span><span class="n">getParentLoop</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">fdx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">loopLegal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopLegal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">      </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">erase</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">available</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">incoming_available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">available</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">forwardPass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardPass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inversionAllocs</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">forwardPass</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">forwardPass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalForReverseBlock</span><span class="p">(</span><span class="o">*</span><span class="n">forwardPass</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">forwardPass</span><span class="p">,</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">LoopContext</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lc</span><span class="p">;;</span><span class="w"> </span><span class="n">getContext</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">(),</span><span class="w"> </span><span class="n">idx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">available</span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">available</span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">antivaralloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">available</span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">idx</span><span class="p">.</span><span class="n">var</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">available</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">inst</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// If requesting loop bound and not available from index per above</span>
<span class="w">  </span><span class="c1">// we must be requesting the total size. Rather than generating</span>
<span class="w">  </span><span class="c1">// a new lcssa variable, use the existing loop exact bound var</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getContext</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">phi</span><span class="o">-&gt;</span><span class="n">incoming_values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getContext</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">var</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">loopVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loopVar</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Must be in a reverse pass fashion for a lookup to index bound to be</span>
<span class="w">        </span><span class="c1">// legal</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">lc</span><span class="p">.</span><span class="n">preheader</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="cm">/*forwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">getDynamicLoopLimit</span><span class="p">(</span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                 </span><span class="cm">/*isi1*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">prelcssaInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&lt;badref&gt;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixLCSSA</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">UndefValue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; inst &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Update index and caching per lcssa</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">      </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()].</span><span class="n">erase</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// TODO consider call as part of</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">lrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tryLegalRecomputeCheck</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">lrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shouldRecompute</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptSingleUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">load_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">new_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">MDNode</span><span class="w"> </span><span class="o">*</span><span class="n">invgroup</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">load_op</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invgroup</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">invgroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MDNode</span><span class="o">::</span><span class="n">getDistinct</span><span class="p">(</span><span class="n">load_op</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">              </span><span class="n">load_op</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">,</span><span class="w"> </span><span class="n">invgroup</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">new_op</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">,</span><span class="w"> </span><span class="n">invgroup</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reduceRegister</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">op</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">prelcssaInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">origInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">liobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">liobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">orig_liobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">orig_liobj</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"></span>
<span class="w">                              </span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">li2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">li2obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">li2</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">li2obj</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="n">li2</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">liobj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">li2obj</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">li2</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">orig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">li2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig2</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="c1">// llvm::errs() &lt;&lt; &quot;found potential candidate loads: oli:&quot;</span>
<span class="w">              </span><span class="c1">//             &lt;&lt; *origInst &lt;&lt; &quot; oli2: &quot; &lt;&lt; *orig2 &lt;&lt; &quot;\n&quot;;</span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">scev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">scev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">li2</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="c1">// llvm::errs() &lt;&lt; &quot; scev1: &quot; &lt;&lt; *scev1 &lt;&lt; &quot; scev2: &quot; &lt;&lt; *scev2</span>
<span class="w">              </span><span class="c1">//             &lt;&lt; &quot;\n&quot;;</span>

<span class="w">              </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="n">orig2</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"> </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="c1">// llvm::errs() &lt;&lt; &quot;FAILED: &quot; &lt;&lt; *I &lt;&lt; &quot;\n&quot;;</span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVAddRecExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scev1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVAddRecExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scev2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">SE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">SE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                          </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">SE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l1</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">getContext</span><span class="p">(</span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">(),</span><span class="w"> </span><span class="n">l1</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l2</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">getContext</span><span class="p">(</span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">(),</span><span class="w"> </span><span class="n">l2</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">dynamic</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">l2</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// TODO IF len(ar2) &gt;= len(ar1) then we can replace li with</span>
<span class="w">                    </span><span class="c1">// li2</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">l2</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="c1">// llvm::errs()</span>
<span class="w">                      </span><span class="c1">//    &lt;&lt; &quot; step1: &quot; &lt;&lt; *ar1-&gt;getStepRecurrence(SE)</span>
<span class="w">                      </span><span class="c1">//    &lt;&lt; &quot; step2: &quot; &lt;&lt; *ar2-&gt;getStepRecurrence(SE) &lt;&lt;</span>
<span class="w">                      </span><span class="c1">//    &quot;\n&quot;;</span>

<span class="w">                      </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li2</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">scev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="p">(</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getTargetTriple</span><span class="p">()).</span><span class="n">getArch</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SharedAddrSpace</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Triple</span><span class="o">::</span><span class="n">amdgcn</span><span class="w"></span>
<span class="w">                </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">AMDGPU</span><span class="o">::</span><span class="n">HSAMD</span><span class="o">::</span><span class="n">AddressSpaceQualifier</span><span class="o">::</span><span class="n">Local</span><span class="w"></span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EnzymeSharedForward</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">scev1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_liobj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                </span><span class="n">SharedAddrSpace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">resultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">newavail</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">newavail</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">allDomPredecessorsOf</span><span class="p">(</span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="n">OrigDT</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">pred</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// auto NewSI = cast&lt;StoreInst&gt;(getNewFromOriginal(SI));</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">si2obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">si2obj</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">si2obj</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">orig_liobj</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">lastStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">interveningSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">potentialAlias</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">potentialAlias</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">())</span><span class="w"></span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="n">potentialAlias</span><span class="p">))</span><span class="w"></span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">II</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">potentialAlias</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                          </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_s_barrier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">interveningSync</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                            </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">II</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">II</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">allUnsyncdPredecessorsOf</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">II</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">())</span><span class="w"></span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SI</span><span class="p">)</span><span class="w"></span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                        </span><span class="n">mid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                              </span><span class="p">}</span><span class="w"></span>
<span class="w">                              </span><span class="n">lastStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                              </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="p">},</span><span class="w"></span>
<span class="w">                            </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                              </span><span class="c1">// if gone past entry</span>
<span class="w">                              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="n">lastStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                              </span><span class="p">}</span><span class="w"></span>
<span class="w">                            </span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lastStore</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">else</span><span class="w"></span>
<span class="w">                          </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="n">lastStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">});</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lastStore</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">scev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scev1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scev2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVAddRecExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scev2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVAddRecExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scev1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">OrigSE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                          </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getCouldNotCompute</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">OrigSE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                          </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">OrigSE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l1</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">getContext</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">()),</span><span class="w"></span>
<span class="w">                               </span><span class="n">l1</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l2</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">getContext</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">()),</span><span class="w"></span>
<span class="w">                               </span><span class="n">l2</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">l1</span><span class="p">.</span><span class="n">dynamic</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">l2</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="c1">// TODO IF len(ar2) &gt;= len(ar1) then we can replace li</span>
<span class="w">                      </span><span class="c1">// with li2</span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">trueLimit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">l2</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">L1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">L1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">L1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ar2</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">())</span><span class="w"></span>
<span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="n">L1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L1</span><span class="o">-&gt;</span><span class="n">getParentLoop</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="n">newavail</span><span class="p">[</span><span class="n">l2</span><span class="p">.</span><span class="n">var</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">l1</span><span class="p">.</span><span class="n">var</span><span class="p">];</span><span class="w"></span>
<span class="w">                        </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sval</span><span class="p">))</span><span class="w"></span>
<span class="w">                  </span><span class="n">sval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span><span class="w"></span>
<span class="w">                  </span><span class="n">lval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">sgep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">lgep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sgep</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">lgep</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">svals</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sgep</span><span class="o">-&gt;</span><span class="n">indices</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="w"></span>
<span class="w">                          </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">svals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">q</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lvals</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lgep</span><span class="o">-&gt;</span><span class="n">indices</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="w"></span>
<span class="w">                          </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">lvals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">q</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">ThreadLookup</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">svals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">auto</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">auto</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">lvals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">                            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">ls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getZeroExtendExpr</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">                            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">ls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigSE</span><span class="p">.</span><span class="n">getTruncateExpr</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ls</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ss</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">II</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntrinsicInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getIntrinsicID</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_read_ptx_sreg_tid_x</span><span class="o">:</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_read_ptx_sreg_tid_y</span><span class="o">:</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_read_ptx_sreg_tid_z</span><span class="o">:</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_workitem_id_x</span><span class="o">:</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_workitem_id_y</span><span class="o">:</span><span class="w"></span>
<span class="w">                            </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_workitem_id_z</span><span class="o">:</span><span class="w"></span>
<span class="w">                              </span><span class="n">ThreadLookup</span><span class="p">[</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">II</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                  </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                      </span><span class="n">lookupM</span><span class="p">(</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">lvals</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"></span>
<span class="w">                                              </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">II</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">                              </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="w">                          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">newavail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                                 </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                          </span><span class="n">ThreadLookup</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recomp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">()),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">ThreadLookup</span><span class="p">,</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrap</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*scope*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*permitCache*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recomp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">resultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recomp</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legal</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">});</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultValue</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">resultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">resultValue</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">resultValue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">loadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                           </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                           </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                           </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                           </span><span class="p">.</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                       </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                      </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// this is guarded because havent told cacheForReverse how to move</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">isVolatile</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">EnzymeLoopInvariantCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">liobj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_liobj</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">AT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ArrayType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">AI</span><span class="o">-&gt;</span><span class="n">getAllocatedType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GEP</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GEP</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l1</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">getContext</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">l1</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>

<span class="w">                  </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l1</span><span class="p">.</span><span class="n">preheader</span><span class="p">;</span><span class="w"></span>

<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">origPH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast_or_null</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">origPH</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigPDT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">origPH</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>

<span class="w">                  </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">origTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origPH</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">origTerm</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">origTerm</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">origTerm</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">OB</span><span class="p">(</span><span class="n">origTerm</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*</span><span class="n">tmpload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OB</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">AT</span><span class="p">,</span><span class="w"> </span><span class="n">orig_liobj</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&#39;tmpload&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">origTerm</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                            </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="n">tmpload</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">});</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">tmpload</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getLoopPreheader</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">nctx</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">origPH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast_or_null</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">nctx</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">origPH</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigPDT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">origPH</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">origTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origPH</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">origTerm</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                              </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                   </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="n">tmpload</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                   </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                          </span><span class="p">}</span><span class="w"></span>
<span class="w">                          </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nctx</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>

<span class="w">                  </span><span class="n">tmpload</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>

<span class="w">                  </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="kt">bool</span><span class="w"> </span><span class="n">isi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">                  </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="kt">bool</span><span class="w"> </span><span class="n">forceSingleIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">getContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">forceSingleIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">forceSingleIter</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">liobj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// if freeing reverseblocks must exist</span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">AT</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                </span><span class="cm">/*allocate*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">AI</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">)));</span><span class="w"></span>

<span class="w">                    </span><span class="n">v</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">                    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">outer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCachePointer</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="cm">/*inForwardPass*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="cm">/*storeinstorecache*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                        </span><span class="cm">/*extraSize*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>

<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">ld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">AT</span><span class="p">,</span><span class="w"> </span><span class="n">AI</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AI</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                      </span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">AI</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                      </span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">AI</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">cache</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span><span class="w"> </span><span class="n">outer</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">bsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                                     </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                                     </span><span class="p">.</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="n">AT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                                 </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bsize</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">bsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                      </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">bsize</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                      </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">bsize</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">cache</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">st</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>

<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">outer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCachePointer</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*inForwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*storeinstorecache*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*extraSize*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idxs</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GEP</span><span class="o">-&gt;</span><span class="n">indices</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">idxs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lookupM</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">tryLegalRecomputeCheck</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">cptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">outer</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">outer</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">cptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateGEP</span><span class="p">(</span><span class="n">outer</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setIsInBounds</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="c1">// Retrieve the actual result</span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadFromCachePointer</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">cptr</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>

<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">scev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SE</span><span class="p">.</span><span class="n">getSCEV</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Store in memcpy opt</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVAddRecExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scev1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SCEVConstant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStepRecurrence</span><span class="p">(</span><span class="n">SE</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">step</span><span class="o">-&gt;</span><span class="n">getAPInt</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">loadSize</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">l1</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">getContext</span><span class="p">(</span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">(),</span><span class="w"> </span><span class="n">l1</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">dynamic</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">l1</span><span class="p">.</span><span class="n">var</span><span class="p">];</span><span class="w"></span>
<span class="w">              </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l1</span><span class="p">.</span><span class="n">preheader</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">origPH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast_or_null</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">origPH</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigPDT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">origPH</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="w">              </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">lim</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">toErase</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">                </span><span class="n">SCEVExpander</span><span class="w"> </span><span class="n">Exp</span><span class="p">(</span><span class="n">SE</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                 </span><span class="s">&quot;enzyme&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">fake</span><span class="o">::</span><span class="n">SCEVExpander</span><span class="w"> </span><span class="n">Exp</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">SE</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;enzyme&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="n">Exp</span><span class="p">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="n">l1</span><span class="p">.</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">start0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exp</span><span class="p">.</span><span class="n">expandCodeFor</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">ar1</span><span class="o">-&gt;</span><span class="n">getStart</span><span class="p">(),</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">start0</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">start0</span><span class="p">};</span><span class="w"></span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">todo</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">todo</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getNumUses</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">Exp</span><span class="p">.</span><span class="n">isInsertedInstruction</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">todo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                      </span><span class="n">toErase</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">toErase</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">erase</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">origTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origPH</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>

<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">origTerm</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"> </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">noSpeedCache</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctx</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lim</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">firstLim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lim</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">firstStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getLoopPreheader</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">nctx</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">origPH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast_or_null</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">nctx</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">origPH</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigPDT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">origPH</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">origTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">origPH</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">allInstructionsBetween</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">origTerm</span><span class="p">,</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">writesToMemoryReadBy</span><span class="p">(</span><span class="n">OrigAA</span><span class="p">,</span><span class="w"> </span><span class="cm">/*maybeReader*/</span><span class="w"> </span><span class="n">origInst</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="cm">/*maybeWriter*/</span><span class="w"> </span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="cm">/*earlyBreak*/</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">nv</span><span class="p">(</span><span class="n">nctx</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">firstLim</span><span class="p">,</span><span class="w"> </span><span class="n">nv</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nlim</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unwrapM</span><span class="p">(</span><span class="n">firstStart</span><span class="p">,</span><span class="w"> </span><span class="n">nv</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">AttemptFullUnwrapWithLookup</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nstart</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlim</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nstart</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nctx</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">isi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">forceSingleIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">getContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">forceSingleIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lim</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">forceSingleIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">forceSingleIter</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// if freeing reverseblocks must exist</span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="cm">/*allocate*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*extraSize*/</span><span class="w"> </span><span class="n">lim</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">)));</span><span class="w"></span>

<span class="w">              </span><span class="n">v</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">outer</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">getCachePointer</span><span class="p">(</span><span class="cm">/*inForwardPass*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="cm">/*storeinstorecache*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                  </span><span class="cm">/*extraSize*/</span><span class="w"> </span><span class="n">lim</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">outer</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">outer</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">cache</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dst_arg</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">src_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">start</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">start</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">v</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">lim</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">loadSize</span><span class="p">),</span><span class="w"> </span><span class="n">lim</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">len_arg</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">cache</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">src_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">src_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                             </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">memcpyF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                       </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memcpy</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">memcpyF</span><span class="p">,</span><span class="w"> </span><span class="n">nargs</span><span class="p">));</span><span class="w"></span>

<span class="w">              </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">bsize</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                  </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bsize</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">bsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="w"></span>
<span class="w">                                         </span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">Align</span><span class="p">(</span><span class="n">bsize</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="w"></span>
<span class="w">                                         </span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">bsize</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">              </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="w"></span>
<span class="w">                                       </span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getAlign</span><span class="p">().</span><span class="n">getValue</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">li</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">              </span><span class="n">scopeInstructions</span><span class="p">[</span><span class="n">cache</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="cm">/*isForwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="cm">/*extraSize*/</span><span class="w"> </span><span class="n">lim</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;Uncacheable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">newFunc</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Caching instruction &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="s">&quot; legalRecompute: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lrc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; shouldRecompute: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="s">&quot; tryLegalRecomputeCheck: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tryLegalRecomputeCheck</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nl">noSpeedCache</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;Uncacheable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">newFunc</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;Caching instruction &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; legalRecompute: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lrc</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot; shouldRecompute: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot; tryLegalRecomputeCheck: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tryLegalRecomputeCheck</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">origInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rematerializableAllocations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">origInst</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">rematerializableAllocations</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">origInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">origInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">origInst</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// If not caching whole allocation and rematerializing the allocation</span>
<span class="w">        </span><span class="c1">// within the loop, force an entry-level scope so there is no need</span>
<span class="w">        </span><span class="c1">// to cache.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cacheWholeAllocation</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getEntryBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pinst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">pinst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getEntryBlock</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Prevent the phi node from being stored into the cache by creating</span>
<span class="w">            </span><span class="c1">// it before the ensureLookupCached.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopeMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">scopeMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">scope</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">insert_or_assign</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*&amp;</span><span class="p">)</span><span class="n">inst</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">AssertingVH</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">LimitContext</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">lctx</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">ensureLookupCached</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">isi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findInMap</span><span class="p">(</span><span class="n">scopeMap</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="cm">/*isForwardPass*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LI2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">LI2</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="o">*</span><span class="n">LI1</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;result: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;inst: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;val: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">lookup_cache</span><span class="p">[</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()][</span><span class="n">val</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//! Given a map of edges we could have taken to desired target, compute a value</span>
<span class="c1">//! that determines which target should be branched to</span>
<span class="c1">//  This function attempts to determine an equivalent condition from earlier in</span>
<span class="c1">//  the code and use that if possible, falling back to creating a phi node of</span>
<span class="c1">//  which edge was taken if necessary This function can be used in two ways:</span>
<span class="c1">//   * If replacePHIs is null (usual case), this function does the branch</span>
<span class="c1">//   * If replacePHIs isn&#39;t null, do not perform the branch and instead replace</span>
<span class="c1">//   the PHI&#39;s with the derived condition as to whether we should branch to a</span>
<span class="c1">//   particular target</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">GradientUtils::branchToCorrespondingTarget</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;&gt;</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">targetToPreds</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getTrue</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Map of function edges to list of targets this can branch to we have</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">done</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">Q</span><span class="p">;</span><span class="w"> </span><span class="c1">// newblock, target</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pred_edge</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">pred_edge</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">             </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="cm">/*pred*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="cm">/*successor*/</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"></span>
<span class="w">             </span><span class="n">trace</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="n">Q</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Q</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">count</span><span class="p">(</span><span class="n">target</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If this block dominates the context, don&#39;t go back up as any</span>
<span class="w">      </span><span class="c1">// predecessors won&#39;t contain the conditions.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">blockLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">block</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">Pred</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Don&#39;t go up the backedge as we can use the last value if desired via</span>
<span class="w">        </span><span class="c1">// lcssa</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockLoop</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">blockLoop</span><span class="o">-&gt;</span><span class="n">getHeader</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">blockLoop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">Pred</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Pred</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">),</span><span class="w"> </span><span class="n">target</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">IntegerType</span><span class="w"> </span><span class="o">*</span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">?</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt1Ty</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getContext</span><span class="p">())</span><span class="w"></span>
<span class="w">                       </span><span class="o">:</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">equivalentTerminator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// llvm::errs() &lt;&lt; &quot;\n\n&lt;DONE = &quot; &lt;&lt; ctx-&gt;getName() &lt;&lt; &quot;&gt;\n&quot;;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">blocks</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot; edge  (&quot; &lt;&lt; edge.first-&gt;getName() &lt;&lt; &quot;, &quot;</span>
<span class="w">    </span><span class="c1">//             &lt;&lt; edge.second-&gt;getName() &lt;&lt; &quot;) : [&quot;;</span>
<span class="w">    </span><span class="c1">// for (auto s : pair.second)</span>
<span class="w">    </span><span class="c1">//  llvm::errs() &lt;&lt; s-&gt;getName() &lt;&lt; &quot;,&quot;;</span>
<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot;]\n&quot;;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// llvm::errs() &lt;&lt; &quot;&lt;/DONE&gt;\n&quot;;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Try `block` as a potential first split point.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// The original split block must not have a parent with an edge</span>
<span class="w">        </span><span class="c1">// to a block other than to itself, which can reach any targets.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// For all successors and thus edges (block, succ):</span>
<span class="w">        </span><span class="c1">// 1) Ensure that no successors have overlapping potential</span>
<span class="w">        </span><span class="c1">// destinations (a list of destinations previously seen is in</span>
<span class="w">        </span><span class="c1">// foundtargets).</span>
<span class="w">        </span><span class="c1">// 2) The block branches to all 3 destinations (foundTargets==3)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 3) The unique target split off from the others is stored in</span>
<span class="w">        </span><span class="c1">//   uniqueTarget.</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Only handle cases where the split was due to a conditional</span>
<span class="w">        </span><span class="c1">// branch. This branch, `bi`, splits off uniqueTargets[0] from</span>
<span class="w">        </span><span class="c1">// the remainder of foundTargets.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">bi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bi1</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Find a second block `subblock` which splits the two merged</span>
<span class="w">          </span><span class="c1">// targets from each other.</span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">subblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="c1">// The second split block must not have a parent with an edge</span>
<span class="w">              </span><span class="c1">// to a block other than to itself, which can reach any of its two</span>
<span class="w">              </span><span class="c1">// targets.</span>
<span class="w">              </span><span class="c1">// TODO verify this</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">block2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">P</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block2</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                          </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="w">              </span><span class="c1">// Again, a successful split must have unique targets.</span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">seen2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Since there are only two targets, a successful split</span>
<span class="w">                </span><span class="c1">// condition has only 1 target per successor of block2.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="c1">// block2 has non-unique targets.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen2</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">seen2</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="n">seen2</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="c1">// block2 has a target which is not part of the two needing</span>
<span class="w">                  </span><span class="c1">// to be split. The two needing to be split is equal to</span>
<span class="w">                  </span><span class="c1">//    foundtargets-uniqueTargets.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">uniqueTargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="c1">// If we didn&#39;t find two valid successors, continue.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seen2</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// llvm::errs() &lt;&lt; &quot; -- failed from not 2 seen\n&quot;;</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">nextblock</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">subblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="nl">nextblock</span><span class="p">:;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="c1">// If no split block was found, try again.</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subblock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="c1">// This branch, `bi2`, splits off the two blocks in</span>
<span class="w">          </span><span class="c1">// (foundTargets-uniqueTargets) from each other.</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">bi2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">subblock</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bi2</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">rnextpair</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Condition cond1 splits off uniqueTargets[0] from</span>
<span class="w">          </span><span class="c1">// the remainder of foundTargets.</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cond1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Condition cond2 splits off the two blocks in</span>
<span class="w">          </span><span class="c1">// (foundTargets-uniqueTargets) from each other.</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cond2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">staging</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;staging&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">stagingIfNeeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">staging</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span><span class="w"> </span><span class="n">stagingIfNeeded</span><span class="p">(</span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                                  </span><span class="n">stagingIfNeeded</span><span class="p">(</span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">staging</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">cond2</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">subblock</span><span class="p">,</span><span class="w"> </span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">))].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">subblock</span><span class="p">,</span><span class="w"> </span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">))].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">otherBranch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cond1</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;anot1_&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">bi1</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="k">else</span><span class="w"></span>
<span class="w">                    </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">otherBranch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">subblock</span><span class="p">,</span><span class="w"> </span><span class="n">bi2</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cond2</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bnot1_&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateAnd</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">otherBranch</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="s">&quot;andVal&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="w">                  </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nl">rnextpair</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">forwardBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">forwardBlock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">forwardBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalForReverseBlock</span><span class="p">(</span><span class="o">*</span><span class="n">forwardBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// The original split block must not have a parent with an edge</span>
<span class="w">      </span><span class="c1">// to a block other than to itself, which can reach any targets.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">predecessors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">P</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">succ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">successors</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">succ</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">foundtargets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">target</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundtargets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">nextpair</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardBlock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">DT</span><span class="p">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">forwardBlock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">equivalentTerminator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fast</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nl">nextpair</span><span class="p">:;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">goto</span><span class="w"> </span><span class="n">nofast</span><span class="p">;</span><span class="w"></span>

<span class="nl">fast</span><span class="p">:;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">equivalentTerminator</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newFunc : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;blk : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">lookupM</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">))].</span><span class="n">begin</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">))].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">))].</span><span class="n">begin</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                   </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">branch</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="n">begin</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">branch</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown successor for replacephi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">si</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">SwitchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">equivalentTerminator</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pbuilder</span><span class="p">(</span><span class="n">equivalentTerminator</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pbuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SwitchInst</span><span class="w"> </span><span class="o">*</span><span class="n">swtch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSwitch</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">lookupM</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getDefaultDest</span><span class="p">())].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">switchcase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">si</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">swtch</span><span class="o">-&gt;</span><span class="n">addCase</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">switchcase</span><span class="p">.</span><span class="n">getCaseValue</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">switchcase</span><span class="p">.</span><span class="n">getCaseSuccessor</span><span class="p">())]</span><span class="w"></span>
<span class="w">                 </span><span class="p">.</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">replacePHIs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">si</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">              </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">getCaseSuccessor</span><span class="p">())].</span><span class="n">begin</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">getCaseValue</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cas</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                 </span><span class="o">*</span><span class="n">done</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getDefaultDest</span><span class="p">())].</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupM</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">(),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">cas</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// default case</span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">switchcase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">si</span><span class="o">-&gt;</span><span class="n">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateOr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">switchcase</span><span class="p">.</span><span class="n">getCaseValue</span><span class="p">(),</span><span class="w"> </span><span class="n">phi</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;unknown equivalent terminator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">equivalentTerminator</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown equivalent terminator&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="nl">nofast</span><span class="p">:;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// if freeing reverseblocks must exist</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">LimitContext</span><span class="w"> </span><span class="n">lctx</span><span class="p">(</span><span class="cm">/*ReverseLimit*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createCacheForScope</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/*shouldFree*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">targets</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="cm">/*storingblock*/</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="cm">/*target*/</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="cm">/*predecessors*/</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">        </span><span class="n">storing</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">targetToPreds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pred</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">storing</span><span class="p">[</span><span class="n">pred</span><span class="p">.</span><span class="n">first</span><span class="p">][</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">)].</span><span class="n">push_back</span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">targets</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">++</span><span class="n">idx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">storing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pbuilder</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">pbuilder</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">pbuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tostore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">tostore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;multi exit edges not supported&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// for(auto targpair : pair.second) {</span>
<span class="w">        </span><span class="c1">//     tostore = pbuilder.CreateOr(tostore, pred);</span>
<span class="w">        </span><span class="c1">//}</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">storeInstructionInCache</span><span class="p">(</span><span class="n">lctx</span><span class="p">,</span><span class="w"> </span><span class="n">pbuilder</span><span class="p">,</span><span class="w"> </span><span class="n">tostore</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">isi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getBitWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">which</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupValueFromCache</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="cm">/*forwardPass*/</span><span class="w"> </span><span class="n">isOriginalBlock</span><span class="p">(</span><span class="o">*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()),</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">LimitContext</span><span class="p">(</span><span class="cm">/*reversePass*/</span><span class="w"> </span><span class="n">reverseBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">),</span><span class="w"> </span><span class="n">cache</span><span class="p">,</span><span class="w"> </span><span class="n">isi1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="cm">/*available*/</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">which</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">which</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replacePHIs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetToPreds</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">BranchInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">which</span><span class="p">,</span><span class="w"> </span><span class="cm">/*true*/</span><span class="w"> </span><span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="cm">/*false*/</span><span class="w"> </span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">swit</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateSwitch</span><span class="p">(</span><span class="n">which</span><span class="p">,</span><span class="w"> </span><span class="n">targets</span><span class="p">.</span><span class="n">back</span><span class="p">(),</span><span class="w"> </span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">swit</span><span class="o">-&gt;</span><span class="n">addCase</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">replacePHIs</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">which</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">which</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">which</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">BuilderM</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderM</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">GradientUtils::computeMinCache</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">TypeResults</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TR</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">guaranteedUnreachable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EnzymeMinCutCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Recomputes</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FullSeen</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OneLevelSeen</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">Available</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"> </span><span class="n">LoopAvail</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">guaranteedUnreachable</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OrigLI</span><span class="p">.</span><span class="n">isLoopHeader</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PN</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Increment</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PN</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">BO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">PN</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">B</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Add</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                         </span><span class="n">invariant</span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                         </span><span class="n">invariant</span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">Increment</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Sub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="n">invariant</span><span class="p">(</span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">Increment</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">LoopAvail</span><span class="p">[</span><span class="n">L</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">PN</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Increment</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">LoopAvail</span><span class="p">[</span><span class="n">L</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">CI</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isAllocationFunction</span><span class="p">(</span><span class="o">*</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">TLI</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">Available</span><span class="p">[</span><span class="n">CI</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NewLoopBoundReq</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">LoopBoundRequirements</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">context</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">loopContexts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="n">context</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">maxLimit</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">trueLimit</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">LoopBoundRequirements</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">LoopBoundRequirements</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoopBoundRequirements</span><span class="p">.</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">LoopBoundRequirements</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NewLoopBoundReq</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Seen</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Seen</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isOriginal</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">NewLoopBoundReq</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">val</span><span class="o">-&gt;</span><span class="n">operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">LoopBoundRequirements</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NewLoopBoundReq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">OneLevelSeen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">FullSeen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">minCutMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">oldFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">guaranteedUnreachable</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">Available2</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Available</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">Available2</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BB</span><span class="p">);</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getParentLoop</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LoopAvail</span><span class="p">[</span><span class="n">L</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Available2</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalRecompute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Available2</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">minCutMode</span><span class="p">,</span><span class="w"> </span><span class="n">FullSeen</span><span class="p">,</span><span class="w"> </span><span class="n">guaranteedUnreachable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">oneneed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                      </span><span class="cm">/*OneLevel*/</span><span class="w"> </span><span class="nb">true</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">minCutMode</span><span class="p">,</span><span class="w"> </span><span class="n">OneLevelSeen</span><span class="p">,</span><span class="w"> </span><span class="n">guaranteedUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oneneed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="o">&amp;</span><span class="n">I</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">              </span><span class="n">Recomputes</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Intermediates</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Required</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Intermediates</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Required</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">todo</span><span class="p">(</span><span class="n">Recomputes</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">Recomputes</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">todo</span><span class="p">.</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">todo</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">minCutMode</span><span class="p">,</span><span class="w"> </span><span class="n">FullSeen</span><span class="p">,</span><span class="w"> </span><span class="n">guaranteedUnreachable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Recomputes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">Available2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Available</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">Available2</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Loop</span><span class="w"> </span><span class="o">*</span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">             </span><span class="n">L</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L</span><span class="o">-&gt;</span><span class="n">getParentLoop</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LoopAvail</span><span class="p">[</span><span class="n">L</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Available2</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Available2</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// if not legal to recompute, we would&#39;ve already explicitly marked</span>
<span class="w">          </span><span class="c1">// this for caching if it was needed in reverse pass</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">Intermediates</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="cm">/*OneLevel*/</span><span class="w"> </span><span class="nb">true</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">minCutMode</span><span class="p">,</span><span class="w"> </span><span class="n">OneLevelSeen</span><span class="p">,</span><span class="w"> </span><span class="n">guaranteedUnreachable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Required</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">V2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">V</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">Inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V2</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rematerializableAllocations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">Inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MinReq</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">minCut</span><span class="p">(</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="n">OrigLI</span><span class="p">,</span><span class="w"> </span><span class="n">Recomputes</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="n">Intermediates</span><span class="p">,</span><span class="w"> </span><span class="n">Required</span><span class="p">,</span><span class="w"> </span><span class="n">MinReq</span><span class="p">,</span><span class="w"> </span><span class="n">rematerializableAllocations</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NeedGraph</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MinReq</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">NeedGraph</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Required</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">todo</span><span class="p">.</span><span class="n">front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">todo</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NeedGraph</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">NeedGraph</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">V2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">I</span><span class="o">-&gt;</span><span class="n">operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V2</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">todo</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Intermediates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">V</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">MinReq</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">NeedGraph</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">V</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">InvertedPointerVH::deleted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">dumpPointers</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">**</span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;erasing something in invertedPointers map&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">SubTransferHelper</span><span class="p">(</span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">intrinsic</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstalign</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcalign</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="kt">bool</span><span class="w"> </span><span class="n">dstConstant</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_dst</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">srcConstant</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_src</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isVolatile</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">MTI</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">allowForward</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="kt">bool</span><span class="w"> </span><span class="n">shadowsLookedUp</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO offset</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secretty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// no change to forward pass if represents floats</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If the src is constant simply zero d_dst and don&#39;t propagate to d_src</span>
<span class="w">      </span><span class="c1">// (which thus == src and may be illegal)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srcConstant</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Don&#39;t zero in forward mode.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">shadowsLookedUp</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">shadow_dst</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">shadow_dst</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &lt;= 6</span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                             </span><span class="n">max</span><span class="p">(</span><span class="mi">1U</span><span class="p">,</span><span class="w"> </span><span class="n">dstalign</span><span class="p">)),</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memsetIntr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">memsetIntr</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">memsetIntr</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dstalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                             </span><span class="n">Align</span><span class="p">(</span><span class="n">dstalign</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">dstalign</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">shadowsLookedUp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">?</span><span class="w"> </span><span class="n">shadow_dst</span><span class="w"></span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">shadow_dst</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstaddr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">shadowsLookedUp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">?</span><span class="w"> </span><span class="n">shadow_src</span><span class="w"></span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">shadow_src</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcaddr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">srcaddr</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">dalign</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dstalign</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">dalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="n">dstalign</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">salign</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srcalign</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">salign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="n">srcalign</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dstalign</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">salign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcalign</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intrinsic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memmove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMemMove</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">dalign</span><span class="p">,</span><span class="w"> </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">salign</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMemCpy</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">dalign</span><span class="p">,</span><span class="w"> </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">salign</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]{</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">srcaddr</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateUDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">length</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"></span>
<span class="w">                                           </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                                           </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                                           </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                                           </span><span class="p">.</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="n">secretty</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                                       </span><span class="mi">8</span><span class="p">))};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dmemcpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">intrinsic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memcpy</span><span class="p">)</span><span class="w"></span>
<span class="w">                              </span><span class="o">?</span><span class="w"> </span><span class="n">getOrInsertDifferentialFloatMemcpy</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="n">getOrInsertDifferentialFloatMemmove</span><span class="p">)(</span><span class="w"></span>
<span class="w">              </span><span class="o">*</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">dstalign</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">srcalign</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">,</span><span class="w"> </span><span class="n">srcaddr</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">dmemcpy</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// if represents pointer or integer type then only need to modify forward</span>
<span class="w">    </span><span class="c1">// pass with the copy</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">allowForward</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                          </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">shadowsLookedUp</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// It is questionable how the following case would even occur, but if</span>
<span class="w">      </span><span class="c1">// the dst is constant, we shouldn&#39;t do anything extra</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dstConstant</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MTI</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If src is inactive, then we should copy from the regular pointer</span>
<span class="w">      </span><span class="c1">// (i.e. suppose we are copying constant memory representing dimensions</span>
<span class="w">      </span><span class="c1">// into a tensor)</span>
<span class="w">      </span><span class="c1">//  to ensure that the differential tensor is well formed for use</span>
<span class="w">      </span><span class="c1">//  OUTSIDE the derivative generation (as enzyme doesn&#39;t need this), we</span>
<span class="w">      </span><span class="c1">//  should also perform the copy onto the differential. Future</span>
<span class="w">      </span><span class="c1">//  Optimization (not implemented): If dst can never escape Enzyme code,</span>
<span class="w">      </span><span class="c1">//  we may omit this copy.</span>
<span class="w">      </span><span class="c1">// no need to update pointers, even if dst is active</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shadow_dst</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shadow_src</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dsto</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">srco</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">length</span><span class="p">,</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &lt;= 6</span>
<span class="w">        </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                         </span><span class="n">max</span><span class="p">(</span><span class="mi">1U</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">srcalign</span><span class="p">,</span><span class="w"> </span><span class="n">dstalign</span><span class="p">))),</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">isVolatile</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="c1">//#if LLVM_VERSION_MAJOR &gt;= 7</span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                     </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">      </span><span class="c1">//#else</span>
<span class="w">      </span><span class="c1">// Type *tys[] = {args[0]-&gt;getType(), args[1]-&gt;getType(),</span>
<span class="w">      </span><span class="c1">// args[2]-&gt;getType(), args[3]-&gt;getType()}; #endif</span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">memtransIntr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">intrinsic</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">memtransIntr</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">memtransIntr</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dstalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">Align</span><span class="p">(</span><span class="n">dstalign</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">dstalign</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srcalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">Align</span><span class="p">(</span><span class="n">srcalign</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithAlignment</span><span class="p">(</span><span class="n">MTI</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">srcalign</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright Enzyme.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/EnzymeAD/enzyme_sphinx_theme">theme</a> provided by <a href="https://enzyme.mit.edu">Enzyme</a>.
      </div>
      <br>
     

</footer>

          </div>
        </div>

        <div class="enzyme-content-right" id="enzyme-content-right">
          <div class="enzyme-right-menu" id="enzyme-right-menu">
            <div class="enzyme-side-scroll" id="enzyme-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Program Listing for File GradientUtils.cpp</a></li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
         <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <footer class="site-footer" id="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://enzyme.mit.edu" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://enzyme.mit.edu">Enzyme</a></li>
            <li><a href="https://enzyme.mit.edu/get-started">Get Started</a></li>
            <li><a href="https://enzyme.mit.edu/features">Features</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Resources</a></li>
            <li><a href="https://enzyme.mit.edu/tutorials">Tutorials</a></li>
            <li><a href="https://enzyme.mit.edu/docs/stable/index.html">Docs</a></li>
            <li><a href="" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/issues" target="_blank">Github Issues</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://groups.google.com/d/forum/enzyme-dev"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <a href="">Ecosystem</a>
          </li>

          <li>
            <a href="">Mobile</a>
          </li>

          <li>
            <a href="">PyTorch Hub</a>
          </li>

          <li>
            <a href="">Blog</a>
          </li>

          <li>
            <a href="https://enzyme.mit.edu/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://enzyme.mit.edu/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="">torchaudio</a>
            </li>

            <li>
              <a href="">torchtext</a>
            </li>

            <li>
              <a href="">torchvision</a>
            </li>

            <li>
              <a href="">TorchElastic</a>
            </li>

            <li>
              <a href="">TorchServe</a>
            </li>

            <li>
              <a href="">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="">Developer Resources</a>
            </li>

            <li>
              <a href="https://enzyme.mit.edu/features">About</a>
            </li>

            <li>
              <a href="">Models (Beta)</a>
            </li>

            <li>
              <a href="">Community</a>
            </li>

            <li>
              <a href="">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      enzymeAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.enzyme-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>