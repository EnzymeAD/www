


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File AdjointGenerator.h &mdash; Enzyme Sphinx Theme 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Languages
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://enzyme.mit.edu/docs/stable/index.html">
                  <span class="dropdown-title">Julia</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="">
                  <span class="dropdown-title">Rust</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://enzyme.mit.edu/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about Enzyme’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community</span>
                  <p>Join the Enzyme developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Developer documentation, templates and tools </p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss Enzyme code, issues, install.</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="enzyme-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="enzyme-left-menu" id="enzyme-left-menu">
      <div class="enzyme-side-scroll">
        <div class="enzyme-menu enzyme-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="enzyme-left-menu-search">
            

            
              
              
                <div class="version">
                  0.0.1
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../starting/ad_intro_using_enzyme.html">Introduction to Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/compiler_based_ad.html">The Stages of Compiler-based Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/installation.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starting/multi_source_ad.html">AD of Multi-Source Programs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/cpp/">C/C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/fortran/">Fortran</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/julia/">Julia</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/rust/">Rust</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enzyme.mit.edu/swift/">Swift</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../calling_convention.html">Calling Convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting_and_tips.html">Troubleshooting and Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Applications and Code Examples of Enzyme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talks_and_tutorials.html">Talks and Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced_options.html">Advanced options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/cuda_guide.html">CUDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/mpi_guide.html">MPI-Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/openmp_guide.html">OpenMP Directives and Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/rocm_guide.html">ROCm</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="enzyme-container">
      <div class="enzyme-page-level-bar" id="enzyme-page-level-bar">
        <div class="enzyme-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="enzyme-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Program Listing for File AdjointGenerator.h</li>
    
    
      <li class="enzyme-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_AdjointGenerator.h.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="enzyme-shortcuts-wrapper" id="enzyme-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="enzyme-content-wrap" class="enzyme-content-wrap">
        <div class="enzyme-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="enzyme-article" class="enzyme-article">
              
  <section id="program-listing-for-file-adjointgenerator-h">
<span id="program-listing-file-adjointgenerator-h"></span><h1>Program Listing for File AdjointGenerator.h<a class="headerlink" href="#program-listing-for-file-adjointgenerator-h" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_AdjointGenerator.h.html#file-adjointgenerator-h"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">AdjointGenerator.h</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//===- AdjointGenerator.h - Implementation of Adjoint&#39;s of instructions --===//</span>
<span class="c1">//</span>
<span class="c1">//                             Enzyme Project</span>
<span class="c1">//</span>
<span class="c1">// Part of the Enzyme Project, under the Apache License v2.0 with LLVM</span>
<span class="c1">// Exceptions. See https://llvm.org/LICENSE.txt for license information.</span>
<span class="c1">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span>
<span class="c1">//</span>
<span class="c1">// If using this code in an academic setting, please cite the following:</span>
<span class="c1">// @incollection{enzymeNeurips,</span>
<span class="c1">// title = {Instead of Rewriting Foreign Code for Machine Learning,</span>
<span class="c1">//          Automatically Synthesize Fast Gradients},</span>
<span class="c1">// author = {Moses, William S. and Churavy, Valentin},</span>
<span class="c1">// booktitle = {Advances in Neural Information Processing Systems 33},</span>
<span class="c1">// year = {2020},</span>
<span class="c1">// note = {To appear in},</span>
<span class="c1">// }</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains an instruction visitor AdjointGenerator that generates</span>
<span class="c1">// the corresponding augmented forward pass code, and adjoints for all</span>
<span class="c1">// LLVM instructions.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/ADT/ArrayRef.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/ADT/SmallVector.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Analysis/ValueTracking.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/Constants.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/DerivedTypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/IR/Value.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Transforms/Utils/BasicBlockUtils.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;llvm/Transforms/Utils/Cloning.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DifferentialUseAnalysis.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EnzymeLogic.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;FunctionUtils.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GradientUtils.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LibraryFuncs.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TypeAnalysis/TBAA.h&quot;</span><span class="cp"></span>

<span class="cp">#define DEBUG_TYPE &quot;enzyme&quot;</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">llvm</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Helper instruction visitor that generates adjoints</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">AugmentedReturnType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">AdjointGenerator</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">InstVisitor</span><span class="o">&lt;</span><span class="n">AdjointGenerator</span><span class="o">&lt;</span><span class="n">AugmentedReturnType</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Type of code being generated (forward, reverse, or both)</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">Mode</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">gutils</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_args</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">retType</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">TypeResults</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TR</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getIndex</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">      </span><span class="n">uncacheable_args_map</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">returnuses</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">AugmentedReturnType</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">ReturnInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">StoreInst</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">replacedReturns</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryValues</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryInstructions</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryStores</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldUnreachable</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">dretAlloca</span><span class="p">;</span><span class="w"></span>

<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">AdjointGenerator</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">constant_args</span><span class="p">,</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">retType</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">TypeResults</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TR</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="w">          </span><span class="n">uncacheable_args_map</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">returnuses</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">AugmentedReturnType</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">ReturnInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">StoreInst</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">replacedReturns</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryValues</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryInstructions</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unnecessaryStores</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">SmallPtrSetImpl</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldUnreachable</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">dretAlloca</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">Mode</span><span class="p">(</span><span class="n">Mode</span><span class="p">),</span><span class="w"> </span><span class="n">gutils</span><span class="p">(</span><span class="n">gutils</span><span class="p">),</span><span class="w"> </span><span class="n">constant_args</span><span class="p">(</span><span class="n">constant_args</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">retType</span><span class="p">(</span><span class="n">retType</span><span class="p">),</span><span class="w"> </span><span class="n">TR</span><span class="p">(</span><span class="n">TR</span><span class="p">),</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">getIndex</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">uncacheable_args_map</span><span class="p">(</span><span class="n">uncacheable_args_map</span><span class="p">),</span><span class="w"> </span><span class="n">returnuses</span><span class="p">(</span><span class="n">returnuses</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">augmentedReturn</span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">),</span><span class="w"> </span><span class="n">replacedReturns</span><span class="p">(</span><span class="n">replacedReturns</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">unnecessaryValues</span><span class="p">(</span><span class="n">unnecessaryValues</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">unnecessaryInstructions</span><span class="p">(</span><span class="n">unnecessaryInstructions</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">unnecessaryStores</span><span class="p">(</span><span class="n">unnecessaryStores</span><span class="p">),</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">(</span><span class="n">oldUnreachable</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">dretAlloca</span><span class="p">(</span><span class="n">dretAlloca</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">TR</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">analysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;inf: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;gutils-&gt;oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;in: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">erased</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">eraseIfUnused</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">erase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">unnecessaryInstructions</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">unnecessaryInstructions</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">used</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// if decided to cache a value, preserve it here for later</span>
<span class="w">      </span><span class="c1">// replacement in EnzymeLogic</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">iload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">((</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">used</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">check</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isTokenTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iload</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iload</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_replacementA&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">fictiousPHIs</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">iload</span><span class="p">,</span><span class="w"> </span><span class="n">pn</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">erased</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">erase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iload</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">DT</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">intType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">DT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">DT</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">DT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantExpr</span><span class="w"> </span><span class="o">*</span><span class="n">CE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CE</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ompi_mpi_double&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ompi_mpi_float&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">pargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                     </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">intType</span><span class="p">)};</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">pargs</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">).</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">DT</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pargs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">pargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">AttributeList</span><span class="w"> </span><span class="n">AL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">ArgMemOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if LLVM_VERSION_MAJOR &lt; 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">ArgMemOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">DT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">B</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;MPI_Type_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// To be double-checked against the functionality needed and the respective</span>
<span class="w">  </span><span class="c1">// implementation in Adjoint-MPI</span>
<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">MPI_COMM_RANK</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">rankTy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">pargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">rankTy</span><span class="p">)};</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">rankTy</span><span class="p">,</span><span class="w"> </span><span class="n">pargs</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">).</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">rankTy</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AttributeList</span><span class="w"> </span><span class="n">AL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;MPI_Comm_rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">rankTy</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">rankTy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">pargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">rankTy</span><span class="p">)};</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">rankTy</span><span class="p">,</span><span class="w"> </span><span class="n">pargs</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">).</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">rankTy</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AttributeList</span><span class="w"> </span><span class="n">AL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addParamAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoUnwind</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoFree</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">NoSync</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">AL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AL</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AttrKind</span><span class="o">::</span><span class="n">WillReturn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;MPI_Comm_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">rankTy</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitFreezeInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">FreezeInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFreeze</span><span class="p">(</span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">               </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op0</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateFreeze</span><span class="p">(</span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitInstruction</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO explicitly handle all instructions rather than using the catch all</span>
<span class="w">    </span><span class="c1">// below</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">FPMO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FPMathOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FPMO</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FNeg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FPMO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">FPMO</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">FPMO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">FPMO</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">dif1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">Builder2</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">FPMO</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;in Mode: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">to_string</span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle unknown instruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unknown value&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitAllocaInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitICmpInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ICmpInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitFCmpInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">FCmpInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitLoadLike</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">alignment</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">OrigOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitLoadLike</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">alignment</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">OrigOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                     </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_maskInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">can_modref_map</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">can_modref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="nb">false</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">can_modref_map</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">constantval</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">newi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">//! Store inverted pointer loads that need to be cached for use in reverse</span>
<span class="w">    </span><span class="c1">//! pass</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">newi</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// TODO: In the case of fwd mode this should be true if the loaded value</span>
<span class="w">        </span><span class="c1">// itself is used as a pointer.</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">needShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"></span>
<span class="w">                              </span><span class="o">?</span><span class="w"> </span><span class="nb">false</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">needShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">newip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">can_modref</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">oldUnreachable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">newip</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">newip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">newip</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">needShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// only make shadow where caching needed</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">can_modref</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">placeholder</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">newip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">newip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">newip</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newi</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">//! Store loads that need to be cached for use in reverse pass</span>

<span class="w">    </span><span class="c1">// Only cache value here if caching decision isn&#39;t precomputed.</span>
<span class="w">    </span><span class="c1">// Otherwise caching will be done inside EnzymeLogic.cpp at</span>
<span class="w">    </span><span class="c1">// the end of the function jointly.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">can_modref</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// we can pre initialize all the knownRecomputeHeuristic values to false</span>
<span class="w">      </span><span class="c1">// (not needing) as we may assume that minCutCache already preserves</span>
<span class="w">      </span><span class="c1">// everything it requires.</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primalNeededInReverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newi</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newi</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newi</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nonmarkedglobals_inactiveloads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Assume that non enzyme_shadow globals are inactive</span>
<span class="w">      </span><span class="c1">//  If we ever store to a global variable, we will error if it doesn&#39;t</span>
<span class="w">      </span><span class="c1">//  have a shadow This allows functions who only read global memory to</span>
<span class="w">      </span><span class="c1">//  have their derivative computed Note that this is too aggressive for</span>
<span class="w">      </span><span class="c1">//  general programs as if the global aliases with an argument something</span>
<span class="w">      </span><span class="c1">//  that is written to, then we will have a logical error</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_shadow&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Only propagate if instruction is active. The value can be active and not</span>
<span class="w">    </span><span class="c1">// the instruction if the value is a potential pointer. This may not be</span>
<span class="w">    </span><span class="c1">// caught by type analysis is the result does not have a known type.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">isfloat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">()</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isfloat</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">type</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">LoadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DL</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ConcreteType</span><span class="w"> </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Unknown</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OrigOffset</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">LoadSize</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vd</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">isfloat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vd</span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">isfloat</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">.</span><span class="n">intType</span><span class="p">(</span><span class="n">LoadSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errIfNotFound*/</span><span class="w"> </span><span class="o">!</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isfloat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">LI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">LI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alignment</span><span class="p">)</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                  </span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="o">*</span><span class="n">alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">LI</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_maskInit</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">masked_load</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">alignv</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                     </span><span class="n">alignment</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">alignment</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">alignv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">alignv</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">mi</span><span class="p">};</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">mi</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">prediff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">addToInvertedPtrDiffe</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="p">,</span><span class="w"> </span><span class="n">OrigOffset</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">mask</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_maskInit</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_maskInit</span><span class="p">,</span><span class="w"> </span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">isfloat</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateNot</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitLoadInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">LoadInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If a load of an omp init argument, don&#39;t cache for reverse</span>
<span class="w">    </span><span class="c1">// and don&#39;t do any adjoint propagation (assumed integral)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">U</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4u&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8u&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">LI</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getAlign</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LI</span><span class="p">.</span><span class="n">getAlignment</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseTBAA</span><span class="p">(</span><span class="n">LI</span><span class="p">,</span><span class="w"> </span><span class="n">DL</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isIntegral</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">visitLoadLike</span><span class="p">(</span><span class="n">LI</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="p">,</span><span class="w"> </span><span class="n">constantval</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">LI</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitAtomicRMWInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">AtomicRMWInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">TR</span><span class="p">.</span><span class="n">dump</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;oldFunc: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;I: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitStoreInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">StoreInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// If a store of an omp init argument, don&#39;t delete in reverse</span>
<span class="w">    </span><span class="c1">// and don&#39;t do any adjoint propagation (assumed integral)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getPointerOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">U</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4u&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8u&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getAlign</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getAlignment</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">visitCommonStore</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getPointerOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getValueOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">SI</span><span class="p">.</span><span class="n">isVolatile</span><span class="p">(),</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOrdering</span><span class="p">(),</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getSyncScopeID</span><span class="p">(),</span><span class="w"></span>
<span class="w">                     </span><span class="cm">/*mask=*/</span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitCommonStore</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_val</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">AtomicOrdering</span><span class="w"> </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitCommonStore</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_val</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">AtomicOrdering</span><span class="w"> </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">valType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unnecessaryStores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                       </span><span class="n">parseTBAA</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">DL</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isIntegral</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO allow recognition of other types that could contain pointers [e.g.</span>
<span class="w">    </span><span class="c1">// {void*, void*} or &lt;2 x i64&gt; ]</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">storeSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DL</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">valType</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">//! Storing a floating point value</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp</span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_val</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                   </span><span class="n">valType</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;assuming type as integral for store: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot deduce type of store &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;cannot deduce&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">storeSize</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">//! Only need to update the reverse function</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">setPtrDiffe</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">valType</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"> </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1Ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">dif1Ptr</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">dif1Ptr</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">dif1Ptr</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">              </span><span class="n">dif1</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="o">*</span><span class="n">align</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">dif1</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">align</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="n">dif1</span><span class="o">-&gt;</span><span class="n">setOrdering</span><span class="p">(</span><span class="n">ordering</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dif1</span><span class="o">-&gt;</span><span class="n">setSyncScopeID</span><span class="p">(</span><span class="n">syncScope</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dif1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">valType</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ptr</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                               </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">masked_load</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">alignv</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">align</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">align</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">alignv</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">align</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">alignv</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">valType</span><span class="p">)};</span><span class="w"></span>
<span class="w">            </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">setPtrDiffe</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">valType</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"> </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_val</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">diffeTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">valType</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constantval</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">diffeTy</span><span class="p">)</span><span class="w"></span>
<span class="w">                                  </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_val</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">setPtrDiffe</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">//! Storing an integer or pointer</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">//! Only need to update the forward function</span>

<span class="w">      </span><span class="c1">// Don&#39;t reproduce mpi null requests</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantExpr</span><span class="w"> </span><span class="o">*</span><span class="n">CE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CE</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ompi_request_null&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">           </span><span class="p">(</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">storeBuilder</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constantval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeBuilder</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">i</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">valueop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_val</span><span class="p">,</span><span class="w"> </span><span class="n">storeBuilder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">setPtrDiffe</span><span class="p">(</span><span class="n">orig_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">valueop</span><span class="p">,</span><span class="w"> </span><span class="n">storeBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">ordering</span><span class="p">,</span><span class="w"> </span><span class="n">syncScope</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitGetElementPtrInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">GetElementPtrInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">gep</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitPHINode</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">PHINode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">phi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">oBB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">.</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nBB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">oBB</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">phiBuilder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">phiBuilder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">phiBuilder</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">diffeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">phi</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">newPhi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phiBuilder</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">diffeType</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phi</span><span class="p">.</span><span class="n">getNumIncomingValues</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">.</span><span class="n">getIncomingValue</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">.</span><span class="n">getIncomingBlock</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">newBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">block</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pBuilder</span><span class="p">(</span><span class="n">newBlock</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">pBuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">newPhi</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">diffeType</span><span class="p">),</span><span class="w"> </span><span class="n">newBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">pBuilder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">newPhi</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">newBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">diffeBuilder</span><span class="p">(</span><span class="n">nBB</span><span class="o">-&gt;</span><span class="n">getFirstNonPHI</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">diffeBuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">newPhi</span><span class="p">,</span><span class="w"> </span><span class="n">diffeBuilder</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitCastInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">CastInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CastInst</span><span class="o">::</span><span class="n">CastOps</span><span class="o">::</span><span class="n">PtrToInt</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">               </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">              </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">.</span><span class="n">dump</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CastInst</span><span class="o">::</span><span class="n">CastOps</span><span class="o">::</span><span class="n">FPTrunc</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CastInst</span><span class="o">::</span><span class="n">CastOps</span><span class="o">::</span><span class="n">FPExt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFPCast</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CastInst</span><span class="o">::</span><span class="n">CastOps</span><span class="o">::</span><span class="n">BitCast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CastInst</span><span class="o">::</span><span class="n">CastOps</span><span class="o">::</span><span class="n">Trunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO CHECK THIS</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">trunced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExt</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">trunced</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">.</span><span class="n">dump</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle above cast &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unknown instruction&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">diffTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCast</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">(),</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dop0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dop0</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">diffTy</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitSelectInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">SelectInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">createSelectInstAdjoint</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">createSelectInstDual</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">createSelectInstAdjoint</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">SelectInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO fix all the reverse builders</span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">orig_op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">              </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">             </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Required loopy phi = [in, BO, BO, ..., BO]</span>
<span class="w">    </span><span class="c1">//  1) phi is only used in this B0</span>
<span class="w">    </span><span class="c1">//  2) BO dominates all latches</span>
<span class="w">    </span><span class="c1">//  3) phi == B0 whenever not coming from preheader [implies 2]</span>
<span class="w">    </span><span class="c1">//  4) [optional but done for ease] one exit to make it easier to</span>
<span class="w">    </span><span class="c1">//  calculation the product at that point</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activeUses</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activeUses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ReturnInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">activeUses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activeUses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">activeUses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()),</span><span class="w"></span>
<span class="w">                               </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Latches</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getLoopLatches</span><span class="p">(</span><span class="n">Latches</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">allIncoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">Latch</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Latches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">Latch</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">allIncoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allIncoming</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">addingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addingType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getOrInsertConditionalIndex</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">lc</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">EB</span><span class="p">(</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">EB</span><span class="p">,</span><span class="w"> </span><span class="cm">/*original=*/</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">incvar</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VectorType</span><span class="w"> </span><span class="o">*</span><span class="n">VTy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                        </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">                  </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateVectorSplat</span><span class="p">(</span><span class="n">VTy</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">(),</span><span class="w"> </span><span class="n">inc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateVectorSplat</span><span class="p">(</span><span class="n">VTy</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">(),</span><span class="w"> </span><span class="n">inc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">EB</span><span class="p">),</span><span class="w"> </span><span class="n">inc</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">                </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                   </span><span class="s">&quot;diffe&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op2</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">lookup</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op2</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">          </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;diffe&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">op2</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">addingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addingType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; warning: assuming integral for &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">addingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addingType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op2</span><span class="p">,</span><span class="w"> </span><span class="n">dif2</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; warning: assuming integral for &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">createSelectInstDual</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">SelectInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_cond</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">op1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">op2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">SI</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif2</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">type</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">dif2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitExtractElementInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ExtractElementInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">EEI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EEI</span><span class="p">.</span><span class="n">getVectorOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">vecTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_vec</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">vec_diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_vec</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">vecTy</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_vec</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vec_diffe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">vec_diffe</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getIndexOperand</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">vec_diffe</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EEI</span><span class="p">.</span><span class="n">getVectorOperand</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_vec</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sv</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getIndexOperand</span><span class="p">())};</span><span class="w"></span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="n">EEI</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">               </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">              </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_vec</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">),</span><span class="w"> </span><span class="n">sv</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EEI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">EEI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitInsertElementInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">InsertElementInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">IEI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_inserted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">insertedTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">vectorTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_vector</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_inserted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_inserted</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">insertedTy</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_inserted</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">prediff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_vector</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">vectorTy</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_vector</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_inserted</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">prediff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">diff_inserted</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_index</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dindex</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">IEI</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">diff_inserted</span><span class="p">,</span><span class="w"> </span><span class="n">prediff</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">,</span><span class="w"> </span><span class="n">dindex</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">IEI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">IEI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">size1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">orig_op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                       </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                       </span><span class="n">lookup</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                   </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size0</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op0</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                   </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size1</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IEI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">IEI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitShuffleVectorInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ShuffleVectorInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">SVI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_vector1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_vector2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe_vector1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_vector1</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="n">ConstantVector</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig_vector1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_vector1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe_vector2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_vector2</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="n">ConstantVector</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig_vector2</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_vector2</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe_vector1</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe_vector2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">diffe_vector1</span><span class="p">,</span><span class="w"> </span><span class="n">diffe_vector2</span><span class="p">,</span><span class="w"> </span><span class="n">SVI</span><span class="p">.</span><span class="n">getShuffleMaskForBitcode</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="n">diffe_vector1</span><span class="p">,</span><span class="w"> </span><span class="n">diffe_vector2</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                  </span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">diffe</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">diffe_vector1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">diffe_vector2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">.</span><span class="n">isScalable</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="n">getKnownMinValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">instidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SVI</span><span class="p">.</span><span class="n">getShuffleMask</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">opnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">opidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sv</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">opidx</span><span class="p">)};</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opnum</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opnum</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opnum</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                    </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                   </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">-&gt;</span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opnum</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">loaded</span><span class="p">,</span><span class="w"> </span><span class="n">instidx</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">SVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opnum</span><span class="p">)),</span><span class="w"></span>
<span class="w">                           </span><span class="n">sv</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="o">++</span><span class="n">instidx</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SVI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">SVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitExtractValueInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">ExtractValueInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">EVI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EVI</span><span class="p">.</span><span class="n">getAggregateOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">agg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_aggregate</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe_aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_aggregate</span><span class="p">)</span><span class="w"></span>
<span class="w">                                   </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">agg_type</span><span class="p">)</span><span class="w"></span>
<span class="w">                                   </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_aggregate</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe_aggregate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffe_aggregate</span><span class="p">,</span><span class="w"> </span><span class="n">EVI</span><span class="p">.</span><span class="n">getIndices</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">diffe_aggregate</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EVI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">prediff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// todo const</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sv</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EVI</span><span class="p">.</span><span class="n">getIndices</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">sv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="n">EVI</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">               </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">              </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">-&gt;</span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">sv</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EVI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">EVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitInsertValueInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">InsertValueInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">IVI</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasNonPointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">IVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">hasNonPointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ArrayType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">IVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">at</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hasNonPointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasNonPointer</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">floatingInsertion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">InsertValueInst</span><span class="w"> </span><span class="o">*</span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">intType</span><span class="p">(</span><span class="n">size0</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getInsertedValueOperand</span><span class="p">(),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">isFloat</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">it</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">floatingInsertion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">getAggregateOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">InsertValueInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// unsure where this came from, conservatively assume contains float</span>
<span class="w">        </span><span class="n">floatingInsertion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">floatingInsertion</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO handle pointers</span>
<span class="w">    </span><span class="c1">// TODO type analysis handle structs</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getInsertedValueOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_agg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getAggregateOperand</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">val_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_val</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">agg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_val</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">val_type</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_val</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_agg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_agg</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">agg_type</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_agg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_agg</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">diff_agg</span><span class="p">,</span><span class="w"> </span><span class="n">diff_val</span><span class="p">,</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getIndices</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">diff_agg</span><span class="p">,</span><span class="w"> </span><span class="n">diff_val</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">IVI</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_inserted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getInsertedValueOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_agg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getAggregateOperand</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">size0</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_inserted</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">intType</span><span class="p">(</span><span class="n">size0</span><span class="p">,</span><span class="w"> </span><span class="n">orig_inserted</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errIfFalse*/</span><span class="w"> </span><span class="o">!</span><span class="n">looseTypeAnalysis</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">flt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">isFloat</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">it</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">flt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">flt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">intType</span><span class="p">(</span><span class="n">size0</span><span class="p">,</span><span class="w"> </span><span class="n">orig_inserted</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">prediff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">IVI</span><span class="p">.</span><span class="n">getIndices</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_inserted</span><span class="p">,</span><span class="w"> </span><span class="n">dindex</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">flt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="n">size1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                 </span><span class="n">orig_agg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">             </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">            </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_agg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">prediff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">prediff</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig_inserted</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">IVI</span><span class="p">.</span><span class="n">getIndices</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_agg</span><span class="p">,</span><span class="w"> </span><span class="n">dindex</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size1</span><span class="p">,</span><span class="w"> </span><span class="n">orig_agg</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IVI</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">IVI</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">getReverseBuilder</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">original</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">getForwardBuilder</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="n">GradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">diffe</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">diffe</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Builder</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffe</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setDiffe</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">/// Unwraps a vector derivative from its internal representation and applies a</span>
<span class="w">  </span><span class="c1">/// function f to each element. Return values of f are collected and wrapped.</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">Args</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">diffType</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Args</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">diffType</span><span class="p">,</span><span class="w"> </span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">...);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">/// Unwraps a vector derivative from its internal representation and applies a</span>
<span class="w">  </span><span class="c1">/// function f to each element.</span>
<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Func</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">Args</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">...);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FreeMemory</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SelectInst</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">T</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="cm">/*idxs*/</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lookup</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Builder</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitBinaryOperator</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">BinaryOperator</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">              </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">             </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">TR</span><span class="p">.</span><span class="n">intType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">createBinaryOperatorAdjoint</span><span class="p">(</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">createBinaryOperatorDual</span><span class="p">(</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">createBinaryOperatorAdjoint</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">BinaryOperator</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">addingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FMul</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;m0diffe&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;m1diffe&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orig_op1</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FAdd</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idiff</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idiff</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FSub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idiff</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">idiff</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FDiv</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Required loopy phi = [in, BO, BO, ..., BO]</span>
<span class="w">      </span><span class="c1">//  1) phi is only used in this B0</span>
<span class="w">      </span><span class="c1">//  2) BO dominates all latches</span>
<span class="w">      </span><span class="c1">//  3) phi == B0 whenever not coming from preheader [implies 2]</span>
<span class="w">      </span><span class="c1">//  4) [optional but done for ease] one exit to make it easier to</span>
<span class="w">      </span><span class="c1">//  calculation the product at that point</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">LoopContext</span><span class="w"> </span><span class="n">lc</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activeUses</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">activeUses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ReturnInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">activeUses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activeUses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">activeUses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BO</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()),</span><span class="w"></span>
<span class="w">                               </span><span class="n">lc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Latches</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">OrigLI</span><span class="p">.</span><span class="n">getLoopFor</span><span class="p">(</span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getLoopLatches</span><span class="p">(</span><span class="n">Latches</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">allIncoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">Latch</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Latches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="n">Latch</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">allIncoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allIncoming</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">EB</span><span class="p">(</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">EB</span><span class="p">,</span><span class="w"> </span><span class="cm">/*original=*/</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Pstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P0</span><span class="o">-&gt;</span><span class="n">getIncomingValueForBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getOriginalFromNew</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">preheader</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">Pstart</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lop0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">),</span><span class="w"> </span><span class="n">EB</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lop1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lop0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                    </span><span class="n">lop1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getOrInsertTotalMultiplicativeProduct</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">lc</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">EB</span><span class="p">(</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">exitBlocks</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">EB</span><span class="p">,</span><span class="w"> </span><span class="cm">/*original=*/</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">Pstart</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lop0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">EB</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lop1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lop0</span><span class="p">))),</span><span class="w"></span>
<span class="w">                    </span><span class="n">lop1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;d0diffe&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lop1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lastdiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">lastdiv</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">lop1</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">LShr</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">orig_op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                    </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                   </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">flt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="n">flt</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">bits</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateShl</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">addingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flt</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">And</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If &amp; against 0b10000000000 and a float the result is 0</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isMinValue</span><span class="p">(</span><span class="cm">/*signed*/</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Derivative is zero, no update</span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eFT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-134217728</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Derivative is zero (equivalent to rounding as just chopping off</span>
<span class="w">              </span><span class="c1">// bits of mantissa), no update</span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Xor</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If ^ against 0b10000000000 and a float the result is a float</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isMinValue</span><span class="p">(</span><span class="cm">/*signed*/</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">neg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">bc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">neg</span><span class="p">,</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">bc</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">V</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">eFT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                          </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                      </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementAsAPInt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementAsAPInt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">V</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">eFT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                          </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                      </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Or</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If &amp; against 0b10000000000 and a float the result is a float</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">AP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AP</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">!</span><span class="n">AP</span><span class="p">.</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isFloatTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">AP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mb">0b01111111100000000000000000000000ULL</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                 </span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">AP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="o">~</span><span class="mb">0b0111111111110000000000000000000000000000000000000000000000000000ULL</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateOr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isFloatTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1023ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">52</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">idiff</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                  </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Shl</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Mul</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Sub</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Add</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;warning: binary operator is integer and constant: &quot;</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">BO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// if loose type analysis, assume this integer add is constant</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="nl">def</span><span class="p">:;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; constantarg[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">arg</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">).</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - vals: {&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">knownIntegralValues</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; constantinst[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; val:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">).</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle unknown binary operator: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">BO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unknown binary operator&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nl">done</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dif1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">addingType</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">createBinaryOperatorDual</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">BinaryOperator</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">constantval0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">constantval1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FMul</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff0</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">idiff0</span><span class="p">,</span><span class="w"> </span><span class="n">idiff1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">idiff0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">idiff1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FAdd</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FSub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">dif1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">dif1</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FDiv</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">),</span><span class="w"> </span><span class="n">dif1</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">idiff1</span><span class="p">,</span><span class="w"> </span><span class="n">idiff2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">idiff3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">idiff3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constantval1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">),</span><span class="w"> </span><span class="n">dif1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">idiff3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">idiff3</span><span class="p">,</span><span class="w"> </span><span class="n">idiff4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idiff5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">idiff3</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">idiff5</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">And</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If &amp; against 0b10000000000 and a float the result is 0</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">diffTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isMinValue</span><span class="p">(</span><span class="cm">/*signed*/</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">diffTy</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Derivative is zero, no update</span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eFT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-134217728</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">diffTy</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Derivative is zero (equivalent to rounding as just chopping off</span>
<span class="w">              </span><span class="c1">// bits of mantissa), no update</span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Xor</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">constantval0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                       </span><span class="n">constantval1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If ^ against 0b10000000000 and a float the result is a float</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">isMinValue</span><span class="p">(</span><span class="cm">/*signed*/</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">difi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">neg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">neg</span><span class="p">,</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">difi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">V</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">eFT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                        </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementAsAPInt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">difi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementAsAPInt</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">isMinSignedValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">V</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">eFT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                        </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Instruction</span><span class="o">::</span><span class="n">Or</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">constantval0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                       </span><span class="n">constantval1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">).</span><span class="n">IsAllFloat</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">eFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// If &amp; against 0b10000000000 and a float the result is a float</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantDataVector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getSplatValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">eFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                        </span><span class="n">dl</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">AP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AP</span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">!</span><span class="n">AP</span><span class="p">.</span><span class="n">isNegative</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isFloatTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">AP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mb">0b01111111100000000000000000000000ULL</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                 </span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">AP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="o">~</span><span class="mb">0b0111111111110000000000000000000000000000000000000000000000000000ULL</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">.</span><span class="n">isNullValue</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">validXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validXor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">difi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateOr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">BO</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isFloatTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">assert</span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">isDoubleTy</span><span class="p">());</span><span class="w"></span>
<span class="w">                  </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1023ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">52</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/*NUW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NSW*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">difi</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">)),</span><span class="w"></span>
<span class="w">                    </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">BO</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BO</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">def</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="nl">def</span><span class="p">:;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; constantarg[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">arg</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">).</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; - vals: {&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">knownIntegralValues</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; constantinst[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; val:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; type: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">).</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle unknown binary operator: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">BO</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unknown binary operator&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitMemSetInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">MemSetInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MS</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MS</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MS</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO this should 1) assert that the value being meset is constant</span>
<span class="w">    </span><span class="c1">//                 2) duplicate the memset for the inverted pointer</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MS</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If constant destination then no operation needs doing</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_op1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;couldn&#39;t handle non constant inst in memset to &quot;</span><span class="w"></span>
<span class="w">                      </span><span class="s">&quot;propagate differential to</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">MS</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;non constant in memset&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">         </span><span class="p">(</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MS</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_op0</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">op3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">op3</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">op2</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op2</span><span class="p">,</span><span class="w"> </span><span class="n">op3</span><span class="p">};</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MS</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">                                     </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">copyMetadata</span><span class="p">(</span><span class="n">MS</span><span class="p">,</span><span class="w"> </span><span class="n">MD_ToCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MS</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitMemTransferInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">MemTransferInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 7</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isVolatile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isVolatile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">srcAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getSourceAlign</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dstAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getDestAlign</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">srcAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getSourceAlignment</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">dstAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getDestAlignment</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">visitMemTransferCommon</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getIntrinsicID</span><span class="p">(),</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">,</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">,</span><span class="w"> </span><span class="n">MTI</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                           </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                           </span><span class="n">isVolatile</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitMemTransferCommon</span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">,</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_src</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">new_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isVolatile</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitMemTransferCommon</span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">,</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_src</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">new_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isVolatile</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unnecessaryStores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// copying into nullptr is invalid (not sure why it exists here), but we</span>
<span class="w">    </span><span class="c1">// shouldn&#39;t do it in reverse pass or shadow</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantPointerNull</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">).</span><span class="n">Inner0</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Anything</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ddst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ddst</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">ddst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">ddst</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">ddst</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">dsrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_src</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dsrc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">dsrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">dsrc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dsrc</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ddst</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dsrc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">call</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memmove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMemMove</span><span class="p">(</span><span class="n">ddst</span><span class="p">,</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">,</span><span class="w"> </span><span class="n">dsrc</span><span class="p">,</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMemCpy</span><span class="p">(</span><span class="n">ddst</span><span class="p">,</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">,</span><span class="w"> </span><span class="n">dsrc</span><span class="p">,</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">MTI</span><span class="p">.</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa_struct</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">MTI</span><span class="p">.</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_tbaa_struct</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">MTI</span><span class="p">.</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">LLVMContext</span><span class="o">::</span><span class="n">MD_invariant_group</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">call</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">MTI</span><span class="p">.</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>

<span class="w">      </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">ddst</span><span class="p">,</span><span class="w"> </span><span class="n">dsrc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">new_size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// TODO note that we only handle memcpy/etc of ONE type (aka memcpy of {int,</span>
<span class="w">    </span><span class="c1">// double} not allowed)</span>

<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; *gutils-&gt;oldFunc &lt;&lt; &quot;\n&quot;;</span>
<span class="w">    </span><span class="c1">// TR.dump();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">MTI</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">).</span><span class="n">Data0</span><span class="p">().</span><span class="n">ShiftIndices</span><span class="p">(</span><span class="n">DL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">vd</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig_src</span><span class="p">).</span><span class="n">Data0</span><span class="p">().</span><span class="n">ShiftIndices</span><span class="p">(</span><span class="n">DL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// llvm::errs() &lt;&lt; &quot;MIT: &quot; &lt;&lt; MTI &lt;&lt; &quot;|size: &quot; &lt;&lt; size &lt;&lt; &quot; vd: &quot; &lt;&lt;</span>
<span class="w">    </span><span class="c1">// vd.str() &lt;&lt; &quot;\n&quot;;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vd</span><span class="p">.</span><span class="n">isKnownPastPointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="n">orig_src</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getSrcTy</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">ET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ET</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ST</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">AT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ArrayType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ET</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">ET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AT</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ET</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">ConcreteType</span><span class="p">(</span><span class="n">ET</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">())).</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">known</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ET</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">).</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">known</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ET</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">BaseType</span><span class="o">::</span><span class="n">Integer</span><span class="p">).</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">known</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">gep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">AT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ArrayType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">getSourceElementType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AT</span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">BaseType</span><span class="o">::</span><span class="n">Integer</span><span class="p">).</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">known</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">EmitWarning</span><span class="p">(</span><span class="s">&quot;CannotDeduceType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">MTI</span><span class="p">.</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to deduce type of copy &quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">).</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">known</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">EmitFailure</span><span class="p">(</span><span class="s">&quot;CannotDeduceType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MTI</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;failed to deduce type of copy &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;bad mti&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nl">known</span><span class="p">:;</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">.</span><span class="n">valueOrOne</span><span class="p">().</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">.</span><span class="n">valueOrOne</span><span class="p">().</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dstAlign</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcAlign</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">nextStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vd</span><span class="p">[{</span><span class="mi">-1</span><span class="p">}];</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">Legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">dt</span><span class="p">.</span><span class="n">checkedOrIn</span><span class="p">(</span><span class="n">vd</span><span class="p">[{(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">}],</span><span class="w"> </span><span class="cm">/*PointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">Legal</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">nextStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TR</span><span class="p">.</span><span class="n">dump</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; vd:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vd</span><span class="p">.</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; start:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">start</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; size: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; dt:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">isKnown</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_size</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextStart</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">new_size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">nextStart</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">new_size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">start</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">subdstalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dstalign</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// todo make better alignment calculation</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dstalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">dstalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dstalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">subsrcalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcalign</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">// todo make better alignment calculation</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srcalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">srcalign</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">srcalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">)</span><span class="w"></span>
<span class="w">                              </span><span class="o">?</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">)</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_src</span><span class="p">)</span><span class="w"></span>
<span class="w">                              </span><span class="o">?</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_src</span><span class="p">)</span><span class="w"></span>
<span class="w">                              </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_src</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">SubTransferHelper</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span><span class="n">isFloat</span><span class="p">(),</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">subdstalign</span><span class="p">,</span><span class="w"> </span><span class="n">subsrcalign</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="cm">/*offset*/</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_dst</span><span class="p">),</span><span class="w"> </span><span class="n">shadow_dst</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_src</span><span class="p">),</span><span class="w"> </span><span class="n">shadow_src</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="cm">/*length*/</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="cm">/*volatile*/</span><span class="w"> </span><span class="n">isVolatile</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MTI</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="cm">/*allowForward*/</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="p">,</span><span class="w"> </span><span class="cm">/*shadowsLookedup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="cm">/*backwardsShadow*/</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextStart</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">MTI</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitIntrinsicInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">IntrinsicInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">II</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">II</span><span class="p">.</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">stacksave</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">II</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">II</span><span class="p">.</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">stackrestore</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">II</span><span class="p">.</span><span class="n">getIntrinsicID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">lifetime_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">II</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">(</span><span class="n">II</span><span class="p">.</span><span class="n">getNumOperands</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">II</span><span class="p">.</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">orig_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">II</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">handleAdjointForIntrinsic</span><span class="p">(</span><span class="n">II</span><span class="p">.</span><span class="n">getIntrinsicID</span><span class="p">(),</span><span class="w"> </span><span class="n">II</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">II</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="o">&amp;</span><span class="n">II</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">newCall</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">II</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">II</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">II</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">handleAdjointForIntrinsic</span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">orig_ops</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">Module</span><span class="w"> </span><span class="o">*</span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldu_global_f</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_i</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_p</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ldg_global_f</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="n">visitLoadLike</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="cm">/*Align*/</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()),</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/*constantval*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">visitLoadLike</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="cm">/*Align*/</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">(),</span><span class="w"> </span><span class="cm">/*constantval*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">masked_store</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="n">align0</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">align0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">visitCommonStore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="cm">/*orig_ptr*/</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                       </span><span class="cm">/*orig_val*/</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="cm">/*isVolatile*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">NotAtomic</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">SingleThread</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="cm">/*mask*/</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">masked_load</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="n">align0</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">align0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">constantval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseTBAA</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">DL</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isIntegral</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="n">visitLoadLike</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">constantval</span><span class="p">,</span><span class="w"> </span><span class="cm">/*OrigOffset*/</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/*mask*/</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/*orig_maskInit*/</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_popc</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_and</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_or</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_cta</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_gl</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_sys</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_s_barrier</span><span class="o">:</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">prefetch</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_declare</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_value</span><span class="o">:</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 6</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_label</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_addr</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">lifetime_start</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">assume</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fabs</span><span class="o">:</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &lt; 10</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ps</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ps</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">maxnum</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">minnum</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log2</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log10</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp2</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_ftz_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_d</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">copysign</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">pow</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">powi</span><span class="o">:</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">vector_reduce_fadd</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">vector_reduce_fmul</span><span class="o">:</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">experimental_vector_reduce_v2_fadd</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">experimental_vector_reduce_v2_fmul</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">floor</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ceil</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">trunc</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">rint</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nearbyint</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">round</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sqrt</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_sqrt_rn_d</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fmuladd</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fma</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (augmented) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;(augmented) unknown intrinsic&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_popc</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_and</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0_or</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_barrier0</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">amdgcn_s_barrier</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_cta</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_gl</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_membar_sys</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">assume</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">prefetch</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_declare</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_value</span><span class="o">:</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 6</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_label</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">dbg_addr</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">floor</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ceil</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">trunc</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">rint</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nearbyint</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">round</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Derivative of these is zero and requires no modification</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">vector_reduce_fadd</span><span class="o">:</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">experimental_vector_reduce_v2_fadd</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">und</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantAggregateZero</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">VectorType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">und</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">und</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">und</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateShuffleVector</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertElement</span><span class="p">(</span><span class="n">und</span><span class="p">,</span><span class="w"> </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">und</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">lifetime_start</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">lifetime_end</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">lifetime_end</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_sqrt_rn_d</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sqrt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">SqrtF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">SqrtF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">SqrtF</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SqrtF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">SqrtF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBinOp</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Instruction</span><span class="o">::</span><span class="n">FDiv</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">vdiff</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOEQ</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fabs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &lt; 10</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ps</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">maxnum</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &lt; 10</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ps</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">minnum</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fmuladd</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fma</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log2</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.6931471805599453</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log10</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">vdiff</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">2.302585092994046</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp2</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_ftz_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_d</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tys</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp2</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">tys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ExpF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">ExpF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">ExpF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.6931471805599453</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">copysign</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">CopyF</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">copysign</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CopyF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CopyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">xsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ysign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CopyF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CopyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">ysign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">xsign</span><span class="p">,</span><span class="w"> </span><span class="n">ysign</span><span class="p">),</span><span class="w"> </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">powi</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nop1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">nop1</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">))};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">PowF</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PowF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSIToFP</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">nop1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">nop1</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">dif0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">dif0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">pow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">PowF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PowF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="cm">/*</span>
<span class="cm">          dif0 = Builder2.CreateFMul(</span>
<span class="cm">            Builder2.CreateFMul(vdiff,</span>
<span class="cm">              Builder2.CreateFDiv(lookup(&amp;II), lookup(II.getOperand(0)))),</span>
<span class="cm">          lookup(II.getOperand(1))</span>
<span class="cm">          );</span>
<span class="cm">          */</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                  </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">lookup</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">            </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">            </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdiff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">cal</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">isOverloaded</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 13</span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (reverse) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                             </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (reverse) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (reverse) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;(reverse) unknown intrinsic&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">vector_reduce_fadd</span><span class="o">:</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">experimental_vector_reduce_v2_fadd</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">acctype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">vectype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">accdif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">acctype</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">vecdif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">vectype</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &lt; 12</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">vfra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()});</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">vfra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()});</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">accdif</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vecdif</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">vfra</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">accdif</span><span class="p">,</span><span class="w"> </span><span class="n">vecdif</span><span class="p">});</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">vfra</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">accdif</span><span class="p">,</span><span class="w"> </span><span class="n">vecdif</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_sqrt_rn_d</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sqrt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">SqrtF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">SqrtF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">SqrtF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SqrtF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">SqrtF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">half</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">),</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOEQ</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType</span><span class="p">),</span><span class="w"></span>
<span class="w">                                       </span><span class="n">dif0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fabs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">                                     </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">ty</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">),</span><span class="w"></span>
<span class="w">                                                </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">select</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &lt; 10</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_max_ps</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">maxnum</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType0</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType1</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">diffe1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">diffe1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &lt; 10</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ss</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">x86_sse_min_ps</span><span class="o">:</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">minnum</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFCmpOLT</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType0</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType1</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">diffe1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">diffe0</span><span class="p">,</span><span class="w"> </span><span class="n">diffe1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fmuladd</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">fma</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">opType2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType1</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">opType2</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">dif2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                           </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">op2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">dif2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">origOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">origOp</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log2</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.6931471805599453</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">origOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">origOp</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">mul</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log10</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">2.302585092994046</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">origOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">origOp</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">mul</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp2</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_ftz_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_f</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">nvvm_ex2_approx_d</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])};</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tys</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp2</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">tys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ExpF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">ExpF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">ExpF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.6931471805599453</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">dif0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">copysign</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">CopyF</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">copysign</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CopyF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CopyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">xsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ysign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">])};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CopyF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CopyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">ysign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cal</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">xsign</span><span class="p">,</span><span class="w"> </span><span class="n">ysign</span><span class="p">),</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">powi</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">op0</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">op1</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">))};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">PowF</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PowF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cast</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSIToFP</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">op0</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">op1</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">),</span><span class="w"> </span><span class="n">cast</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">pow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">PowF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">PowF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PowF</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">op0Ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getShadowType</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">op0Ty</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">powcall1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">powcall1</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">powcall1</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">powcall1</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dfdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">dfdx</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">powcall</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">PowF</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">}));</span><span class="w"></span>
<span class="w">          </span><span class="n">powcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">CI</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">powcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">logcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="n">op0</span><span class="p">});</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">powcall</span><span class="p">,</span><span class="w"> </span><span class="n">logcall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dfdy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">dfdy</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">isOverloaded</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 13</span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (forward) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                             </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (forward) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cannot handle (forward) unknown intrinsic</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getName</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">I</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;(forward) unknown intrinsic&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitOMPCall</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">kmpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledFunction</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; + &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uncacheable_args</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;could not derive underlying task from omp call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"></span>
<span class="w">                   </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;could not derive underlying task from omp call&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;could not derive underlying task contents from omp call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"></span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;could not derive underlying task contents from omp call&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// bool modifyPrimal = true;</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">foreignFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pre_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argsInverted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">postCreate</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">userReplace</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OutTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OutFPTypes</span><span class="p">;</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="n">pre_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">argi</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">argType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">at</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constant_args</span><span class="p">[</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getArgNo</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">pre_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Note sometimes whattype mistakenly says something should be constant</span>
<span class="w">        </span><span class="c1">// [because composed of integer pointers alone]</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isFloat</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">OutTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">OutFPTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">argType</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">augmentcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Value *cachereplace = nullptr;</span>

<span class="w">    </span><span class="c1">// TODO consider reduction of int 0 args</span>
<span class="w">    </span><span class="n">FnTypeInfo</span><span class="w"> </span><span class="nf">nextTypeInfo</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">intseen</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">TypeTree</span><span class="w"> </span><span class="n">IntPtr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">IntPtr</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Integer</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">IntPtr</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="n">BaseType</span><span class="o">::</span><span class="n">Pointer</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">argnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argnum</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">nextTypeInfo</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">TypeTree</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">IntPtr</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">nextTypeInfo</span><span class="p">.</span><span class="n">KnownValues</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">}));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">nextTypeInfo</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">TypeTree</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">argnum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">))));</span><span class="w"></span>
<span class="w">          </span><span class="n">nextTypeInfo</span><span class="p">.</span><span class="n">KnownValues</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">.</span><span class="n">knownIntegralValues</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">argnum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">))));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="o">++</span><span class="n">argnum</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">nextTypeInfo</span><span class="p">.</span><span class="n">Return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// llvm::Optional&lt;std::map&lt;std::pair&lt;Instruction*, std::string&gt;, unsigned&gt;&gt;</span>
<span class="w">    </span><span class="c1">// sub_index_map;</span>
<span class="w">    </span><span class="c1">// Optional&lt;int&gt; tapeIdx;</span>
<span class="w">    </span><span class="c1">// Optional&lt;int&gt; returnIdx;</span>
<span class="w">    </span><span class="c1">// Optional&lt;int&gt; differetIdx;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*</span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateAugmentedPrimal</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">),</span><span class="w"> </span><span class="n">subretType</span><span class="p">,</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">interprocedural</span><span class="p">,</span><span class="w"> </span><span class="cm">/*return is used*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*shadowReturnUsed*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">nextTypeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*AtomicAdd*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*OpenMP*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">subaugmentations</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"></span>
<span class="w">                   </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">insert_or_assign2</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">*</span><span class="n">subaugmentations</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">VMap</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CloneFunction</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">VMap</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">tapeArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">ssize_t</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;&gt;</span><span class="w"> </span><span class="n">geps</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gepsToErase</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">gep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GetElementPtrInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">idx_begin</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">idx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">cidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">getNumIndices</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">SmallPtrSet</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">storesToErase</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">st</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">storesToErase</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">geps</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">cidx</span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">(),</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">storesToErase</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">gepsToErase</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gep</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">gepsToErase</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">SI</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">geps</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;unknown tape user: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;unknown tape user&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown tape user&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">gep</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gepsToErase</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">gep</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ph</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getEntryBlock</span><span class="p">().</span><span class="n">begin</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">available</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">subarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">arg_begin</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">subarg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">subarg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">available</span><span class="p">[</span><span class="o">&amp;*</span><span class="n">subarg</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">subarg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">geps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unwrapM</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">available</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">replacement</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">alloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">uload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">replacement</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unwrappedLoads</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">uload</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">replacement</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ucast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unwrappedLoads</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ucast</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">alloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Store cached values</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;malloc&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">subdata</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="o">-&gt;</span><span class="n">tapeIndiciesToFree</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                       </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                      </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                       </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">)};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">                  </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">ph</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                </span><span class="n">tapeArg</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"></span>
<span class="w">                                       </span><span class="o">:</span><span class="w"> </span><span class="n">ph</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">tapeArg</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">alloc</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">)};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">ph</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">tapeArg</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">Idxs</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">ph</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">tapeArg</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">)));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">pre_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">numargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">pre_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">pre_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numargs</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pre_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">kmpc</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">augmentcall</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">kmpc</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">kmpc</span><span class="p">,</span><span class="w"> </span><span class="n">pre_args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;unhandled unknown outline&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">subdata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;no subdata&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">DifferentialReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Return</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">tapeType</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tapeArg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"></span>
<span class="w">                           </span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">Logic</span><span class="p">.</span><span class="n">CreatePrimalAndGradient</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">ReverseCacheKey</span><span class="p">){.</span><span class="n">todiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretType</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">constant_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">uncacheable_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">returnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">(),</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">freeMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">AtomicAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">additionalType</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                  </span><span class="n">tape</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"></span>
<span class="w">                                       </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">.</span><span class="n">typeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextTypeInfo</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">interprocedural</span><span class="p">,</span><span class="w"> </span><span class="n">subdata</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*omp*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">tapeArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">tapeArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tapeArg</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newcalled: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; u: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">extracts</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">tapeIndices</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">tapeIndices</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">extracts</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">extracts</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">geps</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">extracts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">AI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">E</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">StoreInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">U</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getValueOperand</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">E</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">AI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SI</span><span class="o">-&gt;</span><span class="n">getPointerOperand</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AI</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LoadInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">U</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">geps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">LI</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">freeCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LI</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">geps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">freeCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">LU</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LU</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;free&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">freeCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">BC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LU</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CU</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BC</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CU</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;free&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">freeCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">freeCall</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">freeCall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">freeCall</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">freeCount</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">OutAlloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">OutFPTypes</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutTypes</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">OutAlloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">).</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">ST</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">OutAlloc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MetaTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">               </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">MetaTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">P</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">MetaTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">ST</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getVoidTy</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">MetaTypes</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">          </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Function</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;#out&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="o">*</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">GlobalVariable</span><span class="o">::</span><span class="n">InternalLinkage</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;#out&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">BasicBlock</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;entry&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SubArgs</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">SubArgs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cacheArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubArgs</span><span class="p">.</span><span class="n">back</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">SubArgs</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">outdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">SubArgs</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">ee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ee</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OutTypes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">ee</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">outdiff</span><span class="p">,</span><span class="w"> </span><span class="n">ee</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">ST</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">ST</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">ee</span><span class="p">)};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">cacheArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">cacheArg</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">cacheArg</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dif</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">              </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">IntToFloatTy</span><span class="p">(</span><span class="n">dif</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">()));</span><span class="w"></span>
<span class="w">              </span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">IntToFloatTy</span><span class="p">(</span><span class="n">dif</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">            </span><span class="n">MaybeAlign</span><span class="w"> </span><span class="n">align</span><span class="p">;</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">            </span><span class="n">AtomicRMWInst</span><span class="o">::</span><span class="n">BinOp</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AtomicRMWInst</span><span class="o">::</span><span class="n">FAdd</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">vt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">VectorType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dif</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">().</span><span class="n">isScalable</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numElems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">getElementCount</span><span class="p">().</span><span class="n">getKnownMinValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numElems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numElems</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">vdif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateExtractElement</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">i</span><span class="p">)};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">vptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">vptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 13</span>
<span class="w">                </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">vptr</span><span class="p">,</span><span class="w"> </span><span class="n">vdif</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"> </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">                </span><span class="n">AtomicRMWInst</span><span class="w"> </span><span class="o">*</span><span class="n">rmw</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">vptr</span><span class="p">,</span><span class="w"> </span><span class="n">vdif</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">rmw</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">align</span><span class="p">.</span><span class="n">getValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">vptr</span><span class="p">,</span><span class="w"> </span><span class="n">vdif</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 13</span>
<span class="w">              </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">              </span><span class="n">AtomicRMWInst</span><span class="w"> </span><span class="o">*</span><span class="n">rmw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"> </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">rmw</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">align</span><span class="p">.</span><span class="n">getValue</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAtomicRMW</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicOrdering</span><span class="o">::</span><span class="n">Monotonic</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">SyncScope</span><span class="o">::</span><span class="n">System</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;unhandled atomic fadd on llvm version &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unhandled atomic fadd&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">B</span><span class="p">.</span><span class="n">CreateRetVoid</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">numargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numargs</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">kmpc</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">kmpc</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">kmpc</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OutTypes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">OutTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                    </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                   </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">Idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">i</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="o">-&gt;</span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">OutTypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="n">OutFPTypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span><span class="w"> </span><span class="n">OutAlloc</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">)),</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">OutAlloc</span><span class="p">,</span><span class="w"> </span><span class="n">Idxs</span><span class="p">)),</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">OutTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">tapeIndiciesToFree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;openmp indirect unhandled&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">origArg</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dsto</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">OperandBundleDef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ReverseDefs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">len_arg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">origArg</span><span class="p">).</span><span class="n">Data0</span><span class="p">().</span><span class="n">ShiftIndices</span><span class="p">(</span><span class="n">DL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vd</span><span class="p">.</span><span class="n">isKnownPastPointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looseTypeAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">origArg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">origArg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSrcTy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">origArg</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">getSrcTy</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">vd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeTree</span><span class="p">(</span><span class="n">ConcreteType</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">origArg</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getSrcTy</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getScalarType</span><span class="p">()))</span><span class="w"></span>
<span class="w">                   </span><span class="p">.</span><span class="n">Only</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">knownF</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">EmitFailure</span><span class="p">(</span><span class="s">&quot;CannotDeduceType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="s">&quot;failed to deduce type of copy &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">origArg</span><span class="p">,</span><span class="w"> </span><span class="cm">/*errifnotfound*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="cm">/*pointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;bad mti&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nl">knownF</span><span class="p">:;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">nextStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vd</span><span class="p">[{</span><span class="mi">-1</span><span class="p">}];</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">Legal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">dt</span><span class="p">.</span><span class="n">checkedOrIn</span><span class="p">(</span><span class="n">vd</span><span class="p">[{(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">}],</span><span class="w"> </span><span class="cm">/*PointerIntSame*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">Legal</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Legal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">nextStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">.</span><span class="n">isKnown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TR</span><span class="p">.</span><span class="n">dump</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; vd:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vd</span><span class="p">.</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; start:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">start</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; size: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; dt:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span><span class="n">str</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">isKnown</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len_arg</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextStart</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">nextStart</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">start</span><span class="p">));</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">secretty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="p">.</span><span class="n">isFloat</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">dstaddr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">secretpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">dsto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dsto</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">srcaddr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getAddressSpace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">secretpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">secretty</span><span class="p">,</span><span class="w"> </span><span class="n">srcaddr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">srco</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">srco</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstInBoundsGEP1_64</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">dsto</span><span class="p">,</span><span class="w"> </span><span class="n">secretpt</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">srco</span><span class="p">,</span><span class="w"> </span><span class="n">secretpt</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateUDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">length</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">length</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="p">.</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="n">secretty</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                                     </span><span class="mi">8</span><span class="p">))};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dmemcpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertDifferentialFloatMemcpy</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">secretty</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*dstalign*/</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cm">/*srcalign*/</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">,</span><span class="w"> </span><span class="n">srcaddr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">dmemcpy</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">ReverseDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextStart</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">extractBLAS</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prefix</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">suffix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">extractable</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;ddot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sdot&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefixes</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cblas_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cublas_&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">suffixes</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_64_&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">extractable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">prefixes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">suffixes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">handleBLAS</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">funcName</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">StringRef</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">suffix</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uncacheable_args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Forward Mode not handled yet</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Vector Mode not handled yet</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">newCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ddot&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sdot&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">innerType</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">dfuncName</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ddot&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getDoubleTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">dfuncName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;daxpy&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">suffix</span><span class="p">).</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sdot&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">innerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getFloatTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">dfuncName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;saxpy&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">suffix</span><span class="p">).</span><span class="n">str</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Unreachable&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">castvals</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">innerType</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">          </span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">innerType</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="n">IntegerType</span><span class="w"> </span><span class="o">*</span><span class="n">intType</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">IntegerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">byRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">intType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">suffix</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;64&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">intType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IntegerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">intType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IntegerType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">byRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cacheval</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">in_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">arg_begin</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="n">countarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_arg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">in_arg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="n">xfuncarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_arg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">in_arg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="n">xincarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_arg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">in_arg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="n">yfuncarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_arg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">in_arg</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="n">yincarg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_arg</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">xcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">uncacheable_args</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">xfuncarg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">ycache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                      </span><span class="n">uncacheable_args</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">yfuncarg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">countcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">xinccache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">yinccache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// count must be preserved if overwritten</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uncacheable_args</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">countarg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">countcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="c1">// xinc is needed to be preserved if</span>
<span class="w">          </span><span class="c1">// 1) it is potentially overwritten</span>
<span class="w">          </span><span class="c1">//       AND EITHER</span>
<span class="w">          </span><span class="c1">//     a) x is active (for performing the shadow increment) or</span>
<span class="w">          </span><span class="c1">//     b) we&#39;re not caching x and need xinc to compute the derivative</span>
<span class="w">          </span><span class="c1">//        of y</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uncacheable_args</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">xincarg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="o">!</span><span class="n">xcache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">xinccache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="c1">// Similarly for yinc</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uncacheable_args</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">yincarg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="o">!</span><span class="n">ycache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">yinccache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xcache</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ycache</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">cachetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="n">cachetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cacheTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="n">cachetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">cacheTypes</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">cachetype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cacheValues</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">DL</span><span class="p">.</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="n">innerType</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">intType</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">count</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">countcache</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">count</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">xinc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">intType</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">xinc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">xinc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xinccache</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">xinc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">yinc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">intType</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">yinc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">yinc</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">yinccache</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">yinc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">dmemcpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertMemcpyStrided</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">                </span><span class="n">size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">malins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">innerType</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">malins</span><span class="p">,</span><span class="w"> </span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                              </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">xinc</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">castvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">dmemcpy</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">                                           </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ycache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">dmemcpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertMemcpyStrided</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"></span>
<span class="w">                </span><span class="n">size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">malins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">innerType</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">malins</span><span class="p">,</span><span class="w"> </span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="w"></span>
<span class="w">                              </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">yinc</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">castvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">dmemcpy</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">                                           </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cacheValues</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cacheValues</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">cachetype</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">tup</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">enumerate</span><span class="p">(</span><span class="n">cacheValues</span><span class="p">))</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="n">tup</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                    </span><span class="n">tup</span><span class="p">.</span><span class="n">index</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">cacheval</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">innerType</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">derivcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">dfuncName</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">getVoidTy</span><span class="p">(),</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">dif</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">derivcall</span><span class="p">.</span><span class="n">getCallee</span><span class="p">()))</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">derivcall</span><span class="p">))</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addFnAttr</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">ArgMemOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">F</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoCapture</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cachetype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">cachetype</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">cacheval</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">)),</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">cacheidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">trueYinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">countcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="o">?</span><span class="w"> </span><span class="n">cacheval</span><span class="w"></span>
<span class="w">                          </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">cacheidx</span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xinccache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="o">?</span><span class="w"> </span><span class="n">cacheval</span><span class="w"></span>
<span class="w">                      </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">cacheidx</span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">trueXinc</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                       </span><span class="p">(</span><span class="o">!</span><span class="n">xcache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">trueXinc</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">yinccache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">trueYinc</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="o">?</span><span class="w"> </span><span class="n">cacheval</span><span class="w"></span>
<span class="w">                      </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">cacheidx</span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">trueYinc</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">trueYinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cacheidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                       </span><span class="p">(</span><span class="o">!</span><span class="n">ycache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                        </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">trueXinc</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="o">!</span><span class="n">xcache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span><span class="w"></span>
<span class="w">              </span><span class="n">trueXinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">trueXinc</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="o">!</span><span class="n">ycache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span><span class="w"></span>
<span class="w">              </span><span class="n">trueYinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">trueYinc</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xdata_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trueXinc</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xdata_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdata</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">cacheval</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">cacheidx</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">xinc</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">xinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">xdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePtrToInt</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ydata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ydata_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trueYinc</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ycache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ydata_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ydata</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">cacheTypes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">cacheval</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cacheval</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">cacheidx</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">cacheidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocationBuilder</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">intType</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">yinc</span><span class="p">,</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">yinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">ydata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePtrToInt</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ydata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="w"></span>
<span class="w">                           </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">firstdcall</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">seconddcall</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">dif</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">xdata</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">xinc</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                       </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">trueYinc</span><span class="p">};</span><span class="w"></span>
<span class="w">            </span><span class="n">firstdcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">derivcall</span><span class="p">,</span><span class="w"> </span><span class="n">args1</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">xcache</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">dif</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">ydata</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">yinc</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                       </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">trueXinc</span><span class="p">};</span><span class="w"></span>
<span class="w">            </span><span class="n">seconddcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">derivcall</span><span class="p">,</span><span class="w"> </span><span class="n">args2</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">ycache</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xcache</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">xdata_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">firstdcall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ycache</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">ydata_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">seconddcall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="o">&amp;</span><span class="n">call</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; fallback?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">handleMPI</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">funcName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// MPI send / recv can only send float/integers</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Isend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Isend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Irecv&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Irecv&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">d_req</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">i64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">impi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMPIHelper</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">impialloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">),</span><span class="w"> </span><span class="n">i64</span><span class="p">,</span><span class="w"> </span><span class="n">impi</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">i64</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeAllocSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">impi</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                      </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impialloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req_prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">impialloc</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">d_req</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req_prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">d_req</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">d_req_prev</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Old</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">impialloc</span><span class="p">,</span><span class="w"> </span><span class="n">d_req</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Isend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Isend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                              </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">tysize</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">firstallocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;*</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpirecv_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">firstallocation</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ibuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">ibuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">ibuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">ibuf</span><span class="p">,</span><span class="w"> </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">i64</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Count</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dataType</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">dataType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">dataType</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dataType</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">DataType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="w"> </span><span class="n">i64</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Src</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span><span class="w"> </span><span class="n">i64</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Tag</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">dataType</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Comm</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">impialloc</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Isend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Isend&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">MPI_CallType</span><span class="o">::</span><span class="n">ISEND</span><span class="w"></span>
<span class="w">                      </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">MPI_CallType</span><span class="o">::</span><span class="n">IRECV</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Call</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">impialloc</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO old</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">recvfn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;PMPI_Wait&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">statusArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">statusArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">recvfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;MPI_Wait&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">statusArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">statusArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">              </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">statusType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; warning could not automatically determine mpi &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="s">&quot;status type, assuming [24 x i8]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">helperTy</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">getMPIHelper</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">helperTy</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">helperTy</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">helper</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">i64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">firstallocation</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">firstallocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">firstallocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">i64</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">i64</span><span class="p">,</span><span class="w"> </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Count</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Count</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">            </span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">DataType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">DataType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Old</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Old</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">helper</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())));</span><span class="w"></span>

<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">shouldFree</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">tysize</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="cm">/*req*/</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="cm">/*status*/</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">)</span><span class="w"></span>
<span class="w">                               </span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">statusType</span><span class="p">)};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">          </span><span class="n">FunctionCallee</span><span class="w"> </span><span class="n">waitFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">waitFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;PMPI_Wait&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MPI_Wait&quot;</span><span class="p">})</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">recvfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">statusArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">statusArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePtrToInt</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">else</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">waitFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">waitFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">waitFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Wait&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">waitFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Need to preserve the shadow Request (operand 6 in isend/irecv),</span>
<span class="w">          </span><span class="c1">// which becomes operand 0 for iwait.</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ReqDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">waitFunc</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">ReqDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">waitFunc</span><span class="p">.</span><span class="n">getCallee</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">waitFunc</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">F</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Irecv&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Irecv&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">dbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstallocation</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">nargs</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Isend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Isend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="c1">// TODO add operand bundle (unless force inlined?)</span>
<span class="w">            </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">firstallocation</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">firstallocation</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">              </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;illegal mpi&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">freecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">helper</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">freecall</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">freecall</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">freecall</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">freecall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*buf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*source*/</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*tag*/</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*request*/</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Wait&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Wait&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">impi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMPIHelper</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">req</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isNull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNamedValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;ompi_request_null&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">reql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">reql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">reql</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">reql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">reql</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">isNull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">reql</span><span class="p">,</span><span class="w"> </span><span class="n">GV</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">d_req</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">))));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">))));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isNull</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateSelect</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">isNull</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">d_reqp</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TapesToPreventRecomputation</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">I</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isNull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">d_reqp</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nonnullBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_nonnull&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">endBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">nonnullBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_end&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*fork*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*push*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">isNull</span><span class="p">,</span><span class="w"> </span><span class="n">endBlock</span><span class="p">,</span><span class="w"> </span><span class="n">nonnullBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">nonnullBlock</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_reqp</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">DataType</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Comm</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Call</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">req</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">dwait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertDifferentialMPI_Wait</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow Request (operand 0 in wait).</span>
<span class="w">        </span><span class="c1">// However, this doesn&#39;t end up preserving</span>
<span class="w">        </span><span class="c1">// the underlying buffers for the adjoint. To rememdy, force inline.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">dwait</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">dwait</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addFnAttr</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">AlwaysInline</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AlwaysInline</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="cm">/*request*/</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="cm">/*status*/</span><span class="w"> </span><span class="n">status</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">},</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Waitall&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Waitall&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">impi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMPIHelper</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">req</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">d_req</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">dsave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertDifferentialWaitallSave</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">count</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()},</span><span class="w"></span>
<span class="w">            </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">dsave</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">d_req</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">dsave</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req_orig</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">)),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">getIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">d_reqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">loopBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_loop&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nonnullBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">loopBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_nonnull&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">eloopBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">nonnullBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_eloop&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">endBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">eloopBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_end&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*fork*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*push*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpNE</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">count</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="n">loopBlock</span><span class="p">,</span><span class="w"> </span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">loopBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">count</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">count</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">currentBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">count</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">eloopBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">idxs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">idx</span><span class="p">};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">req_orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">req_orig</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_reqp</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">req_orig</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInBoundsGEP</span><span class="p">(</span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">))));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">d_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">impi</span><span class="p">))));</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">isNull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">isNull</span><span class="p">,</span><span class="w"> </span><span class="n">eloopBlock</span><span class="p">,</span><span class="w"> </span><span class="n">nonnullBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">nonnullBlock</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">d_req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">d_req</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">d_req</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Buf</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">DataType</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Comm</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">getMPIMemberPtr</span><span class="o">&lt;</span><span class="n">MPI_Elem</span><span class="o">::</span><span class="n">Call</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">req</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">dwait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertDifferentialMPI_Wait</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Need to preserve the shadow Request (operand 6 in isend/irecv), which</span>
<span class="w">        </span><span class="c1">// becomes operand 0 for iwait. However, this doesn&#39;t end up preserving</span>
<span class="w">        </span><span class="c1">// the underlying buffers for the adjoint. To remedy, force inline the</span>
<span class="w">        </span><span class="c1">// function.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">dwait</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">},</span><span class="w"></span>
<span class="w">                                       </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">dwait</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addFnAttr</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">AlwaysInline</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FunctionIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">Attribute</span><span class="o">::</span><span class="n">AlwaysInline</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">eloopBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">eloopBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">),</span><span class="w"> </span><span class="n">endBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">loopBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlockToPrimal</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">endBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">d_reqp</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">d_reqp</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">array_of_requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array_of_requests</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">array_of_requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">array_of_requests</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*array_of_requests*/</span><span class="w"> </span><span class="n">array_of_requests</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Send&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Ssend&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Send&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Ssend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">recvfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;MPI_Recv&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">statusArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">statusArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">recvfn</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                       </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;PMPI_Recv&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">statusArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recvfn</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">statusArg</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">PointerType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">statusArg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PT</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">statusType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">statusType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; warning could not automatically determine mpi &quot;</span><span class="w"></span>
<span class="w">                          </span><span class="s">&quot;status type, assuming [24 x i8]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*buf*/</span><span class="w"> </span><span class="n">shadow</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*dest*/</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*tag*/</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*buf*/</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*src*/</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*tag*/</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*status*/</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">).</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="n">statusType</span><span class="p">)};</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">firstallocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpirecv_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">firstallocation</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">firstallocation</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstallocation</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Recv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">firstallocation</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">firstallocation</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Recv&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Recv&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="o">!</span><span class="n">forwardMode</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Send&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">MemsetDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">None</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">nargs</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// int MPI_Bcast( void *buffer, int count, MPI_Datatype datatype, int root,</span>
<span class="w">    </span><span class="c1">//           MPI_Comm comm )</span>
<span class="w">    </span><span class="c1">// 1. if root, malloc intermediate buffer</span>
<span class="w">    </span><span class="c1">// 2. reduce sum diff(buffer) into intermediate</span>
<span class="w">    </span><span class="c1">// 3. if root, set shadow(buffer) = intermediate [memcpy] then free</span>
<span class="w">    </span><span class="c1">// 3-e. else, set shadow(buffer) = 0 [memset]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Bcast&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">ConcreteType</span><span class="w"> </span><span class="n">CT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">MPI_OP_Ptr_type</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*buffer*/</span><span class="w"> </span><span class="n">shadow</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. if root, malloc intermediate buffer, else undef</span>
<span class="w">        </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rootbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">rootbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">,</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">currentBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow buffer.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. reduce sum diff(buffer) into intermediate</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Reduce(const void *sendbuf, void *recvbuf, int count,</span>
<span class="w">          </span><span class="c1">// MPI_Datatype datatype,</span>
<span class="w">          </span><span class="c1">//     MPI_Op op, int root, MPI_Comm comm)</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op (MPI_SUM)*/</span><span class="w"></span>
<span class="w">              </span><span class="n">getOrInsertOpFloatSum</span><span class="p">(</span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">MPI_OP_Ptr_type</span><span class="p">,</span><span class="w"> </span><span class="n">CT</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*int root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Reduce&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. if root, set shadow(buffer) = intermediate [memcpy]</span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">nonrootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_nonroot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">nonrootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">nonrootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memcpyF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memcpy</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">memcpyF</span><span class="p">,</span><span class="w"> </span><span class="n">nargs</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Free up the memory of the buffer</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">nonrootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3-e. else, set shadow(buffer) = 0 [memset]</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Approximate algo (for sum):  -&gt; if statement yet to be</span>
<span class="w">    </span><span class="c1">// 1. malloc intermediate buffer</span>
<span class="w">    </span><span class="c1">// 1.5 if root, set intermediate = diff(recvbuffer)</span>
<span class="w">    </span><span class="c1">// 2. MPI_Bcast intermediate to all</span>
<span class="w">    </span><span class="c1">// 3. if root, Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">    </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">    </span><span class="c1">// 5. free intermediate buffer</span>

<span class="w">    </span><span class="c1">// int MPI_Reduce(const void *sendbuf, void *recvbuf, int count,</span>
<span class="w">    </span><span class="c1">// MPI_Datatype datatype,</span>
<span class="w">    </span><span class="c1">//                      MPI_Op op, int root, MPI_Comm comm)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Reduce&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;PMPI_Reduce&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO insert a check for sum</span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Get the operations from MPI_Receive</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantExpr</span><span class="w"> </span><span class="o">*</span><span class="n">CE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CE</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ompi_mpi_op_sum&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="c1">// MPICH</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1476395011</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isSum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; unhandled mpi_allreduce op: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unhandled mpi_allreduce op&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow send/recv buffers.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_count</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_datatype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_root</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_comm</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op*/</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Get the length for the allocation of the intermediate buffer</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. Alloc intermediate buffer</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1.5 if root, set intermediate = diff(recvbuffer)</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">nargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">nargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                           </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">memcpyF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memcpy</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">memcpyF</span><span class="p">,</span><span class="w"> </span><span class="n">nargs</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">memcpyF</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. MPI_Bcast intermediate to all</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Bcast( void *buffer, int count, MPI_Datatype datatype, int</span>
<span class="w">          </span><span class="c1">// root,</span>
<span class="w">          </span><span class="c1">//     MPI_Comm comm )</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*buf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*int root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Bcast&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. if root, Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">        </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Free up intermediate buffer</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Approximate algo (for sum):  -&gt; if statement yet to be</span>
<span class="w">    </span><span class="c1">// 1. malloc intermediate buffers</span>
<span class="w">    </span><span class="c1">// 2. MPI_Allreduce (sum) of diff(recvbuffer) to intermediate</span>
<span class="w">    </span><span class="c1">// 3. Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">    </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">    </span><span class="c1">// 5. free intermediate buffer</span>

<span class="w">    </span><span class="c1">// int MPI_Allreduce(const void *sendbuf, void *recvbuf, int count,</span>
<span class="w">    </span><span class="c1">//              MPI_Datatype datatype, MPI_Op op, MPI_Comm comm)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Allreduce&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// TODO insert a check for sum</span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Get the operations from MPI_Receive</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Constant</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig_op</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantExpr</span><span class="w"> </span><span class="o">*</span><span class="n">CE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CE</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">GV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">GlobalVariable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GV</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ompi_mpi_op_sum&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="c1">// MPICH</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1476395011</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">isSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isSum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; unhandled mpi_allreduce op: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig_op</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;unhandled mpi_allreduce op&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow send/recv buffers.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="o">!</span><span class="n">forwardMode</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_count</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_datatype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_comm</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_op</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op*/</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Get the length for the allocation of the intermediate buffer</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">len_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. Alloc intermediate buffer</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. MPI_Allreduce (sum) of diff(recvbuffer) to intermediate</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Allreduce(const void *sendbuf, void *recvbuf, int count,</span>
<span class="w">          </span><span class="c1">//              MPI_Datatype datatype, MPI_Op op, MPI_Comm comm)</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*count*/</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*datatype*/</span><span class="w"> </span><span class="n">datatype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op*/</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Allreduce&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">        </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Free up intermediate buffer</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Approximate algo (for sum):  -&gt; if statement yet to be</span>
<span class="w">    </span><span class="c1">// 1. malloc intermediate buffer</span>
<span class="w">    </span><span class="c1">// 2. Scatter diff(recvbuffer) to intermediate buffer</span>
<span class="w">    </span><span class="c1">// 3. if root, Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">    </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">    </span><span class="c1">// 5. free intermediate buffer</span>

<span class="w">    </span><span class="c1">// int MPI_Gather(const void *sendbuf, int sendcount, MPI_Datatype sendtype,</span>
<span class="w">    </span><span class="c1">//           void *recvbuf, int recvcount, MPI_Datatype recvtype,</span>
<span class="w">    </span><span class="c1">//           int root, MPI_Comm comm)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Gather&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sendcount</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_root</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_comm</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Get the length for the allocation of the intermediate buffer</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow send/recv buffers.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. Alloc intermediate buffer</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. Scatter diff(recvbuffer) to intermediate buffer</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Scatter(const void *sendbuf, int sendcount, MPI_Datatype</span>
<span class="w">          </span><span class="c1">// sendtype,</span>
<span class="w">          </span><span class="c1">//     void *recvbuf, int recvcount, MPI_Datatype recvtype, int root,</span>
<span class="w">          </span><span class="c1">//     MPI_Comm comm)</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendcount*/</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendtype*/</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Scatter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. if root, Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">tysize</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">        </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Free up intermediate buffer</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Approximate algo (for sum):  -&gt; if statement yet to be</span>
<span class="w">    </span><span class="c1">// 1. if root, malloc intermediate buffer, else undef</span>
<span class="w">    </span><span class="c1">// 2. Gather diff(recvbuffer) to intermediate buffer</span>
<span class="w">    </span><span class="c1">// 3. Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">    </span><span class="c1">// 4. if root, diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">    </span><span class="c1">// 5. if root, free intermediate buffer</span>

<span class="w">    </span><span class="c1">// int MPI_Scatter(const void *sendbuf, int sendcount, MPI_Datatype</span>
<span class="w">    </span><span class="c1">// sendtype,</span>
<span class="w">    </span><span class="c1">//           void *recvbuf, int recvcount, MPI_Datatype recvtype, int root,</span>
<span class="w">    </span><span class="c1">//           MPI_Comm comm)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Scatter&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_root</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_comm</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Get the length for the allocation of the intermediate buffer</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow send/recv buffers.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. if root, malloc intermediate buffer, else undef</span>
<span class="w">        </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">sendlen_phi</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">tysize</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">rootbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">rootbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">rootbuf</span><span class="p">,</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">currentBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">sendlen_phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">sendlen_phi</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">sendlen_phi</span><span class="o">-&gt;</span><span class="n">addIncoming</span><span class="p">(</span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">currentBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. Gather diff(recvbuffer) to intermediate buffer</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Gather(const void *sendbuf, int sendcount, MPI_Datatype</span>
<span class="w">          </span><span class="c1">// sendtype,</span>
<span class="w">          </span><span class="c1">//     void *recvbuf, int recvcount, MPI_Datatype recvtype,</span>
<span class="w">          </span><span class="c1">//     int root, MPI_Comm comm)</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendcount*/</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendtype*/</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*root*/</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Gather&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 4. if root, diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">        </span><span class="c1">// 5. if root, free intermediate buffer</span>

<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">currentBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">rootBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">currentBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">mergeBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">addReverseBlock</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlock</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_post&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCondBr</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateICmpEQ</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">),</span><span class="w"> </span><span class="n">rootBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">rootBlock</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">          </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">sendlen_phi</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Free up intermediate buffer</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBr</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">mergeBlock</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Approximate algo (for sum):  -&gt; if statement yet to be</span>
<span class="w">    </span><span class="c1">// 1. malloc intermediate buffer</span>
<span class="w">    </span><span class="c1">// 2. reduce diff(recvbuffer) then scatter to corresponding input node&#39;s</span>
<span class="w">    </span><span class="c1">// intermediate buffer</span>
<span class="w">    </span><span class="c1">// 3. Zero diff(recvbuffer) [memset to 0]</span>
<span class="w">    </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">    </span><span class="c1">// 5. free intermediate buffer</span>

<span class="w">    </span><span class="c1">// int MPI_Allgather(const void *sendbuf, int sendcount, MPI_Datatype</span>
<span class="w">    </span><span class="c1">// sendtype,</span>
<span class="w">    </span><span class="c1">//           void *recvbuf, int recvcount, MPI_Datatype recvtype,</span>
<span class="w">    </span><span class="c1">//           MPI_Comm comm)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Allgather&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">forwardMode</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">orig_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_recvbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_recvbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadow_sendbuf</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isIntegerTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">shadow_sendbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateIntToPtr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_recvtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">recvtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">recvtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendcount</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_sendtype</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">sendtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_comm</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tysize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_TYPE_SIZE</span><span class="p">(</span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">forwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Get the length for the allocation of the intermediate buffer</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">sendlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">tysize</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Need to preserve the shadow send/recv buffers.</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">BufferDefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 1. Alloc intermediate buffer</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateMalloc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">sendlen_arg</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpireduce_malloccache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">ConcreteType</span><span class="w"> </span><span class="n">CT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">firstPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">MPI_OP_Ptr_type</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 2. reduce diff(recvbuffer) then scatter to corresponding input node&#39;s</span>
<span class="w">        </span><span class="c1">// intermediate buffer</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// int MPI_Reduce_scatter_block(const void* send_buffer,</span>
<span class="w">          </span><span class="c1">//                    void* receive_buffer,</span>
<span class="w">          </span><span class="c1">//                    int count,</span>
<span class="w">          </span><span class="c1">//                    MPI_Datatype datatype,</span>
<span class="w">          </span><span class="c1">//                    MPI_Op operation,</span>
<span class="w">          </span><span class="c1">//                    MPI_Comm communicator);</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*sendbuf*/</span><span class="w"> </span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvbuf*/</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvcount*/</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*recvtype*/</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*op (MPI_SUM)*/</span><span class="w"></span>
<span class="w">              </span><span class="n">getOrInsertOpFloatSum</span><span class="p">(</span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">MPI_OP_Ptr_type</span><span class="p">,</span><span class="w"> </span><span class="n">CT</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="cm">/*comm*/</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)];</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">          </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                                  </span><span class="s">&quot;MPI_Reduce_scatter_block&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 3. zero diff(recvbuffer) [memset to 0]</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="n">tysize</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">recvlen_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateMul</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">())),</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">shadow_recvbuf</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">recvlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 4. diff(sendbuffer) += intermediate buffer (diffmemcopy)</span>
<span class="w">        </span><span class="n">DifferentiableMemCopyFloats</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">orig_sendbuf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">shadow_sendbuf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">sendlen_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">BufferDefs</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Free up intermediate buffer</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Adjoint of barrier is to place a barrier at the corresponding</span>
<span class="w">    </span><span class="c1">// location in the reverse.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Barrier&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Remove free&#39;s in forward pass so the comm can be used in the reverse</span>
<span class="w">    </span><span class="c1">// pass</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Comm_free&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Comm_disconnect&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Adjoint of MPI_Comm_split / MPI_Graph_create (which allocates a comm in a</span>
<span class="w">    </span><span class="c1">// pointer) is to free the created comm at the corresponding place in the</span>
<span class="w">    </span><span class="c1">// reverse pass</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">commFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPIInactiveCommAllocators</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">commFound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MPIInactiveCommAllocators</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">lookup</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">commFound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">        </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">types</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">        </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="s">&quot;MPI_Comm_free&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FT</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled MPI FUNCTION&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Return</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">visitCallInst</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">newCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">setFastMathFlags</span><span class="p">(</span><span class="n">getFast</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; call: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; + &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Argument</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uncacheable_args</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">uncacheable_args_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionFromCall</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">StringRef</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">hasFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFnAttribute</span><span class="p">(</span><span class="s">&quot;enzyme_math&quot;</span><span class="p">).</span><span class="n">getValueAsString</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">subretused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unnecessaryValues</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">unnecessaryValues</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">subretused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">subretType</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customFwdCallHandlers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">customFwdCallHandlers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">normalReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretused</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">newCall</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">,</span><span class="w"> </span><span class="n">invertedReturn</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; o: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ot: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ir: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; irt: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; p: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; PT: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newCall: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newCall</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newCallT: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">invertedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">orig</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">invertedReturn</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">normalReturn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">normalReturn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newCall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">normalReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customCallHandlers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">customCallHandlers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasNonReturnUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">//! We only need the shadow pointer for non-forward Mode if it is used</span>
<span class="w">          </span><span class="c1">//! in a non return setting</span>
<span class="w">          </span><span class="n">hasNonReturnUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasNonReturnUse</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">normalReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretused</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">newCall</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">invertedReturn</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">tapeIndices</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                  </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">tapeIndices</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">),</span><span class="w"></span>
<span class="w">                                           </span><span class="cm">/*ignoreType*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasNonReturnUse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; o: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ot: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ir: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; irt: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; p: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; PT: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newCall: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newCall</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; newCallT: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">invertedReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">invertedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">              </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">invertedReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">invertedReturn</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">orig</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">invertedReturn</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">normalReturn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newCall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">normalReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">normalReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">normalReturn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">normalReturn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">newCall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">normalReturn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">normalReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                      </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                     </span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isTokenTy</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4u&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8u&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;__kmpc_for_static_fini&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">fini</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                   </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">fini</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">fini</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">fini</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;MPI_&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PMPI_&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Barrier&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Comm_free&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;MPI_Comm_disconnect&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">         </span><span class="n">MPIInactiveCommAllocators</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">str</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">             </span><span class="n">MPIInactiveCommAllocators</span><span class="p">.</span><span class="n">end</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">handleMPI</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">funcName</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">called</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractBLAS</span><span class="p">(</span><span class="n">funcName</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handleBLAS</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;printf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;puts&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_ZN3std2io5stdio6_print&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_ZN4core3fmt&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;__enzyme_float&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                   </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;__enzyme_double&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                   </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;__enzyme_integer&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                   </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;__enzyme_pointer&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Handle lgamma, safe to recompute so no store/change to forward</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_fork_call&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">visitOMPCall</span><span class="p">(</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_4u&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_init_8u&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">fini</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;__kmpc_for_static_fini&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">fini</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">fini</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">fini</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">fini</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_for_static_fini&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// TODO check</span>
<span class="w">      </span><span class="c1">// Adjoint of barrier is to place a barrier at the corresponding</span>
<span class="w">      </span><span class="c1">// location in the reverse.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_barrier&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_critical&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">crit2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;__kmpc_end_critical&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">crit2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">crit2</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">crit2</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">crit2</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__kmpc_end_critical&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">crit2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="s">&quot;__kmpc_critical&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">crit2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">)};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">fcall</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">crit2</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">crit2</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">fcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">crit2</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;__kmpc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;__kmpc_global_thread_num&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;unhandled openmp function&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unhandled openmp function&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;asin&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;asinf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;asinl&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">oneMx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">oneMx2</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sqrt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">oneMx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">oneMx2</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sqrt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;atan&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;atanf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;atanl&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__fd_atan_1&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">onePx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">onePx2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">onePx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">onePx2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;atan2&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">denom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">                                             </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">der</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">der</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">der</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">denom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">                                             </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dret</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">num</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cbrt&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cubcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cubcall</span><span class="p">),</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cubcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">cubcall</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hypot&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hypotf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hypotl&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cubcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dx</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="w">              </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">cubcall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">};</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cubcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="n">cubcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="n">cubcall</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanhf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanh&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">coshf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;coshf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">coshf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">coshf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;tanh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;coshf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">coshf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;coshf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">sinhf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;sinh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;sinhf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">sinhf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">sinhf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;sinh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;sinhf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">sinhf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sinhf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sinh&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">sinhf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sinh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;coshf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">sinhf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"></span>
<span class="w">                            </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">sinhf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;sinh&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;cosh&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;coshf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">sinhf</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">cal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Functions that only modify pointers and don&#39;t allocate memory,</span>
<span class="w">      </span><span class="c1">// needs to be run on shadow in primal</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_ZSt29_Rb_tree_insert_and_rebalancebPSt18_Rb_tree_&quot;</span><span class="w"></span>
<span class="w">                      </span><span class="s">&quot;node_baseS0_RS_&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// if constant instruction and readonly (thus must be pointer return)</span>
<span class="w">      </span><span class="c1">// and shadow return recomputable from shadow arguments.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__dynamic_cast&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_ZSt18_Rb_tree_decrementPSt18_Rb_tree_node_base&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_ZSt18_Rb_tree_incrementPSt18_Rb_tree_node_base&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">shouldCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">shouldCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">empty</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">lrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">empty</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lrc</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="p">.</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__dynamic_cast&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">else</span><span class="w"></span>
<span class="w">                    </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">needsReplacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lrc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                         </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">shadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">needsReplacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsReplacement</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">assert</span><span class="p">(</span><span class="n">shadow</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">shadow</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shouldCache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">lrc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">shouldCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldCache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erfi&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erfc&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erfi&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erfc&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="w">              </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">sq</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Faddeeva&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">sq</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">re</span><span class="p">,</span><span class="w"> </span><span class="n">re</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="n">im</span><span class="p">)),</span><span class="w"></span>
<span class="w">                  </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">re</span><span class="p">,</span><span class="w"> </span><span class="n">im</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erfc&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">sq</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                       </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erfc&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">re</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">im</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">ExpF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Faddeeva&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">reexp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">ExpF</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">re</span><span class="p">});</span><span class="w"></span>

<span class="w">              </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">CosF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">SinF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">reexp</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">CosF</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">im</span><span class="p">})),</span><span class="w"></span>
<span class="w">                  </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">reexp</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">SinF</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">im</span><span class="p">})),</span><span class="w"></span>
<span class="w">                  </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">ExpF</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">sq</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">tys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;erfc&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Faddeeva_erfc&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="mf">-1.1283791670955125738961589031215451716881012586580</span><span class="w"></span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="mf">1.1283791670955125738961589031215451716881012586580</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Faddeeva&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">re</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dfactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                              </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dfactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">fac_re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">dfactor</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">fac_im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">dfactor</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">re</span><span class="p">,</span><span class="w"> </span><span class="n">fac_re</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="n">fac_im</span><span class="p">)),</span><span class="w"></span>
<span class="w">                  </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">res</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="n">fac_re</span><span class="p">),</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">re</span><span class="p">,</span><span class="w"> </span><span class="n">fac_im</span><span class="p">)),</span><span class="w"></span>
<span class="w">                  </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dfactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">dfactor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Faddeeva&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule1</span><span class="p">,</span><span class="w"> </span><span class="n">dfactor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule2</span><span class="p">,</span><span class="w"> </span><span class="n">dfactor</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">cal</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j0&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y0&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j0f&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y0f&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;j1f&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;y1f&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">x</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">dx</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;j1f&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;y1f&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">x</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">dx</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1f&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1f&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;j0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;j0f&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;y0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;y0f&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">intType</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getIntNTy</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">pargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">FT2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">pargs</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;jn&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;jnf&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;yn&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;ynf&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">FT2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;j0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;j0f&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;y0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;y0f&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">intType</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getIntNTy</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">pargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">FT2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">pargs</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">funcName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;j1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;jn&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;jnf&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;y1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;yn&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;ynf&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="n">FT2</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">intType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jn&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;yn&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jnf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ynf&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateSub</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">x</span><span class="p">});</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.write_barrier&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">stores</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                    </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">                  </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">               </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iargs</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ptrshadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">iargs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ptrshadow</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iargs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">iargs</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">ID</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">not_intrinsic</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isMemFreeLibMFunction</span><span class="p">(</span><span class="n">funcName</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ID</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">not_intrinsic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">orig_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">handleAdjointForIntrinsic</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ops</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__fd_sincos_1&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">dsin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">dcos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">dsin</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">});</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateInsertValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFNeg</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">dcos</span><span class="p">)),</span><span class="w"></span>
<span class="w">                  </span><span class="p">{</span><span class="mi">1</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">dsin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">dcos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                          </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFSub</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">}),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">dsin</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">}),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">dcos</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">dif0</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cabs&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cabsf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;cabsl&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">argument</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">op1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFAdd</span><span class="p">(</span><span class="n">dif1</span><span class="p">,</span><span class="w"> </span><span class="n">dif2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dif</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">op0</span><span class="p">,</span><span class="w"> </span><span class="n">op1</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown calling convention found for cabs&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFDiv</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"></span>
<span class="w">                  </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateFMul</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">div</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown calling convention found for cabs&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ldexp&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ldexpf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ldexpl&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">exponent</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>

<span class="w">              </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">exponent</span><span class="p">};</span><span class="w"></span>

<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">darg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">vdiff</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">darg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">vdiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">exponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">vdiff</span><span class="p">,</span><span class="w"> </span><span class="n">exponent</span><span class="p">};</span><span class="w"></span>

<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">darg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">darg</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgamma&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammaf&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammal&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgamma_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammaf_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;lgammal_r&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgamma_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammaf_r_finite&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;__lgammal_r_finite&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isAllocationFunction</span><span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">constval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dbgLoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">bb</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_operands</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="c1">// If rematerializable allocations and split mode, we can</span>
<span class="w">          </span><span class="c1">// simply elect to build the entire piece in the reverse</span>
<span class="w">          </span><span class="c1">// since it should be possible to perform any shadow stores</span>
<span class="w">          </span><span class="c1">// of pointers (from rematerializable property) and it does</span>
<span class="w">          </span><span class="c1">// not escape the function scope (lest it not be</span>
<span class="w">          </span><span class="c1">// rematerializable) so all input derivatives remain zero.</span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="kt">bool</span><span class="w"> </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">backwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="c1">// If in a loop context, maintain the same free behavior.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                  </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"></span>
<span class="w">                </span><span class="n">inLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Needs a stronger replacement check/assertion.</span>
<span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">)));</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">endAnti</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inLoop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">rematerializedShadowPHIs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">endAnti</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadowHandlers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">str</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">                </span><span class="n">shadowHandlers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">bb</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shadowHandlers</span><span class="p">[</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">str</span><span class="p">()](</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">bb</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">bb</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">              </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                   </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;mi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;mi&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">dbgLoc</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;malloc&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;_Znwm&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">derefBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">cal</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addDereferenceableRetAttr</span><span class="p">(</span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addDereferenceableRetAttr</span><span class="p">(</span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="cp">#ifndef FLANG</span>
<span class="w">                  </span><span class="n">AttrBuilder</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="n">called</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">AttrBuilder</span><span class="w"> </span><span class="n">B</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">B</span><span class="p">.</span><span class="n">addDereferenceableOrNullAttr</span><span class="p">(</span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">().</span><span class="n">addRetAttributes</span><span class="p">(</span><span class="w"></span>
<span class="w">                          </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">B</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">().</span><span class="n">addRetAttributes</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">B</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addDereferenceableAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">llvm</span><span class="o">::</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addDereferenceableAttr</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addDereferenceableOrNullAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">llvm</span><span class="o">::</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addDereferenceableOrNullAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">llvm</span><span class="o">::</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"> </span><span class="n">derefBytes</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NoAlias</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">cal</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">ReturnIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;*</span><span class="n">bb</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">placeholder</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">bb</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bb</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">takeName</span><span class="p">(</span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                                                         </span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">                                                         </span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                                       </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                  </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">),</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="n">anti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacement</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">forwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">backwardsShadow</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                   </span><span class="n">backwardsShadow</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inLoop</span><span class="p">)</span><span class="w"></span>
<span class="w">                  </span><span class="n">zeroKnownAllocation</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">anti</span><span class="p">)));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="nl">endAnti</span><span class="p">:;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">()))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">AllocaInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">anti</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">anti</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tofree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">anti</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">tofree</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">tofree</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">tofree</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">tofree</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">())));</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">tofree</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">freeKnownAllocation</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">tofree</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">dbgLoc</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">)</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">              </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                               </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">setTailCallKind</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getTailCallKind</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">dbgLoc</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CI</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">};</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">CI</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">CI</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Cache and rematerialization irrelevant for forward mode.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"></span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nb">false</span><span class="w"></span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Don&#39;t erase any store that needs to be preserved for a</span>
<span class="w">      </span><span class="c1">// rematerialization</span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">rematerializableAllocations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">rematerializableAllocations</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// If rematerializing (e.g. needed in reverse, but not needing</span>
<span class="w">          </span><span class="c1">//  the whole allocation):</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cacheWholeAllocation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// if rematerialize, don&#39;t ever cache and downgrade to stack</span>
<span class="w">            </span><span class="c1">// allocation where possible.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">B</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                      </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">              </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="c1">// No need to free GC.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_1d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_2d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_3d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_array_copy&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_1d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_2d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_3d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_array_copy&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.gc_alloc_obj&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Otherwise if in reverse pass, free the newly created allocation.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">dbgLoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">());</span><span class="w"></span>
<span class="w">              </span><span class="n">freeKnownAllocation</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">dbgLoc</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// If in primal, do nothing (keeping the original caching behavior)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cacheWholeAllocation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// If not caching allocation and not needed in the reverse, we can</span>
<span class="w">            </span><span class="c1">// use the original freeing behavior for the function. If in the</span>
<span class="w">            </span><span class="c1">// reverse pass we should not recreate this allocation.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">B</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                  </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">              </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                      </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                      </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="c1">// Don&#39;t set zero alignment</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Alignment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">                </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If an allocation is not needed in the reverse, maintain the original</span>
<span class="w">      </span><span class="c1">// free behavior and do not rematerialize this for the reverse. However,</span>
<span class="w">      </span><span class="c1">// this is only safe to perform for allocations with a guaranteed free</span>
<span class="w">      </span><span class="c1">// as can we can only guarantee that we don&#39;t erase those frees.</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasPDFree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">allocationsWithGuaranteedFree</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hasPDFree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasMetadata</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enzyme_fromstack&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">B</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">inversionAllocs</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CreateAlloca</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">Alignment</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">ConstantAsMetadata</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">())</span><span class="w"></span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="n">getLimitedValue</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Don&#39;t set zero alignment</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Alignment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">              </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">              </span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Alignment</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If an object is managed by the GC do not preserve it for later free,</span>
<span class="w">      </span><span class="c1">// Thus it only needs caching if there is a need for it in the reverse.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_1d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_2d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_alloc_array_3d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;jl_array_copy&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_1d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_2d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_alloc_array_3d&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ijl_array_copy&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.gc_alloc_obj&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primalNeededInReverse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_replacementJ&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">fictiousPHIs</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">pn</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EnzymeFreeInternalAllocations</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">hasPDFree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// TODO enable this if we need to free the memory</span>
<span class="w">      </span><span class="c1">// NOTE THAT TOPLEVEL IS THERE SIMPLY BECAUSE THAT WAS PREVIOUS ATTITUTE</span>
<span class="w">      </span><span class="c1">// TO FREE&#39;ing</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">           </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">hasPDFree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasPDFree</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dbgLoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">freeKnownAllocation</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">nop</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">dbgLoc</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                 </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                 </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Note that here we cannot simply replace with null as users who</span>
<span class="w">        </span><span class="c1">// try to find the shadow pointer will use the shadow of null rather</span>
<span class="w">        </span><span class="c1">// than the true shadow of this</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_replacementB&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">fictiousPHIs</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">pn</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;julia.pointer_from_objref&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">needShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                         </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Shadow</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">needShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ptrshadow</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">ptrshadow</span><span class="p">});</span><span class="w"></span>

<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;memcpy&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;memmove&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;memcpy&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memcpy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memmove</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 10</span>
<span class="w">      </span><span class="n">visitMemTransferCommon</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="cm">/*srcAlign*/</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="cm">/*dstAlign*/</span><span class="w"> </span><span class="n">MaybeAlign</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                             </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">visitMemTransferCommon</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="cm">/*srcAlign*/</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="cm">/*dstAlign*/</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">                             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">                             </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funcName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;posix_memalign&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">constval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">constval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">ptrshadow</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">called</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="p">{</span><span class="n">ptrshadow</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"></span>
<span class="w">               </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">))});</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">ptrshadow</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="n">ptrshadow</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">ptrshadow</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dst_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">val_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">len_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateZExtOrTrunc</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="w"></span>
<span class="w">              </span><span class="n">Type</span><span class="o">::</span><span class="n">getInt64Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">volatile_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">getFalse</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR == 6</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">align_arg</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">align_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">nargs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="p">,</span><span class="w"> </span><span class="n">val_arg</span><span class="p">,</span><span class="w"> </span><span class="n">len_arg</span><span class="p">,</span><span class="w"> </span><span class="n">volatile_arg</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">          </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">tys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">dst_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">len_arg</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()};</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">memset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">getDeclaration</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                        </span><span class="n">Intrinsic</span><span class="o">::</span><span class="n">memset</span><span class="p">,</span><span class="w"> </span><span class="n">tys</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">nargs</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="c1">// memset-&gt;addParamAttr(0, Attribute::getWithAlignment(Context,</span>
<span class="w">          </span><span class="c1">// inst-&gt;getAlignment()));</span>
<span class="w">          </span><span class="n">memset</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">toReplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">call</span><span class="p">.</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_psxtmp&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">toReplace</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tofree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                            </span><span class="cm">/*tryLegalRecompute*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">freeCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">tofree</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInstList</span><span class="p">().</span><span class="n">push_back</span><span class="p">(</span><span class="n">freeCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// TODO enable this if we need to free the memory</span>
<span class="w">      </span><span class="c1">// NOTE THAT TOPLEVEL IS THERE SIMPLY BECAUSE THAT WAS PREVIOUS ATTITUTE</span>
<span class="w">      </span><span class="c1">// TO FREE&#39;ing</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// if (is_value_needed_in_reverse&lt;Primal&gt;(</span>
<span class="w">        </span><span class="c1">//        TR, gutils, orig, /*topLevel*/ Mode ==</span>
<span class="w">        </span><span class="c1">//        DerivativeMode::Both))</span>
<span class="w">        </span><span class="c1">//        {</span>

<span class="w">        </span><span class="c1">//  gutils-&gt;cacheForReverse(BuilderZ, newCall,</span>
<span class="w">        </span><span class="c1">//                          getIndex(orig, CacheType::Self));</span>
<span class="w">        </span><span class="c1">//} else if (Mode != DerivativeMode::Forward) {</span>
<span class="w">        </span><span class="c1">// Note that here we cannot simply replace with null as users who try</span>
<span class="w">        </span><span class="c1">// to find the shadow pointer will use the shadow of null rather than</span>
<span class="w">        </span><span class="c1">// the true shadow of this</span>
<span class="w">        </span><span class="c1">//}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;posix_preread&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;posix_preread&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">freeCall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="cm">/*tryLegal*/</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getInstList</span><span class="p">().</span><span class="n">push_back</span><span class="p">(</span><span class="n">freeCall</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Remove free&#39;s in forward pass so the memory can be used in the reverse</span>
<span class="w">    </span><span class="c1">// pass</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isDeallocationFunction</span><span class="p">(</span><span class="o">*</span><span class="n">called</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TLI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">             </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">origfree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">newfree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">tofree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">origfree</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrInsertCheckedFree</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="o">*</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getModule</span><span class="p">(),</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">newfree</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">newfree</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">args</span><span class="p">](</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tofree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tofree</span><span class="p">);</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">          </span><span class="n">applyChainRule</span><span class="p">(</span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">tofree</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">rmat</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">backwardsOnlyShadows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rmat</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">frees</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rmat</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">primalInitialize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">origfree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">tofree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">origfree</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tofree</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">origfree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">tofree</span><span class="p">};</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">CI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                               </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">CI</span><span class="o">-&gt;</span><span class="n">setAttributes</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If a rematerializable allocation.</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">rmat</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">rematerializableAllocations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rmat</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">frees</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Leave the original free behavior since this won&#39;t be used</span>
<span class="w">          </span><span class="c1">// in the reverse pass in split mode</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">UsageKey</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Seen</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">Seen</span><span class="p">[</span><span class="n">UsageKey</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">rmat</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">Seen</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">rmat</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">rmat</span><span class="p">.</span><span class="n">first</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">cacheWholeAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">primalNeededInReverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// If in a loop context, maintain the same free behavior, unless</span>
<span class="w">            </span><span class="c1">// caching whole allocation.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cacheWholeAllocation</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rmat</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rmat</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                    </span><span class="n">rmat</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">LI</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="c1">// In combined mode, if we don&#39;t need this allocation</span>
<span class="w">            </span><span class="c1">// in the reverse, we can use the original deallocation</span>
<span class="w">            </span><span class="c1">// behavior.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primalNeededInReverse</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">forwardDeallocations</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">postDominatingFrees</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">cast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">CastInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ConstantPointerNull</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;removing free of null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// TODO HANDLE FREE</span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;freeing without malloc &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantInstruction</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">knownRecomputeHeuristic</span><span class="p">[</span><span class="n">orig</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If we need this value and it is illegal to recompute it (it writes or</span>
<span class="w">      </span><span class="c1">// may load uncacheable data)</span>
<span class="w">      </span><span class="c1">//    Store and reload it</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">subretused</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">legalRecompute</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">ValueToValueMapTy</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newCall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// If this call may write to memory and is a copy (in the just reverse</span>
<span class="w">      </span><span class="c1">// pass), erase it</span>
<span class="w">      </span><span class="c1">//  Any uses of it should be handled by the case above so it is safe to</span>
<span class="w">      </span><span class="c1">//  RAUW</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">// if call does not write memory and isn&#39;t used, we can erase it</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">mayWriteToMemory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">subretused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">foreignFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">FnTypeInfo</span><span class="w"> </span><span class="nf">nextTypeInfo</span><span class="p">(</span><span class="n">called</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">nextTypeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TR</span><span class="p">.</span><span class="n">getCallInfo</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*</span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardMode</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">getForwardBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">gradByVal</span><span class="p">;</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">isByValArgument</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gradByVal</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParamByValType</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">argi</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">argType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">             </span><span class="n">foreignFunction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">at</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constant_args</span><span class="p">[</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getArgNo</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="c1">// Note sometimes whattype mistakenly says something should be</span>
<span class="w">          </span><span class="c1">// constant [because composed of integer pointers alone]</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                 </span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">());</span><span class="w"></span>

<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Optional</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tapeIdx</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">tapeIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">hasValue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">tapeIdx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="w"></span>
<span class="w">                            </span><span class="o">:</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">())</span><span class="w"></span>
<span class="w">                                  </span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tapeArg&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TapesToPreventRecomputation</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateForwardDiff</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">),</span><span class="w"> </span><span class="n">subretType</span><span class="p">,</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">interprocedural</span><span class="p">,</span><span class="w"> </span><span class="cm">/*returnValue*/</span><span class="w"> </span><span class="n">subretused</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FreeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">nextTypeInfo</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">            </span><span class="cm">/*augmented*/</span><span class="w"> </span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ft</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">retActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">ReturnType</span><span class="w"> </span><span class="n">subretVal</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">subretused</span><span class="w"></span>
<span class="w">                </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">retActive</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">TwoReturns</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">Return</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">retActive</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">Return</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ReturnType</span><span class="o">::</span><span class="n">Void</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FTy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFunctionTypeForClone</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="n">tape</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">subretVal</span><span class="p">,</span><span class="w"> </span><span class="n">subretType</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">PointerType</span><span class="w"> </span><span class="o">*</span><span class="n">fptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">FTy</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">fptype</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">fptype</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">BundleTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="n">BundleTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Both</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">Defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                                             </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">      </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Defs</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gradByVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithByValType</span><span class="p">(</span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">newcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">primal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">primal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">diffe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffes</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">primal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffes</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newcall</span><span class="p">,</span><span class="w"> </span><span class="n">primal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newcall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">diffe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newcall</span><span class="p">,</span><span class="w"> </span><span class="n">primal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newcall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">setDiffe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">diffe</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newcall</span><span class="p">,</span><span class="w"> </span><span class="n">primal</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newcall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">modifyPrimal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shouldAugmentCall</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pre_args</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DIFFE_TYPE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">postCreate</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">userReplace</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">preByVal</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">gradByVal</span><span class="p">;</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">argi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">isByValArgument</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">preByVal</span><span class="p">[</span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParamByValType</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="n">pre_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">argi</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">isByValArgument</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gradByVal</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParamByValType</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lookup</span><span class="p">(</span><span class="n">argi</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">argType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argi</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">foreignFunction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isPointerTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 12</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderlyingObject</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetUnderlyingObject</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span><span class="p">(</span><span class="n">at</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constant_args</span><span class="p">[</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">getArgNo</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">pre_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Note sometimes whattype mistakenly says something should be</span>
<span class="w">        </span><span class="c1">// constant [because composed of integer pointers alone]</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">argType</span><span class="o">-&gt;</span><span class="n">isIntOrIntVectorTy</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">argsInverted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">               </span><span class="n">whatType</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">BundleTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">BundleTypes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Both</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumParams</span><span class="p">())</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumParams</span><span class="p">())</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;number of arg operands != function parameters&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">argsInverted</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">             </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getFunctionType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumParams</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">replaceFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">foreignFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">replaceFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">legalCombinedForwardReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">replacedReturns</span><span class="p">,</span><span class="w"> </span><span class="n">postCreate</span><span class="p">,</span><span class="w"> </span><span class="n">userReplace</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">TR</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">unnecessaryInstructions</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">,</span><span class="w"> </span><span class="n">subretused</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replaceFunction</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">modifyPrimal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">augmentcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// llvm::Optional&lt;std::map&lt;std::pair&lt;Instruction*, std::string&gt;,</span>
<span class="w">    </span><span class="c1">// unsigned&gt;&gt; sub_index_map;</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tapeIdx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">returnIdx</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">differetIdx</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">modifyPrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*</span><span class="n">fnandtapetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ft</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"></span>
<span class="w">                                    </span><span class="o">?</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"></span>
<span class="w">                                    </span><span class="o">:</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefaultFunctionTypeForAugmentation</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="cm">/*returnUsed*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*subretType*/</span><span class="w"> </span><span class="n">subretType</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">fptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">second</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">ft</span><span class="o">-&gt;</span><span class="n">isVarArg</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">fptype</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">fptype</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">tapeIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">returnIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">differetIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">            </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">Logic</span><span class="p">.</span><span class="n">CreateAugmentedPrimal</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">),</span><span class="w"> </span><span class="n">subretType</span><span class="p">,</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">interprocedural</span><span class="p">,</span><span class="w"> </span><span class="cm">/*return is used*/</span><span class="w"> </span><span class="n">subretused</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">shadowReturnUsed</span><span class="p">,</span><span class="w"> </span><span class="n">nextTypeInfo</span><span class="p">,</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">AtomicAdd</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">augmentedReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">subaugmentations</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"></span>
<span class="w">                     </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">augmentedReturn</span><span class="o">-&gt;</span><span class="n">subaugmentations</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">insert_or_assign2</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">*</span><span class="n">subaugmentations</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">AugmentedReturn</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">subdata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">called</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">fnandtapetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">DifferentialReturn</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">differetIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Return</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">returnIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">tapeIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="c1">// sub_index_map = fnandtapetype.tapeIndices;</span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="c1">// llvm::errs() &lt;&lt; &quot;seeing sub_index_map of &quot; &lt;&lt; sub_index_map-&gt;size()</span>
<span class="w">      </span><span class="c1">// &lt;&lt; &quot; in ap &quot; &lt;&lt; cast&lt;Function&gt;(called)-&gt;getName() &lt;&lt; &quot;\n&quot;;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">          </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nl">badaugmentedfn</span><span class="p">:;</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">NC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; trying to call &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">NC</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; trying to call &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;args[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"></span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; FT:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;calling with wrong number of arguments&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getNumParams</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">badaugmentedfn</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pre_args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">pre_args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">badaugmentedfn</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="n">augmentcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">pre_args</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">augmentcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">pre_args</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">false</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">preByVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithByValType</span><span class="p">(</span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                                      </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">augmentcall</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_augmented&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">hasValue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="w">                     </span><span class="o">?</span><span class="w"> </span><span class="n">augmentcall</span><span class="w"></span>
<span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                           </span><span class="n">augmentcall</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()},</span><span class="w"></span>
<span class="w">                           </span><span class="s">&quot;subcache&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tape</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UndefValue</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">tt</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">TapesToPreventRecomputation</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tape</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">dcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">returnIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="o">?</span><span class="w"> </span><span class="n">augmentcall</span><span class="w"></span>
<span class="w">                      </span><span class="o">:</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">augmentcall</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">returnIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()});</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dcall</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">dcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">[</span><span class="n">dcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                  </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">[</span><span class="n">newCall</span><span class="p">];</span><span class="w"></span>
<span class="w">              </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">dcall</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">takeName</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">dcall</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">augmentcall</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">augmentcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subdata</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">AugmentedStruct</span><span class="o">::</span><span class="n">Tape</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">                           </span><span class="n">subdata</span><span class="o">-&gt;</span><span class="n">returns</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// assert(!tape);</span>
<span class="w">          </span><span class="c1">// assert(subdata);</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tape</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">hasValue</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="n">tapeIdx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">()</span><span class="w"></span>
<span class="w">                                </span><span class="o">:</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">())</span><span class="w"></span>
<span class="w">                                      </span><span class="o">-&gt;</span><span class="n">getElementType</span><span class="p">(</span><span class="n">tapeIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()),</span><span class="w"></span>
<span class="w">                </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tapeArg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Tape</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                              </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_tmpcacheB&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">cachereplace</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_replacementE&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">fictiousPHIs</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pn</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="c1">// TODO move right after newCall for the insertion point of BuilderZ</span>

<span class="w">          </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">subcheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                         </span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_NONEED</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">//! We only need the shadow pointer for non-forward Mode if it is used</span>
<span class="w">        </span><span class="c1">//! in a non return setting</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasNonReturnUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">ReturnInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                  </span><span class="n">use</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// || returnuses.find(cast&lt;Instruction&gt;(use)) ==</span>
<span class="w">                          </span><span class="c1">// returnuses.end()) {</span>
<span class="w">            </span><span class="n">hasNonReturnUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subcheck</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hasNonReturnUse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">              </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">differetIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="o">?</span><span class="w"> </span><span class="n">augmentcall</span><span class="w"></span>
<span class="w">                        </span><span class="o">:</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">augmentcall</span><span class="p">,</span><span class="w"> </span><span class="p">{(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">differetIdx</span><span class="p">.</span><span class="n">getValue</span><span class="p">()},</span><span class="w"></span>
<span class="w">                              </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;ac&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">newip</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">newip</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">placeholder</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>

<span class="w">          </span><span class="n">newip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Shadow</span><span class="p">));</span><span class="w"></span>

<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">newip</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">placeholder</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">SetInsertPoint</span><span class="p">(</span><span class="n">placeholder</span><span class="o">-&gt;</span><span class="n">getNextNode</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fnandtapetype</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fnandtapetype</span><span class="o">-&gt;</span><span class="n">tapeType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">           </span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ForwardModeSplit</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">shouldFree</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">tape</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">tapep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">fnandtapetype</span><span class="o">-&gt;</span><span class="n">tapeType</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">truetape</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">fnandtapetype</span><span class="o">-&gt;</span><span class="n">tapeType</span><span class="p">,</span><span class="w"> </span><span class="n">tapep</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tapeld&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">truetape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">tapep</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tapeld&quot;</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">truetape</span><span class="o">-&gt;</span><span class="n">setMetadata</span><span class="p">(</span><span class="s">&quot;enzyme_mustcache&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">MDNode</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">truetape</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="p">{}));</span><span class="w"></span>

<span class="w">        </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CallInst</span><span class="o">::</span><span class="n">CreateFree</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">        </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttributeAtIndex</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">        </span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">AttributeList</span><span class="o">::</span><span class="n">FirstArgIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">NonNull</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="n">tape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">truetape</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="cm">/*!topLevel*/</span><span class="w"> </span><span class="n">Mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="n">subretused</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">doesNotAccessMemory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_value_needed_in_reverse</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">::</span><span class="n">Primal</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">TR</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Mode</span><span class="p">,</span><span class="w"> </span><span class="n">oldUnreachable</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unnecessaryIntermediates</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">replaceFunction</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_cachereplace2&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">cacheForReverse</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">BuilderZ</span><span class="p">,</span><span class="w"> </span><span class="n">cachereplace</span><span class="p">,</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">CacheType</span><span class="o">::</span><span class="n">Self</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BuilderZ</span><span class="p">.</span><span class="n">CreatePHI</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_replacementC&quot;</span><span class="p">).</span><span class="n">str</span><span class="p">());</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">fictiousPHIs</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">cachereplace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pn</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">subretused</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">replaceFunction</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Note here down only contains the reverse bits</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModePrimal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">IRBuilder</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">Builder2</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">getReverseBuilder</span><span class="p">(</span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">DerivativeMode</span><span class="w"> </span><span class="n">subMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">replaceFunction</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">modifyPrimal</span><span class="p">)</span><span class="w"></span>
<span class="w">                                 </span><span class="o">?</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="w"></span>
<span class="w">                                 </span><span class="o">:</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeGradient</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">called</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">Logic</span><span class="p">.</span><span class="n">CreatePrimalAndGradient</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="n">ReverseCacheKey</span><span class="p">){.</span><span class="n">todiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">called</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">retType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subretType</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">constant_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argsInverted</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">uncacheable_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uncacheable_args</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">returnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replaceFunction</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">subretused</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">replaceFunction</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subMode</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getWidth</span><span class="p">(),</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">freeMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">AtomicAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">AtomicAdd</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">additionalType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tape</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">tape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="p">.</span><span class="n">typeInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextTypeInfo</span><span class="p">},</span><span class="w"></span>
<span class="w">          </span><span class="n">TR</span><span class="p">.</span><span class="n">analyzer</span><span class="p">.</span><span class="n">interprocedural</span><span class="p">,</span><span class="w"> </span><span class="n">subdata</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">newcalled</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">subMode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DerivativeMode</span><span class="o">::</span><span class="n">ReverseModeCombined</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 11</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledOperand</span><span class="p">();</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">callval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledValue</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">callval</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; orig: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; callval: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">callval</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">callval</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertPointerM</span><span class="p">(</span><span class="n">callval</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callval</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">      </span><span class="n">DIFFE_TYPE</span><span class="w"> </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"></span>
<span class="w">                                  </span><span class="o">?</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="w"></span>
<span class="w">                                  </span><span class="o">:</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">DUP_ARG</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isEmptyTy</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">subretType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">CONSTANT</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">getDefaultFunctionTypeForGradient</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="cm">/*subretType*/</span><span class="w"> </span><span class="n">subretType</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">// TODO Note there is empty tape added here, replace with generic</span>
<span class="w">      </span><span class="n">res</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt8PtrTy</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">fptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">FunctionType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">StructType</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">second</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">ft</span><span class="o">-&gt;</span><span class="n">isVarArg</span><span class="p">()));</span><span class="w"></span>
<span class="w">      </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">PointerType</span><span class="o">::</span><span class="n">getUnqual</span><span class="p">(</span><span class="n">fptype</span><span class="p">));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">      </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">fptype</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstGEP1_64</span><span class="p">(</span><span class="n">fptype</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">      </span><span class="n">newcalled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateConstGEP1_64</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">diffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tape</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ntape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">lookupM</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">ntape</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">ntape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ntape</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// if (auto NC = dyn_cast&lt;Function&gt;(newcalled)) {</span>
<span class="w">    </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPointerElementType</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nl">badfn</span><span class="p">:;</span><span class="w"></span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">NC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newcalled</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; trying to call &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">NC</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; trying to call &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">newcalled</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;args[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; FT:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;calling with wrong number of arguments&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getNumParams</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">badfn</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCalledFunction</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateBitCast</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">FT</span><span class="o">-&gt;</span><span class="n">getParamType</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">badfn</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt; 7</span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span><span class="w"> </span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">CallInst</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">newcalled</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getInvertedBundles</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">BundleTypes</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="cm">/*lookup*/</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setCallingConv</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getCallingConv</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()));</span><span class="w"></span>
<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 9</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">gradByVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">addParamAttr</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="o">::</span><span class="n">getWithByValType</span><span class="p">(</span><span class="w"></span>
<span class="w">                                           </span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">(),</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">structidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replaceFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">structidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadowReturnUsed</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">structidx</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if LLVM_VERSION_MAJOR &gt;= 14</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">arg_size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getNumArgOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argsInverted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">diffeadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffes</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">structidx</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="o">++</span><span class="n">structidx</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isSized</span><span class="p">())</span><span class="w"></span>
<span class="w">          </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getDataLayout</span><span class="p">().</span><span class="n">getTypeSizeInBits</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">               </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">              </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">addToDiffe</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">diffeadd</span><span class="p">,</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">TR</span><span class="p">.</span><span class="n">addingType</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getArgOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isVoidTy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">structidx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">oldFunc</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm</span><span class="o">::</span><span class="n">errs</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;diffes: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">diffes</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; structidx=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">structidx</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; subretused=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">subretused</span><span class="w"></span>
<span class="w">                     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; shadowReturnUsed=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">shadowReturnUsed</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">structidx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">StructType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">diffes</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">getNumElements</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">             </span><span class="n">structidx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIFFE_TYPE</span><span class="o">::</span><span class="n">OUT_DIFF</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">setDiffe</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">Constant</span><span class="o">::</span><span class="n">getNullValue</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replaceFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="c1">// if a function is replaced for joint forward/reverse, handle inverted</span>
<span class="w">      </span><span class="c1">// pointers</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">ifound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifound</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">ifound</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ifound</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shadowReturnUsed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">dumpMap</span><span class="p">(</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">auto</span><span class="w"> </span><span class="n">dretval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffes</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">subretused</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1U</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0U</span><span class="p">}));</span><span class="w"></span>
<span class="w">          </span><span class="cm">/* todo handle this case later */</span><span class="w"></span>
<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">subretused</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">invertedPointers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="n">InvertedPointerVH</span><span class="p">(</span><span class="n">gutils</span><span class="p">,</span><span class="w"> </span><span class="n">dretval</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="n">ValueToValueMapTy</span><span class="w"> </span><span class="n">mapp</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Builder2</span><span class="p">.</span><span class="n">CreateExtractValue</span><span class="p">(</span><span class="n">diffes</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">}));</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">replaceAWithB</span><span class="p">(</span><span class="n">newCall</span><span class="p">,</span><span class="w"> </span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="cm">/*storeInCache*/</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">mapp</span><span class="p">[</span><span class="n">newCall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">gutils</span><span class="w"></span>
<span class="w">                          </span><span class="o">-&gt;</span><span class="n">reverseBlocks</span><span class="p">[</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()))]</span><span class="w"></span>
<span class="w">                          </span><span class="p">.</span><span class="n">back</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mapp</span><span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">reverse</span><span class="p">(</span><span class="n">postCreate</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">postCreate</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">postCreate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If is the store to return handle manually since no original inst</span>
<span class="w">        </span><span class="c1">// for</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">fromStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">replacedReturns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">setOperand</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unwrapM</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">mapp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                               </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">moveBefore</span><span class="p">(</span><span class="o">*</span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"></span>
<span class="w">                          </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">fromStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fromStore</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">orig_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isOriginal</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orig_a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">setOperand</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">unwrapM</span><span class="p">(</span><span class="w"></span>
<span class="w">                              </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">getNewFromOriginal</span><span class="p">(</span><span class="n">orig_a</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="w"></span>
<span class="w">                              </span><span class="n">Builder2</span><span class="p">,</span><span class="w"> </span><span class="n">mapp</span><span class="p">,</span><span class="w"> </span><span class="n">UnwrapMode</span><span class="o">::</span><span class="n">LegalFullUnwrap</span><span class="p">));</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">moveBefore</span><span class="p">(</span><span class="o">*</span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertBlock</span><span class="p">(),</span><span class="w"> </span><span class="n">Builder2</span><span class="p">.</span><span class="n">GetInsertPoint</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">mapp</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffes</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">retval</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">diffes</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// llvm::errs() &lt;&lt; &quot;newFunc postrep: &quot; &lt;&lt; *gutils-&gt;newFunc &lt;&lt; &quot;\n&quot;;</span>

<span class="w">      </span><span class="n">erased</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cachereplace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subretused</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">dcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">cachereplace</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">dcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cachereplace</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">isConstantValue</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dcall</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">dcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isFPOrFPVectorTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">              </span><span class="n">TR</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">orig</span><span class="p">).</span><span class="n">Inner0</span><span class="p">().</span><span class="n">isPossiblePointer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">[</span><span class="n">dcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">[</span><span class="n">newCall</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">DiffeGradientUtils</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">gutils</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">differentials</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">dcall</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">newCall</span><span class="o">-&gt;</span><span class="n">replaceAllUsesWith</span><span class="p">(</span><span class="n">dcall</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dcall</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">takeName</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">eraseIfUnused</span><span class="p">(</span><span class="o">*</span><span class="n">orig</span><span class="p">,</span><span class="w"> </span><span class="cm">/*erase*/</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="cm">/*check*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">augmentcall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">originalToNewFn</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">augmentcall</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">newCall</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">gutils</span><span class="o">-&gt;</span><span class="n">newToOriginalFn</span><span class="p">[</span><span class="n">augmentcall</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright Enzyme.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/EnzymeAD/enzyme_sphinx_theme">theme</a> provided by <a href="https://enzyme.mit.edu">Enzyme</a>.
      </div>
      <br>
     

</footer>

          </div>
        </div>

        <div class="enzyme-content-right" id="enzyme-content-right">
          <div class="enzyme-right-menu" id="enzyme-right-menu">
            <div class="enzyme-side-scroll" id="enzyme-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Program Listing for File AdjointGenerator.h</a></li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
         <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
         <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <footer class="site-footer" id="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://enzyme.mit.edu" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://enzyme.mit.edu">Enzyme</a></li>
            <li><a href="https://enzyme.mit.edu/get-started">Get Started</a></li>
            <li><a href="https://enzyme.mit.edu/features">Features</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Resources</a></li>
            <li><a href="https://enzyme.mit.edu/tutorials">Tutorials</a></li>
            <li><a href="https://enzyme.mit.edu/docs/stable/index.html">Docs</a></li>
            <li><a href="" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/EnzymeAD/enzyme/issues" target="_blank">Github Issues</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://groups.google.com/d/forum/enzyme-dev"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://enzyme.mit.edu" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://enzyme.mit.edu/get-started">Get Started</a>
          </li>

          <li>
            <a href="">Ecosystem</a>
          </li>

          <li>
            <a href="">Mobile</a>
          </li>

          <li>
            <a href="">PyTorch Hub</a>
          </li>

          <li>
            <a href="">Blog</a>
          </li>

          <li>
            <a href="https://enzyme.mit.edu/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://enzyme.mit.edu/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="">torchaudio</a>
            </li>

            <li>
              <a href="">torchtext</a>
            </li>

            <li>
              <a href="">torchvision</a>
            </li>

            <li>
              <a href="">TorchElastic</a>
            </li>

            <li>
              <a href="">TorchServe</a>
            </li>

            <li>
              <a href="">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="">Developer Resources</a>
            </li>

            <li>
              <a href="https://enzyme.mit.edu/features">About</a>
            </li>

            <li>
              <a href="">Models (Beta)</a>
            </li>

            <li>
              <a href="">Community</a>
            </li>

            <li>
              <a href="">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/EnzymeAD/enzyme">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      enzymeAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.enzyme-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>